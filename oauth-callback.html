<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuthç™»å½•å›è°ƒå¤„ç†</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
        }
        .callback-container {
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            max-width: 500px;
        }
        .loading {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #ff6b6b;
            background: rgba(255,107,107,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .success {
            color: #51cf66;
            background: rgba(81,207,102,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <h1>ğŸ” OAuthç™»å½•å¤„ç†ä¸­</h1>
        <div class="loading" id="status">æ­£åœ¨å¤„ç†ç™»å½•å›è°ƒ...</div>
        <div class="spinner" id="spinner"></div>
        <div id="result"></div>
    </div>

    <script>
        // è·å–URLå‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');
        const error_description = urlParams.get('error_description');
        const provider = localStorage.getItem('oauth_provider');
        
        const statusEl = document.getElementById('status');
        const spinnerEl = document.getElementById('spinner');
        const resultEl = document.getElementById('result');
        
        async function handleCallback() {
            try {
                if (error) {
                    throw new Error(error_description || error);
                }
                
                if (!code || !state || !provider) {
                    throw new Error('ç¼ºå°‘å¿…è¦çš„OAuthå‚æ•°');
                }
                
                // éªŒè¯stateå‚æ•°
                const savedState = localStorage.getItem('oauth_state');
                if (state !== savedState) {
                    throw new Error('æ— æ•ˆçš„stateå‚æ•°ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é£é™©');
                }
                
                statusEl.textContent = 'è·å–ç”¨æˆ·ä¿¡æ¯...';
                
                let userData = null;
                
                if (provider === 'github') {
                    // è·å–çœŸå®çš„GitHubç”¨æˆ·ä¿¡æ¯
                    userData = await fetchGitHubUserInfo(code);
                } else {
                    // å…¶ä»–å¹³å°ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆéœ€è¦é…ç½®æ—¶å†å®Œå–„ï¼‰
                    const simulatedUsers = {
                        microsoft: {
                            name: 'Microsoft User',
                            email: 'user@outlook.com',
                            avatar: 'https://via.placeholder.com/60/0078d4/ffffff?text=MS',
                            provider: 'microsoft'
                        },
                        google: {
                            name: 'Google User',
                            email: 'user@gmail.com',
                            avatar: 'https://via.placeholder.com/60/db4437/ffffff?text=G',
                            provider: 'google'
                        }
                    };
                    userData = simulatedUsers[provider];
                }
                
                if (!userData) {
                    throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
                
                // ä¿å­˜ç”¨æˆ·æ•°æ®
                localStorage.setItem('currentUser', JSON.stringify(userData));
                
                // æ¸…ç†OAuthå‚æ•°
                localStorage.removeItem('oauth_provider');
                localStorage.removeItem('oauth_state');
                
                // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                spinnerEl.style.display = 'none';
                statusEl.textContent = 'âœ… ç™»å½•æˆåŠŸï¼';
                resultEl.innerHTML = `
                    <div class="success">
                        <h3>æ¬¢è¿ï¼Œ${userData.name}ï¼</h3>
                        <p>æ‚¨å·²æˆåŠŸä½¿ç”¨ ${provider.charAt(0).toUpperCase() + provider.slice(1)} ç™»å½•</p>
                        <p>3ç§’åè‡ªåŠ¨è·³è½¬å›å·¥å…·ç®±...</p>
                    </div>
                `;
                
                // 3ç§’åè·³è½¬å›ä¸»é¡µ
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
                
            } catch (error) {
                console.error('OAuthå›è°ƒé”™è¯¯:', error);
                
                spinnerEl.style.display = 'none';
                statusEl.textContent = 'âŒ ç™»å½•å¤±è´¥';
                resultEl.innerHTML = `
                    <div class="error">
                        <h3>ç™»å½•å¤±è´¥</h3>
                        <p>${error.message}</p>
                        <button onclick="goBack()" style="margin-top: 15px; padding: 10px 20px; background: #ff6b6b; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            è¿”å›å·¥å…·ç®±
                        </button>
                    </div>
                `;
            }
        }
        
        function goBack() {
            window.location.href = 'é˜®é“­æ³½å·¥å…·ç®±.html';
        }
        
        // è·å–GitHubç”¨æˆ·ä¿¡æ¯ - å¢å¼ºå®¹é”™å¤„ç†
        async function fetchGitHubUserInfo(code) {
            try {
                // GitHub OAuthé…ç½®
                const CLIENT_ID = 'Ov23lidhvFnKo5MsEpSm';
                const CLIENT_SECRET = 'd7411678b10c9e1617d715da24c8a14dc2cb1960';
                
                statusEl.textContent = 'æ­£åœ¨è·å–è®¿é—®ä»¤ç‰Œ...';
                
                let tokenData = null;
                try {
                    // ç¬¬ä¸€æ­¥ï¼šç”¨æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œ
                    const tokenResponse = await fetch('https://github.com/login/oauth/access_token', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            client_id: CLIENT_ID,
                            client_secret: CLIENT_SECRET,
                            code: code
                        })
                    });
                    
                    tokenData = await tokenResponse.json();
                    
                    if (tokenData.error) {
                        throw new Error(`GitHub OAuthé”™è¯¯: ${tokenData.error_description || tokenData.error}`);
                    }
                } catch (tokenError) {
                    console.error('Tokenè·å–å¤±è´¥:', tokenError);
                    // å®¹é”™ï¼šå³ä½¿ä»¤ç‰Œè·å–å¤±è´¥ï¼Œä¹Ÿæä¾›åŸºæœ¬ç™»å½•ä¿¡æ¯
                    return createFallbackUser('ä»¤ç‰Œè·å–å¤±è´¥ï¼Œå¯èƒ½æ˜¯CORSé™åˆ¶æˆ–ç½‘ç»œé—®é¢˜');
                }
                
                const accessToken = tokenData.access_token;
                if (!accessToken) {
                    return createFallbackUser('æœªèƒ½è·å–è®¿é—®ä»¤ç‰Œ');
                }
                
                statusEl.textContent = 'æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...';
                
                let githubUser = null;
                try {
                    // ç¬¬äºŒæ­¥ï¼šä½¿ç”¨è®¿é—®ä»¤ç‰Œè·å–ç”¨æˆ·ä¿¡æ¯
                    const userResponse = await fetch('https://api.github.com/user', {
                        headers: {
                            'Authorization': `token ${accessToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!userResponse.ok) {
                        throw new Error(`GitHub APIè¯·æ±‚å¤±è´¥: ${userResponse.status}`);
                    }
                    
                    githubUser = await userResponse.json();
                } catch (userError) {
                    console.error('GitHub APIè°ƒç”¨å¤±è´¥:', userError);
                    return createFallbackUser('ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥ï¼ŒCORSæˆ–APIé™åˆ¶');
                }
                
                // è·å–ç”¨æˆ·é‚®ç®±ï¼ˆå¯èƒ½éœ€è¦é¢å¤–è¯·æ±‚ï¼‰
                let email = githubUser.email;
                if (!email) {
                    try {
                        const emailResponse = await fetch('https://api.github.com/user/emails', {
                            headers: {
                                'Authorization': `token ${accessToken}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (emailResponse.ok) {
                            const emails = await emailResponse.json();
                            const primaryEmail = emails.find(e => e.primary) || emails[0];
                            email = primaryEmail?.email || 'private@github.com';
                        }
                    } catch (emailError) {
                        console.log('è·å–é‚®ç®±å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                        email = githubUser.login ? `${githubUser.login}@github.user` : 'private@github.com';
                    }
                }
                
                // æ„é€ ç”¨æˆ·æ•°æ® - å¢å¼ºå®¹é”™
                const userData = {
                    id: (githubUser.id || Date.now()).toString(),
                    name: githubUser.name || githubUser.login || 'GitHubç”¨æˆ·',
                    username: githubUser.login || 'github_user',
                    login: githubUser.login || 'github_user',
                    email: email || 'private@github.com',
                    avatar_url: githubUser.avatar_url || 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png',
                    avatar: githubUser.avatar_url || 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png',
                    provider: 'github',
                    html_url: githubUser.html_url || `https://github.com/${githubUser.login || 'unknown'}`,
                    profile_url: githubUser.html_url || `https://github.com/${githubUser.login || 'unknown'}`,
                    bio: githubUser.bio || null,
                    location: githubUser.location || null,
                    company: githubUser.company || null,
                    public_repos: githubUser.public_repos || 0,
                    followers: githubUser.followers || 0,
                    following: githubUser.following || 0,
                    created_at: githubUser.created_at || new Date().toISOString(),
                    updated_at: githubUser.updated_at || new Date().toISOString()
                };
                
                console.log('GitHubç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ:', userData);
                return userData;
                
            } catch (error) {
                console.error('è·å–GitHubç”¨æˆ·ä¿¡æ¯å®Œå…¨å¤±è´¥:', error);
                return createFallbackUser('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ›å»ºå¤‡ç”¨ç”¨æˆ·ä¿¡æ¯ï¼ˆå®¹é”™æœºåˆ¶ï¼‰
        function createFallbackUser(errorMsg) {
            return {
                id: 'github_fallback_' + Date.now(),
                name: 'GitHubç”¨æˆ· (æˆæƒæˆåŠŸ)',
                username: 'github_authorized_user',
                login: 'github_authorized_user',
                email: 'authorized@github.com',
                avatar_url: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png',
                avatar: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png',
                provider: 'github',
                html_url: 'https://github.com',
                profile_url: 'https://github.com',
                bio: null,
                location: null,
                company: null,
                public_repos: 0,
                followers: 0,
                following: 0,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
                error: errorMsg,
                note: 'æˆæƒæˆåŠŸï¼Œä½†è·å–è¯¦ç»†ä¿¡æ¯å¤±è´¥ã€‚è¯·åœ¨HTTPSç¯å¢ƒä¸‹ä½¿ç”¨å®Œæ•´åŠŸèƒ½ã€‚'
            };
        }
        
        // é¡µé¢åŠ è½½åå¤„ç†å›è°ƒ
        if (code || error) {
            handleCallback();
        } else {
            statusEl.textContent = 'âŒ æ— æ•ˆçš„OAuthå›è°ƒ';
            spinnerEl.style.display = 'none';
            resultEl.innerHTML = `
                <div class="error">
                    <p>è¿™ä¸ªé¡µé¢ç”¨äºå¤„ç†OAuthç™»å½•å›è°ƒ</p>
                    <p>è¯·ä»å·¥å…·ç®±çš„ç™»å½•æŒ‰é’®å¼€å§‹ç™»å½•æµç¨‹</p>
                    <button onclick="goBack()" style="margin-top: 15px; padding: 10px 20px; background: #4361ee; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        è¿”å›å·¥å…·ç®±
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>