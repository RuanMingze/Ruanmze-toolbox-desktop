<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阮铭泽工具箱 - 多功能在线工具集合</title>
    <meta name="description" content="阮铭泽工具箱是一个集成多种实用功能的在线工具平台，包含天气查询、计算器、编程工具、系统知识等实用功能。">
    <meta name="keywords" content="工具箱,在线工具,天气查询,计算器,编程工具,实用工具">
    <meta name="author" content="阮铭泽">
    <link rel="icon" type="image/jpeg" href="icon.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --light-bg: #f5f7fa;
            --dark-bg: #121220;
            --card-bg: #ffffff;
            --text-dark: #2b2d42;
            --text-light: #f8f9fa;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --radius: 16px;
            --header-height: 80px;
            --icon-size: 24px;
            --blur-strength: 10px;
            --window-controls-height: 32px; /* 添加窗口控制栏高度 */
        }
        
        /* 自定义滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(67, 97, 238, 0.3);
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(94, 114, 228, 0.5);
        }
        
        /* 开关样式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* 自定义窗口控制按钮样式 */
        .window-controls {
            position: relative;
            display: flex;
            align-items: center;
            height: var(--window-controls-height);
            z-index: 2000;
            background: transparent;
            margin-left: 10px;
        }
        
        .window-control-btn {
            width: 46px;
            height: 46px;
            border: none;
            background: rgba(0, 0, 0, 0.05);
            color: #555;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            outline: none;
            border-radius: 8px;
            margin: 0 2px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .window-control-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }
        
        .window-control-btn.close {
            background: rgba(255, 95, 87, 0.15);
        }
        
        .window-control-btn.close:hover {
            background: #ff5f57;
            color: white;
        }
        
        .window-control-btn.maximize {
            background: rgba(40, 201, 64, 0.15);
        }
        
        .window-control-btn.maximize:hover {
            background: #28c940;
            color: white;
        }
        
        .window-control-btn.minimize {
            background: rgba(255, 189, 46, 0.15);
        }
        
        .window-control-btn.minimize:hover {
            background: #ffbd2e;
            color: white;
        }
        
        /* 深色模式下的窗口控制按钮 */
        .dark-mode .window-controls {
            background: transparent;
        }
        
        .dark-mode .window-control-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .dark-mode .window-control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .dark-mode .window-control-btn.close {
            background: rgba(255, 95, 87, 0.25);
        }
        
        .dark-mode .window-control-btn.maximize {
            background: rgba(40, 201, 64, 0.25);
        }
        
        .dark-mode .window-control-btn.minimize {
            background: rgba(255, 189, 46, 0.25);
        }
        
        /* 调整页面内容的顶部边距 */
        body {
            padding-top: calc(var(--window-controls-height) + var(--header-height));
        }
        
        /* 深色模式增强对比度 */
        .dark-mode {
            --primary-color: #5e72e4;
            --dark-bg: #121220;
            --light-bg: #1a1a2e;
            --card-bg: #252540;
            --text-dark: #f0f2f5;
        }
        
        /* 深色模式增强对比度 */
        .dark-mode .card {
            background: #2a2a4a;
            border: 1px solid rgba(94,114,228,0.1);
        }
        
        .dark-mode .card-title {
            color: #7c8cfa;
            border-bottom-color: rgba(124,140,250,0.2);
        }
        
        .dark-mode .weather-item,
        .dark-mode .tool-card,
        .dark-mode .search-panel,
        .dark-mode .resource-card {
            background: rgba(94,114,228,0.15);
            border: 1px solid rgba(94,114,228,0.1);
        }
        
        /* 深色模式下AI聊天区域样式 */
        .dark-mode .chat-history {
            background: rgba(94,114,228,0.1) !important;
        }
        
        .dark-mode .message .content {
            background: #2a2a4a !important;
            color: #f0f2f5 !important;
        }
        
        .dark-mode .message.ai-message .content {
            background: rgba(94,114,228,0.2) !important;
            color: #f0f2f5 !important;
        }
        
        .dark-mode .chat-input-area textarea {
            background: #2a2a4a !important;
            border-color: rgba(94,114,228,0.3) !important;
            color: #f0f2f5 !important;
        }
        
        .dark-mode .weather-item:hover,
        .dark-mode .tool-card:hover,
        .dark-mode .resource-card:hover {
            background: rgba(94,114,228,0.25);
            border-color: rgba(94,114,228,0.2);
        }
        
        .dark-mode .city-selector,
        .dark-mode .search-input,
        .dark-mode .setting-select,
        .dark-mode .calc-display {
            background: #2a2a4a;
            border-color: rgba(94,114,228,0.3);
            color: #f0f2f5;
        }
        
        .dark-mode .nav-btn {
            background: rgba(94,114,228,0.2);
            color: #f0f2f5;
        }
        
        .dark-mode .nav-btn:hover {
            background: #5e72e4;
            color: white;
        }
        
        body {
            background-color: var(--light-bg);
            min-height: 100vh;
            transition: all 0.3s;
            padding-top: calc(var(--window-controls-height) + var(--header-height));
            color: #333;
        }
        
        body.dark-mode {
            color: #f0f2f5;
        }
        
        /* 头部工具栏 */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: calc(var(--window-controls-height) + var(--header-height));
            background-color: var(--card-bg);
            box-shadow: var(--shadow);
            z-index: 1000;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            will-change: transform;
        }
        
        .tabs {
            position: relative;
            display: flex;
            height: 100%;
            padding: 0;
            gap: 5px;
            align-items: center;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            justify-content: center;
        }
        
        .tab-btn {
            height: 100%;
            padding: 0 22px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            color: #555;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            position: relative;
            min-width: 60px;
            text-align: center;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        
        .tab-btn span {
            display: block;
            line-height: 1.2;
        }
        
        .tab-btn i {
            font-size: var(--icon-size);
            margin-bottom: 8px;
            transition: all 0.3s;
            height: var(--icon-size);
            display: flex;
            align-items: center;
            justify-content: center;
            width: var(--icon-size);
            flex-shrink: 0;
        }
        
        .tab-btn.active {
            color: var(--primary-color);
        }
        
        .tab-btn.active::after {
            display: none;
        }
        
        /* 深色模式下的模态框样式 */
        .dark-mode #addWebsiteModal #websiteForm {
            background: #252540;
            color: #f0f2f5;
        }
        
        .dark-mode #addWebsiteModal input {
            background: #2a2a4a;
            border-color: rgba(94,114,228,0.3);
            color: #f0f2f5;
        }
        
        .dark-mode #addWebsiteModal label {
            color: #f0f2f5;
        }
        
        .dark-mode #addWebsiteModal #cancelAddWebsite {
            background: #3a3a5a;
            color: #f0f2f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* 卡片通用样式 */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--primary-color);
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(67,97,238,0.1);
        }
        
        .card-title i {
            font-size: 1.6rem;
        }
        
        .card-row {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .calendar-card {
            flex: 1;
            min-width: 320px;
        }
        
        .weather-card {
            flex: 1;
            min-width: 280px;
        }
        
        /* 选择器样式 */
        .city-selector {
            padding: 12px 20px;
            border-radius: 30px;
            border: 2px solid var(--primary-color);
            background: transparent;
            color: inherit;
            font-size: 1rem;
            margin-bottom: 20px;
            width: 100%;
        }
        /* 天气卡片样式 */
        .weather-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 18px;
        }
        
        .weather-item {
            padding: 20px 15px;
            border-radius: 15px;
            background: rgba(67,97,238,0.08);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .temp {
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
            margin: 10px 0;
        }
        
        .weather-icon {
            font-size: 3.5rem;
            color: #ffc107;
            margin: 10px 0;
            filter: drop-shadow(0 0 5px rgba(255, 193, 7, 0.3));
        }
        
        .weather-label {
            font-size: 1rem;
            margin-bottom: 6px;
            opacity: 0.8;
        }
        
        .weather-value {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        /* 日历组件 */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(67,97,238,0.1);
        }
        
        .calendar-nav {
            display: flex;
            gap: 12px;
        }
        
        .nav-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: none;
            background: rgba(67,97,238,0.1);
            color: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 1.2rem;
        }
        
        .nav-btn:hover {
            background: var(--primary-color);
            color: white;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            text-align: center;
        }
        
        .calendar-weekday {
            font-weight: 600;
            padding: 12px 0;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .calendar-day {
            padding: 15px 0;
            border-radius: 12px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .calendar-day:hover {
            background: rgba(67,97,238,0.15);
        }
        
        .calendar-day.today {
            background: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        
        .calendar-day.today::after {
            content: '今日';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.6rem;
            background: #ff6b6b;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
        }
        
        .calendar-day.event::before {
            content: '';
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #f7e81a; /* 改为黄色 */
        }
        
        /* 节日提示样式 */
        .calendar-day.festival::after {
            content: attr(data-festival);
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            display: none;
            pointer-events: none;
        }
        
        .calendar-day.festival:hover::after {
            display: block;
        }
        
        /* 确保节日提示框在毛玻璃效果下正确显示 */
        .blur-element .calendar-day.festival::after {
            z-index: 1000 !important;
            position: absolute !important;
        }
        
        /* 编程工具 */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .tool-card {
            padding: 25px;
            border-radius: 15px;
            background: rgba(67,97,238,0.08);
            text-align: center;
            transition: all 0.3s;
        }
        .tool-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .tool-icon {
            font-size: 2.8rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tool-title {
            font-size: 1.3rem;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .tool-desc {
            font-size: 0.95rem;
            opacity: 0.85;
            margin-bottom: 20px;
            min-height: 60px;
        }
        
        /* 按钮通用样式优化 */
        .tool-link {
            display: inline-block;
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border-radius: 30px;
            text-decoration: none;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            outline: none;
            box-shadow: 0 2px 8px rgba(67,97,238,0.2);
        }
        
        .tool-link:hover {
            background: #304fd1;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(67,97,238,0.3);
        }
        
        .tool-link:focus {
            outline: 2px solid rgba(67,97,238,0.5);
            outline-offset: 2px;
        }
        
        .tool-link:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* 深色模式按钮优化 */
        .dark-mode .tool-link {
            background: #5e72e4;
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(94,114,228,0.3);
        }
        
        .dark-mode .tool-link:hover {
            background: #4c63d2;
            box-shadow: 0 4px 12px rgba(94,114,228,0.4);
        }
        
        /* 系统知识面板 */
        .knowledge-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        @media (max-width: 900px) {
            .knowledge-container {
                grid-template-columns: 1fr;
            }
        }
        
        .search-panel {
            padding: 25px;
            border-radius: 15px;
            background: rgba(67,97,238,0.08);
        }
        
        .search-form {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }
        .search-input {
            flex: 1;
            padding: 14px 20px;
            border-radius: 30px;
            border: 1px solid rgba(67,97,238,0.3);
            background: transparent;
            color: inherit;
            font-size: 1rem;
        }
        
        /* 系统知识折叠样式 */
        .knowledge-item {
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            background: rgba(67,97,238,0.05);
            transition: all 0.3s;
        }
        
        .knowledge-item:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .knowledge-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-weight: 600;
            color: var(--primary-color);
            background: rgba(67,97,238,0.1);
            transition: background 0.3s;
        }
        
        .knowledge-header:hover {
            background: rgba(67,97,238,0.15);
        }
        
        .toggle-icon {
            margin-right: 10px;
            transition: transform 0.3s;
        }
        
        .knowledge-content {
            padding: 0 20px;
            background: white;
        }
        
        .knowledge-detail {
            padding: 15px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .knowledge-detail:last-child {
            border-bottom: none;
        }
        
        .knowledge-detail h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .knowledge-detail p {
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        /* 深色模式下的知识内容样式 */
        .dark-mode .knowledge-item {
            background: rgba(94,114,228,0.1);
        }
        
        .dark-mode .knowledge-header {
            background: rgba(94,114,228,0.2);
            color: #7c8cfa;
        }
        
        .dark-mode .knowledge-header:hover {
            background: rgba(94,114,228,0.3);
        }
        
        .dark-mode .knowledge-content {
            background: #2a2a4a;
        }
        
        .dark-mode .knowledge-detail {
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .search-btn {
            padding: 14px 25px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .search-btn:hover {
            background: #304fd1;
        }
        
        .results-container {
            min-height: 220px;
            padding: 20px;
            background: rgba(0,0,0,0.03);
            border-radius: 12px;
        }
        
        .result-item {
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.05);
        }
        
        .result-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        /* 资源网格 - 增强版本 */
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            align-items: stretch;
        }
        
        .resource-card {
            padding: 20px;
            border-radius: 12px;
            background: rgba(67,97,238,0.08);
            text-align: center;
            transition: all 0.3s;
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 120px;
            position: relative;
            overflow: hidden;
        }
        
        .resource-card:hover {
            background: rgba(67,97,238,0.15);
            transform: translateY(-5px);
        }
        
        .resource-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .resource-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
            line-height: 1.3;
            text-align: center;
        }
        
        /* 网站推荐卡片特殊样式 */
        #websiteList {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
            align-items: stretch;
        }
        
        #websiteList .resource-card {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            text-align: left;
            padding: 18px 22px;
            min-height: 100px;
            gap: 18px;
        }
        
        #websiteList .resource-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(255,255,255,0.9);
            margin-bottom: 0;
            flex-shrink: 0;
        }
        
        #websiteList .resource-icon img {
            width: 44px;
            height: 44px;
            object-fit: contain;
        }
        
        #websiteList .website-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 6px;
            min-width: 0;
        }
        
        #websiteList .resource-name {
            font-size: 1.15rem;
            font-weight: 600;
            margin-bottom: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #websiteList .website-desc {
            font-size: 0.95rem;
            opacity: 0.85;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        #websiteList .delete-btn {
            position: absolute;
            top: 8px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        #websiteList .resource-card:hover .delete-btn {
            opacity: 1;
        }
        /* 彩蛋效果优化 - 减少30%强度，保持颜色变化和抽搐 */
        @keyframes crazy {
            0% { transform: rotate(0) scale(1); filter: hue-rotate(0) blur(0) brightness(1); }
            10% { transform: rotate(12deg) scale(1.2); filter: hue-rotate(72deg) blur(1px) brightness(1.3); }
            20% { transform: rotate(-12deg) scale(1.4); filter: hue-rotate(144deg) blur(1px) brightness(0.7); }
            30% { transform: rotate(25deg) scale(1.6); filter: hue-rotate(216deg) blur(2px) brightness(1.4); }
            40% { transform: rotate(-25deg) scale(1.8) skew(10deg, 8deg); filter: hue-rotate(288deg) blur(2px) brightness(0.6); }
            50% { transform: rotate(38deg) scale(2.0) skew(-15deg, -12deg); filter: hue-rotate(360deg) blur(3px) brightness(1.5); }
            60% { transform: rotate(-38deg) scale(1.8) skew(12deg, 10deg); filter: hue-rotate(432deg) blur(2px) brightness(0.8); }
            70% { transform: rotate(25deg) scale(1.6) skew(-10deg, -8deg); filter: hue-rotate(504deg) blur(2px) brightness(1.2); }
            80% { transform: rotate(-25deg) scale(1.4); filter: hue-rotate(576deg) blur(1px) brightness(0.9); }
            90% { transform: rotate(12deg) scale(1.2); filter: hue-rotate(648deg) blur(1px) brightness(1.1); }
            100% { transform: rotate(0) scale(1); filter: hue-rotate(720deg) blur(0) brightness(1); }
        }
        
        @keyframes crazyShake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-3px, 2px) rotate(1deg); }
            20% { transform: translate(3px, -2px) rotate(-1deg); }
            30% { transform: translate(-2px, -3px) rotate(1deg); }
            40% { transform: translate(2px, 3px) rotate(-1deg); }
            50% { transform: translate(-3px, -2px) rotate(1deg); }
            60% { transform: translate(3px, 2px) rotate(-1deg); }
            70% { transform: translate(-2px, 3px) rotate(1deg); }
            80% { transform: translate(2px, -2px) rotate(-1deg); }
            90% { transform: translate(-1px, 1px) rotate(0.5deg); }
        }
        
        @keyframes crazyColors {
            0% { background: linear-gradient(45deg, #ff6b6b, #4ecdc4); }
            14% { background: linear-gradient(90deg, #ff9ff3, #54a0ff); }
            28% { background: linear-gradient(135deg, #ee5a24, #009432); }
            42% { background: linear-gradient(180deg, #fd79a8, #fdcb6e); }
            56% { background: linear-gradient(225deg, #fd7272, #e17055); }
            70% { background: linear-gradient(270deg, #00cec9, #6c5ce7); }
            84% { background: linear-gradient(315deg, #ff7675, #74b9ff); }
            100% { background: linear-gradient(360deg, #a29bfe, #fd79a8); }
        }
        
        .crazy-mode {
            animation: crazy 2s infinite linear !important;
        }
        
        .crazy-mode body {
            animation: crazyColors 2s infinite linear, crazyShake 0.1s infinite linear !important;
        }
        
        .crazy-mode .tool-link,
        .crazy-mode .nav-btn,
        .crazy-mode .search-btn,
        .crazy-mode .tab-btn.active,
        .crazy-mode .calc-key {
            animation: crazy 1s infinite linear !important;
        }
        
        .crazy-mode .card {
            animation: crazy 1.5s infinite linear, crazyShake 0.15s infinite linear !important;
        }
        
        .crazy-mode .card-title {
            animation: crazy 1.2s infinite linear !important;
            text-shadow: 0 0 10px rgba(255,0,255,0.6), 0 0 20px rgba(0,255,255,0.4) !important;
        }
        
        .crazy-mode .weather-icon {
            animation: crazy 0.8s infinite linear !important;
            filter: drop-shadow(0 0 10px #ff00ff) drop-shadow(0 0 20px #00ffff) !important;
        }
        
        /* 工具按钮 */
        .easter-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 0 auto;
            transition: all 0.3s;
            width: 100%;
            max-width: 300px;
        }
        
        .easter-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        /* 设置区域 */
        .settings-container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .setting-option {
            margin-bottom: 30px;
        }
        
        .setting-label {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .setting-label i {
            font-size: 1.8rem;
            color: var(--primary-color);
        }
        
        .select-box {
            padding: 15px;
            border-radius: 15px;
            background: rgba(67,97,238,0.08);
        }
        .setting-select {
            width: 100%;
            padding: 12px 20px;
            border-radius: 50px;
            border: 1px solid rgba(67,97,238,0.3);
            background: transparent;
            color: inherit;
            font-size: 1rem;
        }
        
        /* 页脚 */
        .footer {
            text-align: center;
            padding: 30px;
            color: #777;
            font-size: 0.9rem;
        }
        
        /* 图标样式 */
        .icon-display {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }
        
        .app-icon {
            width: 100px;
            height: 100px;
            border-radius: 24px;
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .app-icon i {
            font-size: 60px;
            color: white;
        }
        
        /* 计算器美化增强 */
.calculator {
    background: var(--card-bg);
    border-radius: 24px;
    box-shadow: 0 6px 24px rgba(67,97,238,0.12);
    padding: 30px 25px 25px 25px;
    margin-bottom: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: box-shadow 0.3s;
}
.calculator:hover {
    box-shadow: 0 12px 32px rgba(67,97,238,0.18);
}
.calc-display {
    width: 100%;
    font-size: 2.2rem;
    font-weight: 600;
    background: rgba(67,97,238,0.07);
    border: none;
    border-radius: 16px;
    padding: 18px 20px;
    margin-bottom: 18px;
    text-align: right;
    color: var(--primary-color);
    box-shadow: 0 2px 8px rgba(67,97,238,0.08);
}
.calc-keys {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
    width: 100%;
}
.calc-key {
    padding: 18px 0;
    font-size: 1.3rem;
    font-weight: 500;
    border: none;
    border-radius: 14px;
    background: linear-gradient(135deg, #eaf2fb, #dbeafe);
    color: var(--primary-color);
    box-shadow: 0 2px 8px rgba(67,97,238,0.07);
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
}
.calc-key.operator {
    background: linear-gradient(135deg, #4361ee, #3a0ca3);
    color: #fff;
}
.calc-key.equal {
    background: linear-gradient(135deg, #ff6b6b, #ff8e53);
    color: #fff;
    font-weight: bold;
}
.calc-key:hover {
    background: #b3d1f3;
    transform: scale(1.08);
}    
        /* 登录按钮样式 */
        .login-btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            outline: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .microsoft-btn {
            background: linear-gradient(135deg, #0078d4, #106ebe);
        }
        
        .microsoft-btn:hover {
            background: linear-gradient(135deg, #106ebe, #005a9e);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,120,212,0.3);
        }
        
        .google-btn {
            background: linear-gradient(135deg, #db4437, #c23321);
        }
        
        .google-btn:hover {
            background: linear-gradient(135deg, #c23321, #a52714);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(219,68,55,0.3);
        }
        
        .github-btn {
            background: linear-gradient(135deg, #333, #24292e);
        }
        
        .github-btn:hover {
            background: linear-gradient(135deg, #24292e, #1b1f23);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(51,51,51,0.3);
        }
        
        /* 深色模式登录按钮 */
        .dark-mode .login-btn {
            box-shadow: 0 2px 8px rgba(255,255,255,0.1);
        }
        
        .dark-mode .microsoft-btn:hover {
            box-shadow: 0 4px 12px rgba(0,120,212,0.4);
        }
        
        .dark-mode .google-btn:hover {
            box-shadow: 0 4px 12px rgba(219,68,55,0.4);
        }
        
        .dark-mode .github-btn:hover {
            box-shadow: 0 4px 12px rgba(255,255,255,0.2);
        }

        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .card-row {
                flex-direction: column;
            }
            
            .tab-btn {
                padding: 0 15px;
            }
        }
    </style>
</head>
<body>
    <!-- 头部工具栏 -->
    <header id="mainHeader">
        <nav>
            <div style="display: flex; justify-content: space-between; align-items: center; height: 100%; padding: 0 20px;">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="display: flex; align-items: center;">
                        <img src="icon.jpg" alt="网站图标" style="width: 56px; height: 56px; border-radius: 16px; margin-right: 15px; flex-shrink: 0; object-fit: cover;">
                        <div style="font-weight: 700; font-size: 1.25rem; color: #4361ee; letter-spacing: 1px;">阮铭泽工具箱</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <button class="tab-btn active" data-tab="home">
                            <i class="fas fa-home"></i>
                            <span data-lang="主页">主页</span>
                        </button>
                        <button class="tab-btn" data-tab="programming">
                            <i class="fas fa-code"></i>
                            <span data-lang="编程工具">编程工具</span>
                        </button>
                        <button class="tab-btn" data-tab="knowledge">
                            <i class="fas fa-book"></i>
                            <span data-lang="系统知识">系统知识</span>
                        </button>
                        <button class="tab-btn" data-tab="tools">
                            <i class="fas fa-tools"></i>
                            <span data-lang="实用工具">实用工具</span>
                        </button>
                        <button class="tab-btn" data-tab="reverse">
                            <i class="fas fa-search"></i>
                            <span data-lang="软件逆向">软件逆向</span>
                        </button>
                        <button class="tab-btn" data-tab="ai-chat">
                            <i class="fas fa-robot"></i>
                            <span data-lang="AI聊天">AI聊天</span>
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 10px;">
                    <!-- 右侧设置按钮 -->
                    <button class="tab-btn" id="settingsBtn">
                        <i class="fas fa-cog"></i>
                        <span data-lang="设置">设置</span>
                    </button>
                    
                    <!-- 自定义窗口控制按钮 -->
                    <div class="window-controls">
                        <button class="window-control-btn minimize" id="minimize-btn">
                            <i class="fas fa-window-minimize"></i>
                        </button>
                        <button class="window-control-btn maximize" id="maximize-btn">
                            <i class="fas fa-window-maximize"></i>
                        </button>
                        <button class="window-control-btn close" id="close-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        <!-- 主页 -->
        <div id="home" class="tab-content active">
            
            <!-- 时钟显示区域 -->
            <div style="text-align: center; margin-bottom: 30px; padding: 30px; background: rgba(67,97,238,0.1); border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div id="mainClock" style="font-size: 4.5rem; font-weight: 800; color: #4361ee; letter-spacing: 3px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                    00:00
                </div>
                <div id="clockDate" style="font-size: 1.5rem; margin-top: 15px; opacity: 0.9; font-weight: 600;">
                    2025年1月1日 星期三
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-sun"></i>
                    <span data-lang="天气预报">天气预报</span>
                </div>
                
                <div class="card-row">
                    <div class="weather-card">
                        <div style="text-align: center; margin-bottom: 20px; padding: 12px; background: rgba(67,97,238,0.08); border-radius: 15px;">
                            <span style="font-size: 1.1rem; font-weight: 600; color: var(--primary-color);" data-lang="当前城市">当前城市：</span><span id="currentCityDisplay">北京</span>
                            <p style="margin: 8px 0 0 0; font-size: 0.9rem; opacity: 0.8;">在设置中可更换城市</p>
                        </div>
                        <div class="weather-info">
                            <div class="weather-item">
                                <div class="weather-label">当前温度</div>
                                <div class="temp">28°C</div>
                                <i class="fas fa-sun weather-icon"></i>
                                <div class="weather-value">晴天</div>
                            </div>
                            
                            <div class="weather-item">
                                <div class="weather-label">体感温度</div>
                                <div class="temp">30°C</div>
                                <div class="weather-value">较热</div>
                            </div>
                            
                            <div class="weather-item">
                                <div class="weather-label">湿度</div>
                                <div class="temp">65%</div>
                                <i class="fas fa-tint weather-icon"></i>
                                <div class="weather-value">舒适</div>
                            </div>
                            
                            <div class="weather-item">
                                <div class="weather-label">风速</div>
                                <div class="temp">3.2</div>
                                <i class="fas fa-wind weather-icon"></i>
                                <div class="weather-value">米/秒</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="calendar-card">
                        <div class="card-title">
                            <i class="far fa-calendar-alt"></i>
                            <span data-lang="今日日历">今日日历</span>
                        </div>
                        
                        <div class="calendar">
                            <div class="calendar-header">
                                <h3 id="currentMonth"></h3>
                                <div class="calendar-nav">
                                    <button class="nav-btn" id="prevMonth"><i class="fas fa-chevron-left"></i></button>
                                    <button class="nav-btn" id="nextMonth"><i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>
                            
                            <div class="calendar-grid">
                                <div class="calendar-weekday">日</div>
                                <div class="calendar-weekday">一</div>
                                <div class="calendar-weekday">二</div>
                                <div class="calendar-weekday">三</div>
                                <div class="calendar-weekday">四</div>
                                <div class="calendar-weekday">五</div>
                                <div class="calendar-weekday">六</div>
                                
                                <!-- 日历日期会通过JS填充 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <i class="fab fa-windows"></i>
                    <span data-lang="系统公告">系统公告</span>
                </div>
                
                <p class="system-news">
                    <i class="fas fa-info-circle"></i> <span data-lang="最新Windows 11预览版(Build 23486)现已发布，包含任务栏搜索框样式更新、文件资源管理器改进等多个功能更新。">最新Windows 11预览版(Build 23486)现已发布，包含任务栏搜索框样式更新、文件资源管理器改进等多个功能更新。</span>
                </p>
                <p class="system-news">
                    <i class="fas fa-info-circle"></i> <span data-lang="修复了在多显示器环境下窗口管理的问题，优化了游戏性能表现。">修复了在多显示器环境下窗口管理的问题，优化了游戏性能表现。</span>
                </p>
                <p class="system-news">
                    <i class="fas fa-info-circle"></i> <span data-lang="新版工具箱v0.0.1-beta1.5已发布，新增日历功能，修复已知问题，增强用户体验。">新版工具箱v0.0.1-beta1.5已发布，新增日历功能，修复已知问题，增强用户体验。</span>
                </p>
            </div>
        </div>
        <!-- 编程工具页 -->
        <div id="programming" class="tab-content">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-laptop-code"></i>
                    <span data-lang="在线编程环境">在线编程环境</span>
                </div>
                
                <div class="tools-grid">
                    <div class="tool-card">
                        <div class="tool-icon">
                            <i class="fab fa-codepen"></i>
                        </div>
                        <div class="tool-title">Scratch 编辑器</div>
                        <div class="tool-desc">可视化编程环境，适合初学者学习编程概念和逻辑思维</div>
                        <a href="https://turbowarp.org/editor" target="_blank" class="tool-link">开始编程</a>
                    </div>
                    
                    <div class="tool-card" id="pythonCard">
                        <div class="tool-icon">
                            <i class="fab fa-python"></i>
                        </div>
                        <div class="tool-title">Python 在线环境</div>
                        <div class="tool-desc">功能完整的Python编程环境，支持多种库和即时执行</div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="tool-link" style="border: none; background: none; cursor: pointer; flex: 1;">开始编程</button>
                            <a href="https://lwebapp.com/zh/python-playground" target="_blank" class="tool-link" style="flex: 1; text-align: center;">前进网址</a>
                        </div>
                    </div>
                    
                    <div class="tool-card">
                        <div class="tool-icon">
                            <i class="fas fa-globe"></i>
                        </div>
                        <div class="tool-title">多语言编程环境</div>
                        <div class="tool-desc">支持C、C++、Java、JS等多种语言的在线编译和执行</div>
                        <a href="https://www.bc-cn.net/run/" target="_blank" class="tool-link">开始编程</a>
                    </div>
                </div>
            </div>
            
            <!-- Python编程环境展开区域 -->
            <div class="card" id="pythonEditorCard" style="display: none;">
                <div class="card-title">
                    <i class="fab fa-python"></i>
                    <span>Python 编程环境</span>
                    <button id="closePythonEditor" style="margin-left: auto; background: #ff6b6b; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer;">收起</button>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; gap: 10px;">
                        <button id="runPythonCode" class="tool-link" style="flex: 1;">运行代码</button>
                        <button id="clearPythonOutput" class="tool-link" style="flex: 1; background: #6c757d;">清空输出</button>
                    </div>
                    
                    <div style="display: flex; gap: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Python 代码编辑器</label>
                            <textarea id="pythonCode" style="width: 100%; height: 300px; padding: 15px; border-radius: 10px; border: 2px solid #4361ee; font-family: 'Consolas', 'Courier New', monospace; font-size: 14px; background: #2d2d2d; color: #f8f8f2;" placeholder="在此输入Python代码..."># Python示例代码
print("Hello, World!")
print("欢迎使用Python编程环境")

# 计算示例
a = 10
b = 20
print(f"{a} + {b} = {a + b}")

# 循环示例
for i in range(5):
    print(f"循环次数: {i}")

# 函数示例
def greet(name):
    return f"你好, {name}!"

print(greet("程序员"))</textarea>
                        </div>
                        
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">输出结果</label>
                            <div id="pythonOutput" style="width: 100%; height: 300px; padding: 15px; border-radius: 10px; border: 2px solid #4361ee; background: #2d2d2d; color: #f8f8f2; font-family: 'Consolas', 'Courier New', monospace; font-size: 14px; overflow-y: auto; white-space: pre-wrap;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-book"></i>
                    <span data-lang="编程学习资源">编程学习资源</span>
                </div>
                
                <div class="tools-grid">
                    <div class="tool-card">
                        <div class="tool-icon">
                            <i class="fas fa-school"></i>
                        </div>
                        <div class="tool-title">侯老师编程网站</div>
                        <div class="tool-desc">详细的Scratch、Python教程和项目分享，自带Scratch、Python编辑器</div>
                        <a href="https://codinghou.cn/" target="_blank" class="tool-link">访问网站</a>
                    </div>
                    
                    <div class="tool-card">
                        <div class="tool-icon">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <div class="tool-title">菜鸟教程</div>
                        <div class="tool-desc">全面的编程技术教程，从基础到高级，支持在线实践</div>
                        <a href="https://www.runoob.com/" target="_blank" class="tool-link">访问网站</a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 系统知识页 -->
        <div id="knowledge" class="tab-content">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-book"></i>
                    <span data-lang="系统知识">系统知识</span>
                </div>
                
                <div class="knowledge-container">
                    <!-- 可折叠的知识内容 -->
                    <div class="knowledge-section">
                        <!-- 重装系统方法 -->
                        <div class="knowledge-item">
                            <div class="knowledge-header" onclick="toggleKnowledge(this)">
                                <i class="fas fa-chevron-right toggle-icon"></i>
                                <span class="knowledge-title">重装系统方法</span>
                            </div>
                            <div class="knowledge-content" style="display: none;">
                                <div class="knowledge-detail">
                                    <h4>方法一：使用系统内置重置功能</h4>
                                    <p>1. 按Win+I打开设置<br>
                                    2. 选择"更新和安全" → "恢复"<br>
                                    3. 点击"开始"按钮重置此电脑<br>
                                    4. 选择保留文件或删除所有内容<br>
                                    5. 点击"重置"开始操作</p>
                                </div>
                                <div class="knowledge-detail">
                                    <h4>方法二：使用安装介质重装</h4>
                                    <p>1. 下载Windows官方ISO镜像<br>
                                    2. 使用Rufus等工具制作启动U盘<br>
                                    3. 插入U盘重启电脑，进入BIOS设置启动项<br>
                                    4. 按照安装向导完成系统安装</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 常见蓝屏代码解决 -->
                        <div class="knowledge-item">
                            <div class="knowledge-header" onclick="toggleKnowledge(this)">
                                <i class="fas fa-chevron-right toggle-icon"></i>
                                <span class="knowledge-title">常见蓝屏代码解决</span>
                            </div>
                            <div class="knowledge-content" style="display: none;">
                                <div class="knowledge-detail">
                                    <h4>0x0000007E - 系统线程产生错误</h4>
                                    <p>解决方案：<br>
                                    1. 进入安全模式<br>
                                    2. 卸载最近安装的驱动程序<br>
                                    3. 运行系统文件检查器(sfc /scannow)<br>
                                    4. 更新或回滚显卡驱动</p>
                                </div>
                                <div class="knowledge-detail">
                                    <h4>0x000000ED - 硬盘读取错误</h4>
                                    <p>解决方案：<br>
                                    1. 检查硬盘连接线是否松动<br>
                                    2. 运行chkdsk命令检查磁盘错误<br>
                                    3. 备份重要数据<br>
                                    4. 考虑更换硬盘</p>
                                </div>
                                <div class="knowledge-detail">
                                    <h4>0x0000008E - 内核模式异常</h4>
                                    <p>解决方案：<br>
                                    1. 卸载最近安装的软件<br>
                                    2. 更新系统补丁<br>
                                    3. 检查内存条是否松动<br>
                                    4. 使用内存检测工具测试</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 常用命令 -->
                        <div class="knowledge-item">
                            <div class="knowledge-header" onclick="toggleKnowledge(this)">
                                <i class="fas fa-chevron-right toggle-icon"></i>
                                <span class="knowledge-title">常用命令</span>
                            </div>
                            <div class="knowledge-content" style="display: none;">
                                <div class="knowledge-detail">
                                    <h4>系统管理命令</h4>
                                    <p>sfc /scannow - 扫描并修复系统文件<br>
                                    chkdsk C: /f - 检查并修复C盘错误<br>
                                    tasklist - 查看当前运行的进程<br>
                                    taskkill /f /pid [进程ID] - 强制结束指定进程<br>
                                    shutdown /s /t 0 - 立即关机<br>
                                    shutdown /r /t 0 - 立即重启</p>
                                </div>
                                <div class="knowledge-detail">
                                    <h4>网络诊断命令</h4>
                                    <p>ipconfig /all - 显示网络配置详细信息<br>
                                    ping [网址] - 测试网络连通性<br>
                                    tracert [网址] - 跟踪网络路由<br>
                                    netstat -an - 查看网络连接状态<br>
                                    nslookup [网址] - 查询DNS信息</p>
                                </div>
                                <div class="knowledge-detail">
                                    <h4>磁盘管理命令</h4>
                                    <p>diskpart - 磁盘分区工具<br>
                                    format D: /fs:ntfs - 格式化D盘为NTFS格式<br>
                                    cleanmgr - 打开磁盘清理工具<br>
                                    defrag C: - 对C盘进行碎片整理</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 制作PE启动盘 -->
                        <div class="knowledge-item">
                            <div class="knowledge-header" onclick="toggleKnowledge(this)">
                                <i class="fas fa-chevron-right toggle-icon"></i>
                                <span class="knowledge-title">制作PE启动盘</span>
                            </div>
                            <div class="knowledge-content" style="display: none;">
                                <div class="knowledge-detail">
                                    <h4>firPE简介</h4>
                                    <p>firPE是一款基于Windows PE的免费系统维护工具，具有简洁美观的界面和丰富的实用工具。<br>
                                    特点：<br>
                                    - 轻量级系统，启动速度快<br>
                                    - 界面美观，操作简便<br>
                                    - 集成大量系统维护工具<br>
                                    - 支持多种硬件设备</p>
                                </div>
                                <div class="knowledge-detail">
                                    <h4>制作步骤</h4>
                                    <p>1. 下载firPE官方ISO镜像文件<br>
                                    2. 准备一个容量至少8GB的U盘<br>
                                    3. 下载并安装Rufus工具<br>
                                    4. 插入U盘，打开Rufus<br>
                                    5. 在Rufus中选择firPE的ISO文件<br>
                                    6. 选择目标U盘设备<br>
                                    7. 点击"开始"按钮制作启动盘<br>
                                    8. 等待制作完成，重启电脑并设置U盘为第一启动项</p>
                                </div>
                                <div class="knowledge-detail">
                                    <h4>使用场景</h4>
                                    <p>- 系统无法正常启动时进行修复<br>
                                    - 硬盘数据恢复<br>
                                    - 系统重装前的数据备份<br>
                                    - 病毒查杀和系统清理<br>
                                    - 硬件检测和性能测试</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="card-title">
                            <i class="fas fa-link"></i>
                            <span data-lang="系统知识资源">系统知识资源</span>
                        </div>
                        
                        <div class="resources-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                            <a href="https://learn.microsoft.com/zh-cn/" target="_blank" class="resource-card">
                                <div class="resource-icon">
                                    <i class="fab fa-microsoft"></i>
                                </div>
                                <div class="resource-name">Microsoft Learn</div>
                            </a>
                            
                            <a href="https://www.ithaoge.cn/" target="_blank" class="resource-card">
                                <div class="resource-icon">
                                    <i class="fas fa-laptop-code"></i>
                                </div>
                                <div class="resource-name">IT豪哥教程</div>
                            </a>
                            
                            <a href="https://support.microsoft.com/" target="_blank" class="resource-card">
                                <div class="resource-icon">
                                    <i class="fas fa-question-circle"></i>
                                </div>
                                <div class="resource-name">Microsoft支持中心</div>
                            </a>
                            
                            <a href="https://docs.microsoft.com/" target="_blank" class="resource-card">
                                <div class="resource-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="resource-name">官方文档中心</div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 实用工具页 -->
        <div id="tools" class="tab-content">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-calculator"></i>
                    <span data-lang="科学计算器">科学计算器</span>
                </div>
                
                <div style="max-width: 400px; margin: 0 auto;">
                    <div class="calculator">
                        <input type="text" class="calc-display" value="0" readonly>
                        <div class="calc-keys">
                            <button class="calc-key">C</button>
                            <button class="calc-key">CE</button>
                            <button class="calc-key operator">%</button>
                            <button class="calc-key operator">÷</button>
                            <button class="calc-key">7</button>
                            <button class="calc-key">8</button>
                            <button class="calc-key">9</button>
                            <button class="calc-key operator">×</button>
                            <button class="calc-key">4</button>
                            <button class="calc-key">5</button>
                            <button class="calc-key">6</button>
                            <button class="calc-key operator">-</button>
                            <button class="calc-key">1</button>
                            <button class="calc-key">2</button>
                            <button class="calc-key">3</button>
                            <button class="calc-key operator">+</button>
                            <button class="calc-key">00</button>
                            <button class="calc-key">0</button>
                            <button class="calc-key">.</button>
                            <button class="calc-key equal">=</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 新增实用网站卡片区 -->
            <div class="card" id="websiteCard">
                <div class="card-title">
                    <i class="fas fa-globe"></i>
                    <span data-lang="实用网站">实用网站</span>
                </div>
                <div class="resources-grid" id="websiteList">
                    <!-- 网站卡片将由JS动态填充 -->
                </div>
                <div style="text-align: right; margin-top: 18px;">
                    <button class="tool-link" id="addWebsiteBtn" style="font-size: 1rem;">自定义添加网站</button>
                </div>
            </div>
            <!-- 添加网站弹窗表单 -->
            <div id="addWebsiteModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:9999; align-items:center; justify-content:center;">
                <form id="websiteForm" style="background:var(--card-bg); border-radius:16px; box-shadow:0 8px 32px rgba(67,97,238,0.18); padding:32px 28px; min-width:320px; max-width:90vw; display:flex; flex-direction:column; gap:18px;">
                    <h3 style="color:var(--primary-color); margin-bottom:8px;" data-lang="添加自定义网站">添加自定义网站</h3>
                    <input type="text" id="siteName" data-lang-placeholder="网站名称" placeholder="网站名称" required style="padding:12px; border-radius:8px; border:1px solid rgba(67,97,238,0.3); background:var(--card-bg); color:inherit;">
                    <input type="text" id="siteDesc" data-lang-placeholder="网站描述" placeholder="网站描述" style="padding:12px; border-radius:8px; border:1px solid rgba(67,97,238,0.3); background:var(--card-bg); color:inherit;">
                    <input type="url" id="siteUrl" data-lang-placeholder="网站网址（https://...）" placeholder="网站网址（https://...）" required style="padding:12px; border-radius:8px; border:1px solid rgba(67,97,238,0.3); background:var(--card-bg); color:inherit;">
                    <label style="font-size:0.95rem; color:inherit;" data-lang="网站图标（正方形png/jpg/ico，建议64x64）：">网站图标（正方形png/jpg/ico，建议64x64）：</label>
                    <input type="file" id="siteIcon" accept=".png,.jpg,.jpeg,.ico" style="margin-bottom:8px;">
                    <div style="display:flex; gap:12px; justify-content:flex-end;">
                        <button type="button" id="cancelAddWebsite" style="padding:8px 18px; border-radius:8px; background:#eee; color:#333; border:none;" data-lang="取消">取消</button>
                        <button type="submit" style="padding:8px 18px; border-radius:8px; background:var(--primary-color); color:#fff; border:none;" data-lang="保存">保存</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- 设置页 -->
        <div id="settings" class="tab-content">
            <div class="settings-container">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-palette"></i>
                        <span data-lang="主题设置">主题设置</span>
                    </div>
                    
                    <div class="setting-option">
                        <div class="setting-label">
                            <i class="fas fa-sun"></i>
                            <span>主题模式</span>
                        </div>
                        <div class="select-box">
                            <select class="setting-select" id="themeSelect">
                                <option value="light">浅色模式</option>
                                <option value="dark">深色模式</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 毛玻璃效果设置 -->
                    <div class="setting-option">
                        <div class="setting-label">
                            <i class="fas fa-window-maximize"></i>
                            <span>毛玻璃效果</span>
                        </div>
                        <div class="select-box">
                            <div style="display: flex; gap: 15px; margin-bottom: 15px; align-items: center;">
                                <button id="toggleBlurBtn" class="tool-link" style="padding: 8px 16px; font-size: 0.9rem; flex-shrink: 0; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-eye" style="font-size: 1rem;"></i>
                                    <span id="toggleBlurText">开启毛玻璃</span>
                                </button>
                                <div style="flex: 1; text-align: center; font-size: 0.85rem; opacity: 0.7;">
                                    <span>切换毛玻璃效果</span>
                                </div>
                            </div>
                            
                            <!-- 模糊度设置 -->
                            <div id="blurSettings" style="margin-top: 15px; padding: 15px; background: rgba(67,97,238,0.08); border-radius: 10px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary-color);">
                                    模糊度设置
                                </label>
                                <input type="range" id="blurSlider" min="0" max="20" step="1" value="10" style="width: 100%; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>0</span>
                                    <span id="blurValue">10px</span>
                                    <span>20</span>
                                </div>
                            </div>
                            
                            <!-- 自定义背景设置 -->
                            <div id="backgroundSettings" style="margin-top: 15px; padding: 15px; background: rgba(67,97,238,0.08); border-radius: 10px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary-color);">
                                    自定义背景
                                </label>
                                <input type="file" id="backgroundUpload" accept="image/*" style="width: 100%; margin-bottom: 10px;">
                                <button id="resetBackground" class="tool-link" style="background: #dc3545; font-size: 0.9rem; padding: 6px 12px;">
                                    <i class="fas fa-undo" style="margin-right: 6px;"></i>
                                    重置背景
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="setting-option">
                        <div class="setting-label">
                            <i class="fas fa-language"></i>
                            <span data-lang="语言设置">语言设置</span>
                        </div>
                        <div class="select-box">
                            <select class="setting-select" id="languageSelect">
                                <option value="zh">中文</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 地区选择功能 -->
                    <div class="setting-option">
                        <div class="setting-label">
                            <i class="fas fa-map-marker-alt"></i>
                            <span data-lang="地区选择">地区选择</span>
                        </div>
                        <div class="select-box">
                            <div style="display: flex; gap: 15px; margin-bottom: 15px; align-items: center;">
                                <button id="autoLocationBtn" class="tool-link" style="padding: 8px 16px; font-size: 0.9rem; flex-shrink: 0;">
                                    <i class="fas fa-location-arrow" style="margin-right: 6px;"></i>
                                    <span data-lang="自动定位">自动定位</span>
                                </button>
                                <div style="flex: 1; text-align: center; font-size: 0.85rem; opacity: 0.7;">
                                    <span data-lang="或手动选择城市">或手动选择城市</span>
                                </div>
                            </div>
                            
                            <!-- 省份筛选 -->
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary-color);">
                                    <span data-lang="省份筛选">省份筛选</span>
                                </label>
                                <select id="provinceSelect" class="setting-select" style="width:100%; margin-bottom: 10px;">
                                    <option value="all">全部省份</option>
                                    <option value="beijing">北京市</option>
                                    <option value="shanghai">上海市</option>
                                    <option value="tianjin">天津市</option>
                                    <option value="chongqing">重庆市</option>
                                    <option value="guangdong">广东省</option>
                                    <option value="jiangsu">江苏省</option>
                                    <option value="zhejiang">浙江省</option>
                                    <option value="shandong">山东省</option>
                                    <option value="sichuan">四川省</option>
                                    <option value="hubei">湖北省</option>
                                    <option value="fujian">福建省</option>
                                    <option value="liaoning">辽宁省</option>
                                    <option value="shaanxi">陕西省</option>
                                    <option value="henan">河南省</option>
                                    <option value="hebei">河北省</option>
                                    <option value="hunan">湖南省</option>
                                    <option value="anhui">安徽省</option>
                                    <option value="jiangxi">江西省</option>
                                    <option value="guangxi">广西</option>
                                    <option value="yunnan">云南省</option>
                                    <option value="international">国际城市</option>
                                </select>
                            </div>
                            
                            <!-- 城市选择 -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary-color);">
                                    <span data-lang="选择城市">选择城市</span>
                                </label>
                                <select id="citySelect" class="setting-select" style="width:100%;">
                                    <!-- 城市选项将由JavaScript动态生成 -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 时钟显示设置 -->
                    <div class="setting-option">
                        <div class="setting-label">
                            <i class="fas fa-clock"></i>
                            <span>时钟显示格式</span>
                        </div>
                        <div class="select-box">
                            <div style="display: flex; gap: 15px; margin-bottom: 15px; align-items: center;">
                                <button id="toggleSecondsBtn" class="tool-link" style="padding: 8px 16px; font-size: 0.9rem; flex-shrink: 0; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-clock" style="font-size: 1rem;"></i>
                                    <span id="toggleSecondsText">显示秒</span>
                                </button>
                                <div style="flex: 1; text-align: center; font-size: 0.85rem; opacity: 0.7;">
                                    <span>切换时钟显示格式</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 时区设置 -->
                    <div class="setting-option">
                        <div class="setting-label">
                            <i class="fas fa-globe"></i>
                            <span>时区设置</span>
                        </div>
                        <div class="select-box">
                            <div style="display: flex; gap: 15px; margin-bottom: 15px; align-items: center;">
                                <button id="autoTimezoneBtn" class="tool-link" style="padding: 8px 16px; font-size: 0.9rem; flex-shrink: 0;">
                                    <i class="fas fa-location-arrow" style="margin-right: 6px;"></i>
                                    <span>自动获取</span>
                                </button>
                                <div style="flex: 1; text-align: center; font-size: 0.85rem; opacity: 0.7;">
                                    <span>或手动选择时区</span>
                                </div>
                            </div>
                            
                            <!-- 时区选择 -->
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary-color);">
                                    <span>选择时区</span>
                                </label>
                                <select id="timezoneSelect" class="setting-select" style="width:100%;">
                                    <option value="Asia/Shanghai">亚洲/上海 (UTC+8)</option>
                                    <option value="Asia/Tokyo">亚洲/东京 (UTC+9)</option>
                                    <option value="Asia/Seoul">亚洲/首尔 (UTC+9)</option>
                                    <option value="America/New_York">美洲/纽约 (UTC-5/-4)</option>
                                    <option value="America/Los_Angeles">美洲/洛杉矶 (UTC-8/-7)</option>
                                    <option value="Europe/London">欧洲/伦敦 (UTC+0/+1)</option>
                                    <option value="Europe/Paris">欧洲/巴黎 (UTC+1/+2)</option>
                                    <option value="Australia/Sydney">澳洲/悉尼 (UTC+10/+11)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-user-circle"></i>
                        <span data-lang="账户管理">账户管理</span>
                    </div>
                    
                    <div id="loginSection" style="text-align: center; padding: 20px;">
                        <p style="margin-bottom: 20px; opacity: 0.8;">
                            <span data-lang="登录后可同步设置到云端">登录后可同步设置到云端</span>
                        </p>
                        
                        <div style="display: flex; flex-direction: column; gap: 12px; align-items: center; max-width: 300px; margin: 0 auto;">
                            <!-- GitHub登录按钮 -->
                            <button class="login-btn github-btn" onclick="loginWithProvider('github')">
                                <i class="fab fa-github" style="margin-right: 8px;"></i>
                                <span data-lang="GitHub 登录">GitHub 登录</span>
                            </button>
                            
                            <!-- 登录账户按钮 -->
                            <button class="tool-link" onclick="loginAccount()" style="background: #28a745; margin-top: 10px;">
                                <i class="fas fa-user-circle" style="margin-right: 6px;"></i>
                                <span data-lang="登录账户">登录账户</span>
                            </button>
                            
                            <button class="tool-link" onclick="testGitHubLogin()" style="background: #28a745; margin-top: 10px;">
                                <i class="fas fa-rocket" style="margin-right: 6px;"></i>
                                <span data-lang="快速登录">快速登录</span>
                            </button>
                        </div>
                        
                        <p style="margin-top: 15px; font-size: 0.85rem; opacity: 0.6;">
                            <span data-lang="不登录不会限制任何功能">不登录不会限制任何功能</span>
                        </p>
                    </div>
                    
                    <div id="userProfile" style="display: none; text-align: center; padding: 20px;">
                        <div style="margin-bottom: 20px;">
                            <img id="userAvatar" style="width: 80px; height: 80px; border-radius: 50%; margin-bottom: 15px; border: 3px solid var(--primary-color);" />
                            <!-- 添加修改头像的按钮 -->
                            <div style="margin-bottom: 15px;">
                                <input type="file" id="avatarUpload" accept=".jpg,.jpeg,.png,.ico" style="display: none;" />
                                <button class="tool-link" onclick="document.getElementById('avatarUpload').click();" style="background: #28a745; font-size: 0.9rem; padding: 6px 12px;">
                                    <i class="fas fa-camera" style="margin-right: 6px;"></i>
                                    <span data-lang="修改头像">修改头像</span>
                                </button>
                                <div id="avatarError" class="error-message" style="font-size: 0.85rem; margin-top: 5px;"></div>
                            </div>
                            <h4 id="userName" style="margin: 0; color: var(--primary-color); font-size: 1.3rem;"></h4>
                            <p id="userEmail" style="margin: 5px 0; opacity: 0.7; font-size: 0.9rem;"></p>
                            <div id="userDetails" style="margin-top: 10px; font-size: 0.85rem; opacity: 0.6;"></div>
                            <div id="githubStats" style="margin-top: 15px; display: none;"></div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button class="tool-link" onclick="syncSettings()">
                                <i class="fas fa-sync" style="margin-right: 6px;"></i>
                                <span data-lang="同步设置">同步设置</span>
                            </button>
                            
                            <button class="tool-link" id="viewProfileBtn" onclick="viewGitHubProfile()" style="background: #24292e; display: none;">
                                <i class="fab fa-github" style="margin-right: 6px;"></i>
                                <span data-lang="查看GitHub">查看GitHub</span>
                            </button>
                            
                            <button class="tool-link" onclick="logout()" style="background: #ff6b6b;">
                                <i class="fas fa-sign-out-alt" style="margin-right: 6px;"></i>
                                <span data-lang="退出登录">退出登录</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-broom"></i>
                        <span data-lang="数据管理">数据管理</span>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin-bottom: 10px; color: var(--primary-color);">
                                <i class="fas fa-cookie-bite" style="margin-right: 8px;"></i>
                                <span data-lang="Cookie 管理">Cookie 管理</span>
                            </h4>
                            <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px;">
                                <span data-lang="清除所有保存的设置和数据">清除所有保存的设置和数据</span>
                            </p>
                            
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="tool-link" onclick="showCookieInfo()" style="background: #17a2b8;">
                                    <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
                                    <span data-lang="查看数据">查看数据</span>
                                </button>
                                <!-- 登录账户按钮 -->
                                <button class="tool-link" onclick="loginAccount()" style="background: #28a745; margin-top: 10px;">
                                    <i class="fas fa-user-circle" style="margin-right: 6px;"></i>
                                    <span data-lang="登录账户">登录账户</span>
                                </button>
                                
                                <button class="tool-link" onclick="clearAllData()" style="background: #dc3545;">
                                    <i class="fas fa-trash-alt" style="margin-right: 6px;"></i>
                                    <span data-lang="清除所有数据">清除所有数据</span>
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="margin-bottom: 10px; color: var(--primary-color);">
                                <i class="fas fa-download" style="margin-right: 8px;"></i>
                                <span data-lang="数据导入导出">数据导入导出</span>
                            </h4>
                            <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px;">
                                <span data-lang="备份和恢复您的设置">备份和恢复您的设置</span>
                            </p>
                            
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="tool-link" onclick="exportSettings()" style="background: #28a745;">
                                    <i class="fas fa-file-export" style="margin-right: 6px;"></i>
                                    <span data-lang="导出设置">导出设置</span>
                                </button>
                                
                                <button class="tool-link" onclick="importSettings()" style="background: #fd7e14;">
                                    <i class="fas fa-file-import" style="margin-right: 6px;"></i>
                                    <span data-lang="导入设置">导入设置</span>
                                </button>
                            </div>
                            
                            <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleImportFile(event)" />
                        </div>
                    </div>
                </div>
                
                <!-- 退出设置 -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-sign-out-alt"></i>
                        <span data-lang="退出设置">退出设置</span>
                    </div>
                    
                    <div class="setting-option">
                        <div class="setting-label">
                            <i class="fas fa-question-circle"></i>
                            <span data-lang="退出时询问">退出时询问</span>
                        </div>
                        <div class="select-box">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <label class="switch">
                                    <input type="checkbox" id="exitConfirmToggle" checked>
                                    <span class="slider"></span>
                                </label>
                                <span data-lang="启用退出确认">启用退出确认</span>
                            </div>
                            <div style="margin-top: 15px; display: flex; align-items: center; gap: 15px;">
                                <label class="switch">
                                    <input type="checkbox" id="rememberExitChoiceToggle">
                                    <span class="slider"></span>
                                </label>
                                <span data-lang="记住我的选择">记住我的选择</span>
                            </div>
                            <div style="margin-top: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary-color);">
                                    <span data-lang="默认退出行为">默认退出行为</span>
                                </label>
                                <select id="defaultExitAction" class="setting-select" style="width:100%;">
                                    <option value="exit" data-lang="完全退出">完全退出</option>
                                    <option value="minimize" data-lang="最小化到托盘">最小化到托盘</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div style="text-align: center; padding: 20px;">
                        <button class="easter-btn" id="easterEggBtn">
                            <span data-lang="？？？">？？？</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 退出确认对话框 -->
    <div id="exitDialog" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px; padding: 30px;">
            <div style="text-align: center; margin-bottom: 25px;">
                <i class="fas fa-question-circle" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 15px;"></i>
                <h2 data-lang="退出确认" style="margin: 0;">退出确认</h2>
                <p data-lang="您想要完全退出还是最小化到托盘？" style="margin: 10px 0 0 0; opacity: 0.8;">您想要完全退出还是最小化到托盘？</p>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <button id="exitAppBtn" class="tool-link" style="background: #dc3545; padding: 12px; font-size: 1.1rem;">
                    <i class="fas fa-power-off" style="margin-right: 8px;"></i>
                    <span data-lang="完全退出">完全退出</span>
                </button>
                
                <button id="minimizeToTrayBtn" class="tool-link" style="background: var(--primary-color); padding: 12px; font-size: 1.1rem;">
                    <i class="fas fa-window-minimize" style="margin-right: 8px;"></i>
                    <span data-lang="最小化到托盘">最小化到托盘</span>
                </button>
                
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                    <input type="checkbox" id="rememberExitChoice" style="width: 18px; height: 18px;">
                    <label for="rememberExitChoice" data-lang="记住我的选择" style="font-size: 0.9rem;">记住我的选择</label>
                </div>
                
                <button id="cancelExitBtn" class="tool-link" style="background: #6c757d; padding: 10px; font-size: 1rem; margin-top: 10px;">
                    <i class="fas fa-times" style="margin-right: 8px;"></i>
                    <span data-lang="取消">取消</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- 软件逆向标签页 -->
    <div id="reverse" class="tab-content">
        <div class="card">
            <div class="card-title">
                <i class="fas fa-search"></i>
                <span data-lang="软件逆向">软件逆向</span>
            </div>
            
            <div class="tools-grid">
                <!-- 推荐逆向工程学习网站 -->
                <div class="tool-card">
                    <div class="tool-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="tool-title">看雪学院</div>
                    <div class="tool-desc">国内知名的逆向工程学习平台，提供丰富的逆向技术教程和资源</div>
                    <a href="https://www.kanxue.com/" target="_blank" class="tool-link">访问网站</a>
                </div>
                
                <div class="tool-card">
                    <div class="tool-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="tool-title">吾爱破解</div>
                    <div class="tool-desc">专注于软件安全与逆向分析的技术论坛</div>
                    <a href="https://www.52pojie.cn/" target="_blank" class="tool-link">访问网站</a>
                </div>
                
                <div class="tool-card">
                    <div class="tool-icon">
                        <i class="fas fa-laptop-code"></i>
                    </div>
                    <div class="tool-title">逆向工程入门</div>
                    <div class="tool-desc">系统化的逆向工程学习资源和实战案例</div>
                    <a href="https://www.reversing.kr/" target="_blank" class="tool-link">访问网站</a>
                </div>
                
                <div class="tool-card">
                    <div class="tool-icon">
                        <i class="fas fa-video"></i>
                    </div>
                    <div class="tool-title">边亮逆向教程</div>
                    <div class="tool-desc">专业逆向工程师边亮的视频教程，深入浅出讲解逆向技术</div>
                    <a href="https://space.bilibili.com/379889714" target="_blank" class="tool-link">观看视频</a>
                </div>
                
                <div class="tool-card">
                    <div class="tool-icon">
                        <i class="fas fa-tools"></i>
                    </div>
                    <div class="tool-title">逆向工具集</div>
                    <div class="tool-desc">常用逆向分析工具下载和使用教程</div>
                    <a href="https://github.com/topics/reverse-engineering" target="_blank" class="tool-link">查看工具</a>
                </div>
                
                <div class="tool-card">
                    <div class="tool-icon">
                        <i class="fas fa-flask"></i>
                    </div>
                    <div class="tool-title">逆向实验</div>
                    <div class="tool-desc">动手实践逆向技术，通过实际案例学习</div>
                    <a href="https://crackmes.one/" target="_blank" class="tool-link">开始实验</a>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">
                <i class="fas fa-lightbulb"></i>
                <span data-lang="逆向趣事">逆向趣事</span>
            </div>
            
            <div class="tools-grid">
                <div class="tool-card">
                    <div class="tool-icon">
                        <i class="fas fa-gamepad"></i>
                    </div>
                    <div class="tool-title">游戏破解的故事</div>
                    <div class="tool-desc">讲述经典游戏破解背后的技术故事和趣事</div>
                    <button class="tool-link" onclick="showReverseStory('游戏破解的故事')">查看详情</button>
                </div>
                
                <div class="tool-card">
                    <div class="tool-icon">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div class="tool-title">手机App逆向</div>
                    <div class="tool-desc">揭秘手机应用逆向分析的有趣案例</div>
                    <button class="tool-link" onclick="showReverseStory('手机App逆向')">查看详情</button>
                </div>
                
                <div class="tool-card">
                    <div class="tool-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="tool-title">安全防护对抗</div>
                    <div class="tool-desc">软件保护与逆向分析之间的技术对抗趣事</div>
                    <button class="tool-link" onclick="showReverseStory('安全防护对抗')">查看详情</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI聊天标签页 -->
    <div id="ai-chat" class="tab-content">
        <div class="card">
            <div class="card-title">
                <i class="fas fa-robot"></i>
                <span data-lang="AI聊天机器人">AI聊天机器人</span>
            </div>
            
            <div class="chat-container" style="display: flex; flex-direction: column; height: 600px;">
                <!-- 聊天历史记录 -->
                <div id="chatHistory" class="chat-history" style="flex: 1; overflow-y: auto; padding: 20px; background: rgba(67,97,238,0.05); border-radius: 15px; margin-bottom: 20px;">
                    <div class="message ai-message" style="margin-bottom: 15px; display: flex; align-items: flex-start; gap: 10px;">
                        <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #4361ee, #3a0ca3); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div style="background: white; padding: 12px 16px; border-radius: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 80%;">
                            <div style="font-weight: 600; margin-bottom: 5px; color: var(--primary-color);">AI助手</div>
                            <div data-lang="您好！我是AI助手，您可以和我聊天或询问任何问题。请先在设置中配置您的AI API密钥。">您好！我是AI助手，您可以和我聊天或询问任何问题。请先在设置中配置您的AI API密钥。</div>
                        </div>
                    </div>
                </div>
                
                <!-- 输入区域 -->
                <div class="chat-input-area" style="display: flex; gap: 10px;">
                    <textarea id="chatInput" data-lang-placeholder="输入您的消息..." placeholder="输入您的消息..." style="flex: 1; padding: 15px; border-radius: 15px; border: 2px solid var(--primary-color); background: var(--card-bg); color: inherit; font-family: inherit; resize: none; height: 80px;"></textarea>
                    <button id="sendChatBtn" class="tool-link" style="align-self: flex-end; padding: 15px 25px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-paper-plane"></i>
                        <span data-lang="发送">发送</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">
                <i class="fas fa-cog"></i>
                <span data-lang="AI设置">AI设置</span>
            </div>
            
            <div class="setting-option">
                <div class="setting-label">
                    <i class="fas fa-key"></i>
                    <span data-lang="API密钥">API密钥</span>
                </div>
                <div class="select-box">
                    <input type="password" id="aiApiKey" class="setting-select" data-lang-placeholder="请输入您的AI API密钥" placeholder="请输入您的AI API密钥" style="margin-bottom: 15px;">
                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px;" data-lang="请在设置中输入您的OpenAI或其他AI服务的API密钥，否则聊天功能将无法使用。">
                        请在设置中输入您的OpenAI或其他AI服务的API密钥，否则聊天功能将无法使用。
                    </div>
                    <button id="saveAiApiKey" class="tool-link" style="padding: 10px 20px;">
                        <i class="fas fa-save"></i>
                        <span data-lang="保存密钥">保存密钥</span>
                    </button>
                </div>
            </div>
            
            <div class="setting-option">
                <div class="setting-label">
                    <i class="fas fa-sliders-h"></i>
                    <span data-lang="模型设置">模型设置</span>
                </div>
                <div class="select-box">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary-color);" data-lang="选择AI模型">选择AI模型</label>
                    <select id="aiModelSelect" class="setting-select" style="margin-bottom: 15px;">
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                        <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                        <option value="claude-3-opus">Claude 3 Opus</option>
                        <option value="custom" data-lang="自定义模型">自定义模型</option>
                    </select>
                    
                    <div id="customModelContainer" style="display: none; margin-top: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary-color);" data-lang="自定义模型名称">自定义模型名称</label>
                        <input type="text" id="customModelName" class="setting-select" data-lang-placeholder="输入模型名称" placeholder="输入模型名称">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p data-lang="阮铭泽工具箱 v0.0.1-beta1.5 - 成长中的工具箱，未来会更加强大！">阮铭泽工具箱 v0.0.1-beta1.5 - 成长中的工具箱，未来会更加强大！</p>
        <p data-lang="联系邮箱: ruanmingze2016@gmail.com | xmt20160124@outlook.com">联系邮箱: ruanmingze2016@gmail.com | xmt20160124@outlook.com</p>
    </footer>
    <script>
            try {
                // 优先使用localStorage存储
                localStorage.setItem(name, value);
                
                // 同时尝试设置Cookie作为备份
                const d = new Date();
                d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
                const expires = "expires=" + d.toUTCString();
                document.cookie = name + "=" + value + ";" + expires + ";path=/";
            } catch (error) {
                // 如果都失败，静默处理
                console.log('存储功能不可用，使用默认设置');
            }
        
        function getCookie(name) {
            try {
                // 优先从 localStorage 读取
                const localValue = localStorage.getItem(name);
                if (localValue !== null) {
                    return localValue;
                }
                
                // 如果 localStorage 中没有，尝试从 Cookie 读取
                const cookieName = name + "=";
                const decodedCookie = decodeURIComponent(document.cookie);
                const cookieArray = decodedCookie.split(';');
                
                for (let i = 0; i < cookieArray.length; i++) {
                    let cookie = cookieArray[i];
                    while (cookie.charAt(0) === ' ') {
                        cookie = cookie.substring(1);
                    }
                    if (cookie.indexOf(cookieName) === 0) {
                        const value = cookie.substring(cookieName.length, cookie.length);
                        // 同步到 localStorage
                        try {
                            localStorage.setItem(name, value);
                        } catch (e) {}
                        return value;
                    }
                }
            } catch (error) {
                console.log('读取存储数据失败');
            }
            return "";
        }
        
        // 英文语言包及切换函数
const langDict = {
    "主页": { zh: "主页", en: "Home" },
    "编程工具": { zh: "编程工具", en: "Programming" },
    "系统知识": { zh: "系统知识", en: "Knowledge" },
    "实用工具": { zh: "实用工具", en: "Tools" },
    "设置": { zh: "设置", en: "Settings" },
    "天气预报": { zh: "天气预报", en: "Weather Forecast" },
    "今日日历": { zh: "今日日历", en: "Today's Calendar" },
    "系统公告": { zh: "系统公告", en: "System News" },
    "编程学习资源": { zh: "编程学习资源", en: "Programming Resources" },
    "科学计算器": { zh: "科学计算器", en: "Calculator" },
    "摸鱼推荐": { zh: "摸鱼推荐", en: "Fun Games" },
    "主题设置": { zh: "主题设置", en: "Theme Settings" },
    "语言设置": { zh: "语言设置", en: "Language Settings" },
    "彩蛋区域": { zh: "彩蛋区域", en: "Easter Egg" },
    "点我触发彩蛋 (点击三次)": { zh: "点我触发彩蛋 (点击三次)", en: "Click me for Easter Egg (3 times)" },
    "连续点击三次按钮，享受酷炫效果！": { zh: "连续点击三次按钮，享受酷炫效果！", en: "Click the button three times for a cool effect!" },
    "当前温度": { zh: "当前温度", en: "Temperature" },
    "体感温度": { zh: "体感温度", en: "Feels Like" },
    "湿度": { zh: "湿度", en: "Humidity" },
    "风速": { zh: "风速", en: "Wind Speed" },
    "舒适": { zh: "舒适", en: "Comfortable" },
    "较热": { zh: "较热", en: "Hot" },
    "晴天": { zh: "晴天", en: "Sunny" },
    "米/秒": { zh: "米/秒", en: "m/s" },
    "搜索": { zh: "搜索", en: "Search" },
    "系统知识查询": { zh: "系统知识查询", en: "Knowledge Search" },
    "系统知识资源": { zh: "系统知识资源", en: "Knowledge Resources" },
    "全球地图": { zh: "全球地图", en: "World Map" },
    "动画较快，可能引起不适": { zh: "动画较快，可能引起不适", en: "Fast animation, may cause discomfort" },
    "？？？": { zh: "？？？", en: "???" },
    "Scratch 编辑器": { zh: "Scratch 编辑器", en: "Scratch Editor" },
    "可视化编程环境，适合初学者学习编程概念和逻辑思维": { zh: "可视化编程环境，适合初学者学习编程概念和逻辑思维", en: "Visual programming for beginners to learn coding concepts and logic." },
    "开始编程": { zh: "开始编程", en: "Start Coding" },
    "查看GitHub": { zh: "查看GitHub", en: "View GitHub" },
    "Python 在线环境": { zh: "Python 在线环境", en: "Python Online" },
    "功能完整的Python编程环境，支持多种库和即时执行": { zh: "功能完整的Python编程环境，支持多种库和即时执行", en: "Full-featured Python environment, supports libraries and instant execution." },
    "多语言编程环境": { zh: "多语言编程环境", en: "Multi-language Coding" },
    "支持C、C++、Java、JS等多种语言的在线编译和执行": { zh: "支持C、C++、Java、JS等多种语言的在线编译和执行", en: "Supports C, C++, Java, JS and more for online compiling and running." },
    "侯老师编程网站": { zh: "侯老师编程网站", en: "Hou's Coding Site" },
    "专业编程学习资源，包含教程、案例和实战项目": { zh: "专业编程学习资源，包含教程、案例和实战项目", en: "Professional coding resources, tutorials, cases and projects." },
    "访问网站": { zh: "访问网站", en: "Visit Site" },
    "菜鸟教程": { zh: "菜鸟教程", en: "Rookie Tutorial" },
    "全面的编程技术教程，从基础到高级，支持在线实践": { zh: "全面的编程技术教程，从基础到高级，支持在线实践", en: "Comprehensive coding tutorials from basic to advanced, supports online practice." },
    "Windows系统安装指南": { zh: "Windows系统安装指南", en: "Windows Installation Guide" },
    "详细步骤教你如何安装和配置Windows操作系统...": { zh: "详细步骤教你如何安装和配置Windows操作系统...", en: "Step-by-step guide for installing and configuring Windows..." },
    "命令行工具使用技巧": { zh: "命令行工具使用技巧", en: "Command Line Tips" },
    "掌握常用的CMD和PowerShell命令，提升工作效率...": { zh: "掌握常用的CMD和PowerShell命令，提升工作效率...", en: "Master CMD and PowerShell commands to boost productivity..." },
    "系统性能优化方法": { zh: "系统性能优化方法", en: "System Performance Tips" },
    "10种有效提升Windows系统性能的技巧和方法...": { zh: "10种有效提升Windows系统性能的技巧和方法...", en: "10 effective ways to improve Windows performance..." },
    "IT豪哥教程": { zh: "IT豪哥教程", en: "IT Hao Tutorial" },
    "Microsoft支持中心": { zh: "Microsoft支持中心", en: "Microsoft Support" },
    "官方文档中心": { zh: "官方文档中心", en: "Official Docs" },
    "摸鱼小游戏合集": { zh: "摸鱼小游戏合集", en: "Fun Mini Games" },
    "精选各种有趣的小游戏，休闲放松好去处": { zh: "精选各种有趣的小游戏，休闲放松好去处", en: "Selected fun mini games for relaxation." },
    "点击前往": { zh: "点击前往", en: "Go" },
    "全球地图": { zh: "全球地图", en: "World Map" },
    "地区选择": { zh: "地区选择", en: "Region Selection" },
    "在设置中可更换城市": { zh: "在设置中可更换城市", en: "Change city in settings" },
    "当前城市": { zh: "当前城市", en: "Current City" },
    "使用下拉选择城市": { zh: "使用下拉选择城市", en: "Use dropdown to select city" },
    "错误": { zh: "错误", en: "Error" },
    "实用网站": { zh: "实用网站", en: "Useful Websites" },
    "自定义添加网站": { zh: "自定义添加网站", en: "Add Custom Website" },
    "在线编程环境": { zh: "在线编程环境", en: "Online Programming" },
    // 新增工具箱标题和其他缺失的翻译
    "阮铭泽工具箱": { zh: "阮铭泽工具箱", en: "Ryan's Toolbox" },
    
    // 天气和城市相关
    "在设置中可更换城市": { zh: "在设置中可更换城市", en: "Change city in settings" },
    "当前城市": { zh: "当前城市", en: "Current City" },
    "最新Windows 11预览版(Build 23486)现已发布，包含任务栏搜索框样式更新、文件资源管理器改进等多个功能更新。": { zh: "最新Windows 11预览版(Build 23486)现已发布，包含任务栏搜索框样式更新、文件资源管理器改进等多个功能更新。", en: "The latest Windows 11 preview build (Build 23486) is now available, featuring taskbar search box style updates, File Explorer improvements, and more feature updates." },
    "修复了在多显示器环境下窗口管理的问题，优化了游戏性能表现。": { zh: "修复了在多显示器环境下窗口管理的问题，优化了游戏性能表现。", en: "Fixed window management issues in multi-monitor environments and optimized gaming performance." },
    "新版工具箱v0.0.1-beta1.5已发布，新增日历功能，修复已知问题，增强用户体验。": { zh: "新版工具箱v0.0.1-beta1.5已发布，新增日历功能，修复已知问题，增强用户体验。", en: "New version v0.0.1-beta1.5 of the toolbox has been released, adding calendar functionality, fixing known issues, and enhancing user experience." },
    "可视化编程环境，适合初学者学习编程概念和逻辑思维": { zh: "可视化编程环境，适合初学者学习编程概念和逻辑思维", en: "Visual programming environment, suitable for beginners to learn programming concepts and logical thinking" },
    "专业编程学习资源，包含教程、案例和实战项目": { zh: "专业编程学习资源，包含教程、案例和实战项目", en: "Professional programming learning resources, including tutorials, cases, and practical projects" },
    "全面的编程技术教程，从基础到高级，支持在线实践": { zh: "全面的编程技术教程，从基础到高级，支持在线实践", en: "Comprehensive programming tutorials from basic to advanced, supporting online practice" },
    "10种有效提升Windows系统性能的技巧和方法...": { zh: "10种有效提升Windows系统性能的技巧和方法...", en: "10 effective ways to improve Windows system performance..." },
    
    // 月份和日期
    "2023年7月": { zh: "2023年7月", en: "July 2023" },
    "一月": { zh: "一月", en: "January" },
    "二月": { zh: "二月", en: "February" },
    "三月": { zh: "三月", en: "March" },
    "四月": { zh: "四月", en: "April" },
    "五月": { zh: "五月", en: "May" },
    "六月": { zh: "六月", en: "June" },
    "七月": { zh: "七月", en: "July" },
    "八月": { zh: "八月", en: "August" },
    "九月": { zh: "九月", en: "September" },
    "十月": { zh: "十月", en: "October" },
    "十一月": { zh: "十一月", en: "November" },
    "十二月": { zh: "十二月", en: "December" },
    "日": { zh: "日", en: "Sun" },
    "一": { zh: "一", en: "Mon" },
    "二": { zh: "二", en: "Tue" },
    "三": { zh: "三", en: "Wed" },
    "四": { zh: "四", en: "Thu" },
    "五": { zh: "五", en: "Fri" },
    "六": { zh: "六", en: "Sat" },
    
    // 输入框占位符
    "输入您要查询的系统知识...": { zh: "输入您要查询的系统知识...", en: "Enter the system knowledge you want to query..." },
    
    // 城市显示
    
    // 计算器按钮
    "C": { zh: "C", en: "C" },
    "CE": { zh: "CE", en: "CE" },
    "%": { zh: "%", en: "%" },
    "÷": { zh: "÷", en: "÷" },
    "×": { zh: "×", en: "×" },
    "-": { zh: "-", en: "-" },
    "+": { zh: "+", en: "+" },
    "=": { zh: "=", en: "=" },
    "00": { zh: "00", en: "00" },
    "0": { zh: "0", en: "0" },
    "1": { zh: "1", en: "1" },
    "2": { zh: "2", en: "2" },
    "3": { zh: "3", en: "3" },
    "4": { zh: "4", en: "4" },
    "5": { zh: "5", en: "5" },
    "6": { zh: "6", en: "6" },
    "7": { zh: "7", en: "7" },
    "8": { zh: "8", en: "8" },
    "9": { zh: "9", en: "9" },
    ".": { zh: ".", en: "." },
    
    // 其他遗漏的文本
    "实用网站": { zh: "实用网站", en: "Useful Websites" },
    "浅色模式": { zh: "浅色模式", en: "Light Mode" },
    "深色模式": { zh: "深色模式", en: "Dark Mode" },
    "中文": { zh: "中文", en: "Chinese" },
    "English": { zh: "English", en: "English" },
    "主题模式": { zh: "主题模式", en: "Theme Mode" },
    "自动定位": { zh: "自动定位", en: "Auto Location" },
    "或手动选择城市": { zh: "或手动选择城市", en: "Or select city manually" },
    "删除": { zh: "删除", en: "Delete" },
    "省份筛选": { zh: "省份筛选", en: "Filter by Province" },
    "选择城市": { zh: "选择城市", en: "Select City" },
    "全部省份": { zh: "全部省份", en: "All Provinces" },
    "北京市": { zh: "北京市", en: "Beijing" },
    "上海市": { zh: "上海市", en: "Shanghai" },
    "天津市": { zh: "天津市", en: "Tianjin" },
    "重庆市": { zh: "重庆市", en: "Chongqing" },
    "广东省": { zh: "广东省", en: "Guangdong" },
    "江苏省": { zh: "江苏省", en: "Jiangsu" },
    "浙江省": { zh: "浙江省", en: "Zhejiang" },
    "山东省": { zh: "山东省", en: "Shandong" },
    "四川省": { zh: "四川省", en: "Sichuan" },
    "湖北省": { zh: "湖北省", en: "Hubei" },
    "福建省": { zh: "福建省", en: "Fujian" },
    "辽宁省": { zh: "辽宁省", en: "Liaoning" },
    "陕西省": { zh: "陕西省", en: "Shaanxi" },
    "河南省": { zh: "河南省", en: "Henan" },
    "河北省": { zh: "河北省", en: "Hebei" },
    "湖南省": { zh: "湖南省", en: "Hunan" },
    "安徽省": { zh: "安徽省", en: "Anhui" },
    "江西省": { zh: "江西省", en: "Jiangxi" },
    "广西": { zh: "广西", en: "Guangxi" },
    "云南省": { zh: "云南省", en: "Yunnan" },
    "国际城市": { zh: "国际城市", en: "International" },
    "纽约": { zh: "纽约", en: "New York" },
    "伦敦": { zh: "伦敦", en: "London" },
    "巴黎": { zh: "巴黎", en: "Paris" },
    "东京": { zh: "东京", en: "Tokyo" },
    "首尔": { zh: "首尔", en: "Seoul" },
    "新加坡": { zh: "新加坡", en: "Singapore" },
    "悉尼": { zh: "悉尼", en: "Sydney" },
    "多伦多": { zh: "多伦多", en: "Toronto" },
    "广州市": { zh: "广州市", en: "Guangzhou" },
    "深圳市": { zh: "深圳市", en: "Shenzhen" },
    "东莞市": { zh: "东莞市", en: "Dongguan" },
    "佛山市": { zh: "佛山市", en: "Foshan" },
    "中山市": { zh: "中山市", en: "Zhongshan" },
    "珠海市": { zh: "珠海市", en: "Zhuhai" },
    "惠州市": { zh: "惠州市", en: "Huizhou" },
    "江门市": { zh: "江门市", en: "Jiangmen" },
    "南京市": { zh: "南京市", en: "Nanjing" },
    "苏州市": { zh: "苏州市", en: "Suzhou" },
    "无锡市": { zh: "无锡市", en: "Wuxi" },
    "常州市": { zh: "常州市", en: "Changzhou" },
    "徐州市": { zh: "徐州市", en: "Xuzhou" },
    "南通市": { zh: "南通市", en: "Nantong" },
    "扬州市": { zh: "扬州市", en: "Yangzhou" },
    "杭州市": { zh: "杭州市", en: "Hangzhou" },
    "宁波市": { zh: "宁波市", en: "Ningbo" },
    "温州市": { zh: "温州市", en: "Wenzhou" },
    "嘉兴市": { zh: "嘉兴市", en: "Jiaxing" },
    "湖州市": { zh: "湖州市", en: "Huzhou" },
    "德清县": { zh: "德清县", en: "Deqing" },
    "绍兴市": { zh: "绍兴市", en: "Shaoxing" },
    "金华市": { zh: "金华市", en: "Jinhua" },
    "台州市": { zh: "台州市", en: "Taizhou" },
    "济南市": { zh: "济南市", en: "Jinan" },
    "青岛市": { zh: "青岛市", en: "Qingdao" },
    "烟台市": { zh: "烟台市", en: "Yantai" },
    "潍坊市": { zh: "潍坊市", en: "Weifang" },
    "临沂市": { zh: "临沂市", en: "Linyi" },
    "淄博市": { zh: "淄博市", en: "Zibo" },
    "成都市": { zh: "成都市", en: "Chengdu" },
    "绵阳市": { zh: "绵阳市", en: "Mianyang" },
    "德阳市": { zh: "德阳市", en: "Deyang" },
    "南充市": { zh: "南充市", en: "Nanchong" },
    "宜宾市": { zh: "宜宾市", en: "Yibin" },
    "武汉市": { zh: "武汉市", en: "Wuhan" },
    "宜昌市": { zh: "宜昌市", en: "Yichang" },
    "襄阳市": { zh: "襄阳市", en: "Xiangyang" },
    "荆州市": { zh: "荆州市", en: "Jingzhou" },
    "福州市": { zh: "福州市", en: "Fuzhou" },
    "厦门市": { zh: "厦门市", en: "Xiamen" },
    "泉州市": { zh: "泉州市", en: "Quanzhou" },
    "漳州市": { zh: "漳州市", en: "Zhangzhou" },
    "沈阳市": { zh: "沈阳市", en: "Shenyang" },
    "大连市": { zh: "大连市", en: "Dalian" },
    "鞍山市": { zh: "鞍山市", en: "Anshan" },
    "西安市": { zh: "西安市", en: "Xi'an" },
    "宝鸡市": { zh: "宝鸡市", en: "Baoji" },
    "咸阳市": { zh: "咸阳市", en: "Xianyang" },
    "郑州市": { zh: "郑州市", en: "Zhengzhou" },
    "洛阳市": { zh: "洛阳市", en: "Luoyang" },
    "开封市": { zh: "开封市", en: "Kaifeng" },
    "石家庄市": { zh: "石家庄市", en: "Shijiazhuang" },
    "唐山市": { zh: "唐山市", en: "Tangshan" },
    "保定市": { zh: "保定市", en: "Baoding" },
    "长沙市": { zh: "长沙市", en: "Changsha" },
    "株洲市": { zh: "株洲市", en: "Zhuzhou" },
    "湘潭市": { zh: "湘潭市", en: "Xiangtan" },
    "合肥市": { zh: "合肥市", en: "Hefei" },
    "芜湖市": { zh: "芜湖市", en: "Wuhu" },
    "蚌埠市": { zh: "蚌埠市", en: "Bengbu" },
    "南昌市": { zh: "南昌市", en: "Nanchang" },
    "赣州市": { zh: "赣州市", en: "Ganzhou" },
    "九江市": { zh: "九江市", en: "Jiujiang" },
    "南宁市": { zh: "南宁市", en: "Nanning" },
    "桂林市": { zh: "桂林市", en: "Guilin" },
    "柳州市": { zh: "柳州市", en: "Liuzhou" },
    "昆明市": { zh: "昆明市", en: "Kunming" },
    "大理市": { zh: "大理市", en: "Dali" },
    "丽江市": { zh: "丽江市", en: "Lijiang" },
    
    // 登录和数据管理相关
    "账户管理": { zh: "账户管理", en: "Account Management" },
    "登录后可同步设置到云端": { zh: "登录后可同步设置到云端", en: "Login to sync settings to cloud" },
    "手机号登录": { zh: "手机号登录", en: "Sign in with Phone" },
    "登录账户": { zh: "登录账户", en: "Login Account" },
    "Microsoft 登录": { zh: "Microsoft 登录", en: "Sign in with Microsoft" },
    "Google 登录": { zh: "Google 登录", en: "Sign in with Google" },
    "GitHub 登录": { zh: "GitHub 登录", en: "Sign in with GitHub" },
    "不登录不会限制任何功能": { zh: "不登录不会限制任何功能", en: "No features restricted without login" },
    "同步设置": { zh: "同步设置", en: "Sync Settings" },
    "退出登录": { zh: "退出登录", en: "Sign Out" },
    "数据管理": { zh: "数据管理", en: "Data Management" },
    "Cookie 管理": { zh: "Cookie 管理", en: "Cookie Management" },
    "清除所有保存的设置和数据": { zh: "清除所有保存的设置和数据", en: "Clear all saved settings and data" },
    "查看数据": { zh: "查看数据", en: "View Data" },
    "清除所有数据": { zh: "清除所有数据", en: "Clear All Data" },
    "数据导入导出": { zh: "数据导入导出", en: "Import/Export Data" },
    "备份和恢复您的设置": { zh: "备份和恢复您的设置", en: "Backup and restore your settings" },
    "导出设置": { zh: "导出设置", en: "Export Settings" },
    "导入设置": { zh: "导入设置", en: "Import Settings" },
    "快速登录": { zh: "快速登录", en: "Quick Login" },
    "网站名称": { zh: "网站名称", en: "Website Name" },
    "网站描述": { zh: "网站描述", en: "Website Description" },
    "网站网址（https://...）": { zh: "网站网址（https://...）", en: "Website URL (https://...)" },
    "网站图标（正方形png/jpg/ico，建议64x64）：": { zh: "网站图标（正方形png/jpg/ico，建议64x64）：", en: "Website Icon (square png/jpg/ico, 64x64 recommended):" },
    "取消": { zh: "取消", en: "Cancel" },
    "保存": { zh: "保存", en: "Save" },
    "正在请求位置权限...": { zh: "正在请求位置权限...", en: "Requesting location permission..." },
    "位置检测成功": { zh: "位置检测成功", en: "Location detected" },
    "无法获取位置，使用北京": { zh: "无法获取位置，使用北京", en: "Unable to get location, using Beijing" },
    "位置权限被拒绝": { zh: "位置权限被拒绝", en: "Location permission denied" },
    "浏览器不支持地理定位": { zh: "浏览器不支持地理定位", en: "Geolocation not supported" },
    "位置信息不可用": { zh: "位置信息不可用", en: "Location unavailable" },
    "定位请求超时": { zh: "定位请求超时", en: "Location request timeout" },
    "已自动调整省份筛选": { zh: "已自动调整省份筛选", en: "Province filter auto-adjusted" },
    "您选择的城市不在此省份中，已显示该省份第一个城市。": { zh: "您选择的城市不在此省份中，已显示该省份第一个城市。", en: "Your selected city is not in this province. Showing first available city." },
    "当前城市": { zh: "当前城市", en: "Current City" },
    "在设置中可更换城市": { zh: "在设置中可更换城市", en: "Change city in settings" },
    "阮铭泽工具箱 v0.0.1-beta1.5 - 成长中的工具箱，未来会更加强大！": { zh: "阮铭泽工具箱 v0.0.1-beta1.5 - 成长中的工具箱，未来会更加强大！", en: "Ryan's Toolbox v0.0.1-beta1.5 - A growing toolbox that will become more powerful in the future!" },
    "联系邮箱: ruanmingze2016@gmail.com | xmt20160124@outlook.com": { zh: "联系邮箱: ruanmingze2016@gmail.com | xmt20160124@outlook.com", en: "Contact email: ruanmingze2016@gmail.com | xmt20160124@outlook.com" },
    "输入您要查询的系统知识...": { zh: "输入您要查询的系统知识...", en: "Enter the system knowledge you want to query..." },
    "主题模式": { zh: "主题模式", en: "Theme Mode" },
    "游客": { zh: "游客", en: "Guest" },
    "云端服务器": { zh: "云端服务器", en: "Cloud Server" },
    "阮铭泽工具箱": { zh: "阮铭泽工具箱", en: "Ryan's Toolbox" },
    "仓库": { zh: "仓库", en: "Repositories" },
    "关注者": { zh: "关注者", en: "Followers" },
    "关注中": { zh: "关注中", en: "Following" },
    "游客账户，用于体验工具箱的完整登录功能和用户信息显示。": { zh: "游客账户，用于体验工具箱的完整登录功能和用户信息显示。", en: "Guest account for experiencing the full login features and user information display of the toolbox." },
    "游客模式：体验数据，无需OAuth配置": { zh: "游客模式：体验数据，无需OAuth配置", en: "Guest mode: Experience data, no OAuth configuration required" },
    "2023/1/1加入": { zh: "2023/1/1加入", en: "Joined on 2023/1/1" },
    "快速登录成功！欢迎，游客": { zh: "快速登录成功！欢迎，游客", en: "Quick login successful! Welcome, Guest" },
    "以游客身份体验所有功能。": { zh: "以游客身份体验所有功能。", en: "Experience all features as a guest." },
    "快速登录失败：": { zh: "快速登录失败：", en: "Quick login failed: " },
    "视觉特效即将开始！可能导致轻微眩晕。\n继续吗？": { zh: "视觉特效即将开始！可能导致轻微眩晕。\n继续吗？", en: "Visual effects ahead! May cause mild dizziness.\nContinue?" },
    "特效结束！": { zh: "特效结束！", en: "Effect ended!" },
    "存储数据信息：": { zh: "存储数据信息：", en: "Stored Data Information:" },
    "Cookie数据：": { zh: "Cookie数据：", en: "Cookie Data:" },
    "本地存储：": { zh: "本地存储：", en: "Local Storage:" },
    "主要数据：": { zh: "主要数据：", en: "Main Data:" },
    "无法读取数据信息": { zh: "无法读取数据信息", en: "Unable to read data information" },
    "确定要清除所有数据吗？\n这将重置所有设置为默认值。": { zh: "确定要清除所有数据吗？\n这将重置所有设置为默认值。", en: "Are you sure you want to clear all data?\nThis will reset all settings to default." },
    "所有数据清除成功！\n页面将重新加载以应用更改。": { zh: "所有数据清除成功！\n页面将重新加载以应用更改。", en: "All data cleared successfully!\nPage will reload to apply changes." },
    "清除数据失败：": { zh: "清除数据失败：", en: "Failed to clear data: " },
    "设置导出成功！": { zh: "设置导出成功！", en: "Settings exported successfully!" },
    "导出失败：": { zh: "导出失败：", en: "Export failed: " },
    "导入设置": { zh: "导入设置", en: "Import Settings" },
    "导入来自": { zh: "导入来自", en: "Import from " },
    "的设置？\n这将覆盖当前设置。": { zh: "的设置？\n这将覆盖当前设置。", en: "'s settings?\nThis will overwrite current settings." },
    "设置导入成功！": { zh: "设置导入成功！", en: "Settings imported successfully!" },
    "导入失败：文件格式无效": { zh: "导入失败：文件格式无效", en: "Import failed: Invalid file format" },
    "正在搜索...": { zh: "正在搜索...", en: "Searching..." },
    "无结果": { zh: "无结果", en: "No results" },
    "搜索失败": { zh: "搜索失败", en: "Search failed" },
    "今日": { zh: "今日", en: "Today" },
    "修改头像": { zh: "修改头像", en: "Change Avatar" }
};

function switchLanguage(lang) {
    // 第一步：翻译所有带data-lang属性的元素
    document.querySelectorAll('[data-lang]').forEach(el => {
        const key = el.getAttribute('data-lang');
        if (langDict[key]) {
            el.textContent = langDict[key][lang];
        }
    });
    
    // 第二步：翻译工具箱标题
    const toolboxTitle = document.querySelector('nav div[style*="font-weight: 700"]');
    if (toolboxTitle && langDict["阮铭泽工具箱"]) {
        toolboxTitle.textContent = langDict["阮铭泽工具箱"][lang];
    }
    
    // 第三步：翻译下拉选择器的选项
    const selects = document.querySelectorAll('select');
    selects.forEach(select => {
        Array.from(select.options).forEach(option => {
            const key = option.textContent.trim();
            if (langDict[key]) {
                option.textContent = langDict[key][lang];
            }
        });
    });
    
    // 第四步：翻译所有可能的文本元素
    const textElements = document.querySelectorAll('.tool-title, .tool-desc, .tool-link, .resource-name, .result-title, .result-item div, .card-title span, .weather-label, .weather-value, .system-news, .system-news div');
    textElements.forEach(el => {
        const key = el.textContent.trim();
        if (langDict[key]) {
            el.textContent = langDict[key][lang];
        }
    });
    
    // 翻译系统公告中的固定文本
    const systemNewsElements = document.querySelectorAll('.system-news');
    systemNewsElements.forEach(el => {
        // 处理包含多个文本节点的情况
        const childNodes = el.childNodes;
        childNodes.forEach(node => {
            if (node.nodeType === Node.TEXT_NODE) {
                const key = node.textContent.trim();
                if (key && langDict[key]) {
                    node.textContent = langDict[key][lang];
                }
            }
        });
        
        // 处理子元素
        const divElements = el.querySelectorAll('div');
        divElements.forEach(div => {
            const key = div.textContent.trim();
            if (key && langDict[key]) {
                div.textContent = langDict[key][lang];
            }
        });
    });
    
    // 翻译输入框的占位符
    const inputElements = document.querySelectorAll('[data-lang-placeholder]');
    inputElements.forEach(el => {
        const key = el.getAttribute('data-lang-placeholder');
        if (langDict[key]) {
            el.placeholder = langDict[key][lang];
        }
    });
    
    // 翻译城市显示文本
    const cityLabelElements = document.querySelectorAll('span[data-lang="当前城市"]');
    cityLabelElements.forEach(el => {
        if (langDict["当前城市"]) {
            el.textContent = langDict["当前城市"][lang] + "：";
        }
    });
    
    // 翻译计算器按钮
    const calcKeys = document.querySelectorAll('.calc-key');
    calcKeys.forEach(el => {
        const key = el.textContent.trim();
        if (langDict[key]) {
            el.textContent = langDict[key][lang];
        }
    });
    
    // 翻译日历星期标题
    const calendarWeekdays = document.querySelectorAll('.calendar-weekday');
    calendarWeekdays.forEach(el => {
        const key = el.textContent.trim();
        if (langDict[key]) {
            el.textContent = langDict[key][lang];
        }
    });
    
    // 翻译月份标题
    const currentMonthEl = document.getElementById('currentMonth');
    if (currentMonthEl) {
        const key = currentMonthEl.textContent.trim();
        if (langDict[key]) {
            currentMonthEl.textContent = langDict[key][lang];
        }
    }
    
    // 翻译省份筛选器选项
    const provinceSelect = document.getElementById('provinceSelect');
    if (provinceSelect) {
        Array.from(provinceSelect.options).forEach(option => {
            const key = option.textContent.trim();
            if (langDict[key]) {
                option.textContent = langDict[key][lang];
            }
        });
    }
    
    // 翻译城市选择器选项
    const citySelect = document.getElementById('citySelect');
    if (citySelect) {
        Array.from(citySelect.options).forEach(option => {
            const key = option.textContent.trim();
            if (langDict[key]) {
                option.textContent = langDict[key][lang];
            }
        });
    }
    
    // 翻译网站列表中的删除按钮
    const deleteButtons = document.querySelectorAll('.delete-btn');
    deleteButtons.forEach(btn => {
        if (langDict["删除"]) {
            btn.textContent = langDict["删除"][lang];
        }
    });
    
    // 翻译添加网站表单中的标签
    const formLabels = document.querySelectorAll('#websiteForm label');
    formLabels.forEach(label => {
        const key = label.textContent.trim();
        if (langDict[key]) {
            label.textContent = langDict[key][lang];
        }
    });
    
    // 翻译表单按钮
    const formButtons = document.querySelectorAll('#websiteForm button');
    formButtons.forEach(button => {
        const key = button.textContent.trim();
        if (langDict[key]) {
            button.textContent = langDict[key][lang];
        }
    });
    
    // 第五步：更新当前语言设置
    const languageSelect = document.getElementById('languageSelect');
    if (languageSelect) {
        languageSelect.value = lang;
    }
}

// 更新当前城市显示和天气 - 完善版本
function updateCurrentCity(cityValue) {
    const currentLang = getCookie("language") || "zh";
    
    // 从数据库中获取城市名称
    const allCities = getAllCities();
    const cityData = allCities.find(city => city.value === cityValue);
    
    // 更新主页城市显示
    const currentCityDisplay = document.getElementById('currentCityDisplay');
    if (currentCityDisplay && cityData) {
        // 根据语言显示不同的城市名称
        let displayName = cityData.name;
        if (currentLang === 'en') {
            // 对于国际城市，显示英文名称
            if (cityValue === 'newyork') displayName = 'New York';
            else if (cityValue === 'london') displayName = 'London';
            else if (cityValue === 'paris') displayName = 'Paris';
            else if (cityValue === 'tokyo') displayName = 'Tokyo';
            else if (cityValue === 'seoul') displayName = 'Seoul';
            else if (cityValue === 'singapore') displayName = 'Singapore';
            else if (cityValue === 'sydney') displayName = 'Sydney';
            else if (cityValue === 'toronto') displayName = 'Toronto';
            // 对于中国城市，显示拼音
            else if (cityValue === 'beijing') displayName = 'Beijing';
            else if (cityValue === 'shanghai') displayName = 'Shanghai';
            else if (cityValue === 'guangzhou') displayName = 'Guangzhou';
            else if (cityValue === 'shenzhen') displayName = 'Shenzhen';
            else if (cityValue === 'hangzhou') displayName = 'Hangzhou';
            else if (cityValue === 'nanjing') displayName = 'Nanjing';
            else if (cityValue === 'chengdu') displayName = 'Chengdu';
            else if (cityValue === 'wuhan') displayName = 'Wuhan';
            else if (cityValue === 'xian') displayName = "Xi'an";
            else if (cityValue === 'deqing') displayName = 'Deqing';
            // 其他城市使用中文名称
        }
        currentCityDisplay.textContent = displayName;
    }
    
    // 更新天气显示，使用缓存功能
    updateWeatherWithCache(cityValue);
}

// 缓存天气数据，避免刷新时重新获取
let weatherCache = {};
let lastCity = null;
let lastUpdateTime = 0;
const CACHE_DURATION = 5 * 60 * 1000; // 5分钟缓存

// 更新天气显示，带缓存功能
function updateWeatherWithCache(cityValue) {
    const now = Date.now();
    
    // 检查是否有缓存数据且未过期
    if (lastCity === cityValue && 
        weatherCache[cityValue] && 
        (now - lastUpdateTime) < CACHE_DURATION) {
        // 使用缓存数据更新显示
        updateWeatherDisplay(weatherCache[cityValue]);
        return;
    }
    
    // 否则获取新数据
    updateWeather(cityValue);
}

// 获取真实天气数据
async function updateWeather(cityValue) {
    try {
        // 根据城市值获取城市信息
        const allCities = getAllCities();
        const cityData = allCities.find(city => city.value === cityValue);
        
        if (!cityData || !cityData.coords) {
            // 如果没有坐标信息，使用随机天气
            updateWeatherWithRandomData();
            return;
        }
        
        const { lat, lon } = cityData.coords;
        
        // 使用和风天气API获取天气数据，确保返回中文数据
        // 使用免费的和风天气API密钥
        const apiKey = 'YOUR_VALID_API_KEY_HERE';
        const url = `https://devapi.qweather.com/v7/weather/now?location=${lon},${lat}&key=${apiKey}&lang=zh`;
        
        // 添加请求头，确保返回中文数据
        const headers = {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        };
        
        // 添加加载状态
        const weatherItems = document.querySelectorAll('.weather-item');
        weatherItems.forEach(item => {
            const tempElement = item.querySelector('.temp');
            if (tempElement) {
                tempElement.textContent = '...';
            }
        });
        
        const response = await fetch(url, { headers });
        const data = await response.json();
        
        if (data.code === '200') {
            // 缓存天气数据
            weatherCache[cityValue] = data.now;
            lastCity = cityValue;
            lastUpdateTime = Date.now();
            
            // 更新天气显示
            updateWeatherDisplay(data.now);
        } else {
            // 如果API调用失败，使用随机天气
            updateWeatherWithRandomData();
        }
    } catch (error) {
        console.error('获取天气数据失败:', error);
        // 如果API调用失败，使用随机天气
        updateWeatherWithRandomData();
    }
}

// 更新天气显示
function updateWeatherDisplay(weatherData) {
    // 获取所有天气元素
    const weatherItems = document.querySelectorAll('.weather-item');
    
    if (weatherItems.length >= 4) {
        // 更新当前温度
        const tempElement = weatherItems[0].querySelector('.temp');
        const weatherIcon = weatherItems[0].querySelector('.weather-icon');
        const weatherValue = weatherItems[0].querySelector('.weather-value');
        
        if (tempElement && weatherIcon && weatherValue) {
            tempElement.textContent = `${weatherData.temp}°C`;
            
            // 根据天气状况设置图标
            const weatherType = getWeatherIconClass(weatherData.icon);
            weatherIcon.className = weatherType;
            
            // 设置天气描述
            weatherValue.textContent = weatherData.text;
        }
        
        // 更新体感温度
        const feelTempElement = weatherItems[1].querySelector('.temp');
        const feelValue = weatherItems[1].querySelector('.weather-value');
        
        if (feelTempElement && feelValue) {
            feelTempElement.textContent = `${weatherData.feelsLike}°C`;
            feelValue.textContent = getFeelDescription(weatherData.feelsLike);
        }
        
        // 更新湿度
        const humidityElement = weatherItems[2].querySelector('.temp');
        const humidityIcon = weatherItems[2].querySelector('.weather-icon');
        const humidityValue = weatherItems[2].querySelector('.weather-value');
        
        if (humidityElement && humidityIcon && humidityValue) {
            humidityElement.textContent = `${weatherData.humidity}%`;
            humidityValue.textContent = getHumidityDescription(weatherData.humidity);
        }
        
        // 更新风速
        const windElement = weatherItems[3].querySelector('.temp');
        const windIcon = weatherItems[3].querySelector('.weather-icon');
        const windValue = weatherItems[3].querySelector('.weather-value');
        
        if (windElement && windIcon && windValue) {
            windElement.textContent = weatherData.windSpeed;
            windValue.textContent = `${weatherData.windDir}风`;
        }
    }
}

// 使用随机数据更新天气（备用方案）
function updateWeatherWithRandomData() {
    // 获取所有天气元素
    const weatherItems = document.querySelectorAll('.weather-item');
    
    if (weatherItems.length >= 4) {
        // 生成随机温度
        const temp = Math.floor(Math.random() * 35) + 5; // 5-40度
        
        // 更新当前温度
        const tempElement = weatherItems[0].querySelector('.temp');
        const weatherIcon = weatherItems[0].querySelector('.weather-icon');
        const weatherValue = weatherItems[0].querySelector('.weather-value');
        
        if (tempElement && weatherIcon && weatherValue) {
            tempElement.textContent = `${temp}°C`;
            
            // 根据温度设置图标
            if (temp > 30) {
                weatherIcon.className = "fas fa-sun weather-icon";
                weatherValue.textContent = "炎热";
            } else if (temp > 25) {
                weatherIcon.className = "fas fa-sun weather-icon";
                weatherValue.textContent = "热";
            } else if (temp > 20) {
                weatherIcon.className = "fas fa-cloud-sun weather-icon";
                weatherValue.textContent = "温暖";
            } else if (temp > 15) {
                weatherIcon.className = "fas fa-cloud-sun weather-icon";
                weatherValue.textContent = "舒适";
            } else if (temp > 10) {
                weatherIcon.className = "fas fa-cloud weather-icon";
                weatherValue.textContent = "凉爽";
            } else if (temp > 5) {
                weatherIcon.className = "fas fa-cloud weather-icon";
                weatherValue.textContent = "冷";
            } else {
                weatherIcon.className = "fas fa-snowflake weather-icon";
                weatherValue.textContent = "寒冷";
            }
        }
        
        // 更新体感温度
        const feelTempElement = weatherItems[1].querySelector('.temp');
        const feelValue = weatherItems[1].querySelector('.weather-value');
        
        if (feelTempElement && feelValue) {
            const feelTemp = temp + Math.floor(Math.random() * 5) - 2; // ±2度波动
            feelTempElement.textContent = `${feelTemp}°C`;
            feelValue.textContent = getFeelDescription(feelTemp);
        }
        
        // 更新湿度
        const humidityElement = weatherItems[2].querySelector('.temp');
        const humidityIcon = weatherItems[2].querySelector('.weather-icon');
        const humidityValue = weatherItems[2].querySelector('.weather-value');
        
        if (humidityElement && humidityIcon && humidityValue) {
            const humidity = Math.floor(Math.random() * 60) + 30; // 30-90%
            humidityElement.textContent = `${humidity}%`;
            humidityIcon.className = "fas fa-tint weather-icon";
            humidityValue.textContent = getHumidityDescription(humidity);
        }
        
        // 更新风速
        const windElement = weatherItems[3].querySelector('.temp');
        const windIcon = weatherItems[3].querySelector('.weather-icon');
        const windValue = weatherItems[3].querySelector('.weather-value');
        
        if (windElement && windIcon && windValue) {
            const windSpeed = (Math.random() * 10).toFixed(1); // 0-10 m/s
            windElement.textContent = windSpeed;
            windIcon.className = "fas fa-wind weather-icon";
            windValue.textContent = getWindDirection();
        }
    }
}

// 获取天气图标类名
function getWeatherIconClass(iconCode) {
    // 和风天气图标代码映射
    const iconMap = {
        '100': 'fas fa-sun weather-icon', // 晴
        '101': 'fas fa-cloud-sun weather-icon', // 多云
        '102': 'fas fa-cloud weather-icon', // 少云
        '103': 'fas fa-cloud-sun weather-icon', // 晴间多云
        '104': 'fas fa-cloud weather-icon', // 阴
        '200': 'fas fa-wind weather-icon', // 有风
        '201': 'fas fa-wind weather-icon', // 平静
        '202': 'fas fa-wind weather-icon', // 微风
        '203': 'fas fa-wind weather-icon', // 和风
        '204': 'fas fa-wind weather-icon', // 清风
        '205': 'fas fa-wind weather-icon', // 强风/劲风
        '206': 'fas fa-wind weather-icon', // 疾风
        '207': 'fas fa-wind weather-icon', // 大风
        '208': 'fas fa-wind weather-icon', // 烈风
        '209': 'fas fa-wind weather-icon', // 风暴
        '210': 'fas fa-wind weather-icon', // 狂爆风
        '211': 'fas fa-wind weather-icon', // 飓风
        '212': 'fas fa-wind weather-icon', // 龙卷风
        '213': 'fas fa-wind weather-icon', // 热带风暴
        '300': 'fas fa-tint weather-icon', // 阵雨
        '301': 'fas fa-tint weather-icon', // 强阵雨
        '302': 'fas fa-bolt weather-icon', // 雷阵雨
        '303': 'fas fa-bolt weather-icon', // 强雷阵雨
        '304': 'fas fa-bolt weather-icon', // 雷阵雨伴有冰雹
        '305': 'fas fa-tint weather-icon', // 小雨
        '306': 'fas fa-tint weather-icon', // 中雨
        '307': 'fas fa-tint weather-icon', // 大雨
        '308': 'fas fa-tint weather-icon', // 极端降雨
        '309': 'fas fa-tint weather-icon', // 毛毛雨/细雨
        '310': 'fas fa-tint weather-icon', // 暴雨
        '311': 'fas fa-tint weather-icon', // 大暴雨
        '312': 'fas fa-tint weather-icon', // 特大暴雨
        '313': 'fas fa-tint weather-icon', // 冻雨
        '314': 'fas fa-tint weather-icon', // 小到中雨
        '315': 'fas fa-tint weather-icon', // 中到大雨
        '316': 'fas fa-tint weather-icon', // 大到暴雨
        '317': 'fas fa-tint weather-icon', // 暴雨到大暴雨
        '318': 'fas fa-tint weather-icon', // 大暴雨到特大暴雨
        '399': 'fas fa-tint weather-icon', // 雨
        '400': 'fas fa-snowflake weather-icon', // 小雪
        '401': 'fas fa-snowflake weather-icon', // 中雪
        '402': 'fas fa-snowflake weather-icon', // 大雪
        '403': 'fas fa-snowflake weather-icon', // 暴雪
        '404': 'fas fa-snowflake weather-icon', // 雨夹雪
        '405': 'fas fa-snowflake weather-icon', // 雨雪天气
        '406': 'fas fa-snowflake weather-icon', // 阵雨夹雪
        '407': 'fas fa-snowflake weather-icon', // 阵雪
        '408': 'fas fa-snowflake weather-icon', // 小到中雪
        '409': 'fas fa-snowflake weather-icon', // 中到大雪
        '410': 'fas fa-snowflake weather-icon', // 大到暴雪
        '499': 'fas fa-snowflake weather-icon', // 雪
        '500': 'fas fa-smog weather-icon', // 薄雾
        '501': 'fas fa-smog weather-icon', // 雾
        '502': 'fas fa-smog weather-icon', // 霾
        '503': 'fas fa-smog weather-icon', // 扬沙
        '504': 'fas fa-smog weather-icon', // 浮尘
        '507': 'fas fa-smog weather-icon', // 沙尘暴
        '508': 'fas fa-smog weather-icon', // 强沙尘暴
        '509': 'fas fa-smog weather-icon', // 浓雾
        '510': 'fas fa-smog weather-icon', // 强浓雾
        '511': 'fas fa-smog weather-icon', // 中度霾
        '512': 'fas fa-smog weather-icon', // 重度霾
        '513': 'fas fa-smog weather-icon', // 严重霾
        '514': 'fas fa-smog weather-icon', // 大雾
        '515': 'fas fa-smog weather-icon', // 特强浓雾
        '900': 'fas fa-temperature-high weather-icon', // 热
        '901': 'fas fa-temperature-low weather-icon', // 冷
        '999': 'fas fa-question-circle weather-icon' // 未知
    };
    
    return iconMap[iconCode] || 'fas fa-sun weather-icon';
}

// 获取体感描述
function getFeelDescription(temp) {
    if (temp > 35) return '极热';
    if (temp > 30) return '很热';
    if (temp > 25) return '热';
    if (temp > 20) return '温暖';
    if (temp > 15) return '舒适';
    if (temp > 10) return '凉爽';
    if (temp > 5) return '冷';
    return '寒冷';
}

// 获取湿度描述
function getHumidityDescription(humidity) {
    if (humidity > 80) return '潮湿';
    if (humidity > 60) return '湿润';
    if (humidity > 40) return '适中';
    if (humidity > 20) return '干燥';
    return '极干燥';
}

// 获取风向
function getWindDirection() {
    const directions = ['北', '东北', '东', '东南', '南', '西南', '西', '西北'];
    const index = Math.floor(Math.random() * directions.length);
    return `${directions[index]}风`;
}

// 在语言切换后调用
function enhancedSwitchLanguage(lang) {
    switchLanguage(lang);
    updateSelectOptionsLanguage();
    
    // 重新生成城市选项以应用语言变化
    const provinceSelect = document.getElementById('provinceSelect');
    const currentProvince = provinceSelect ? provinceSelect.value : 'all';
    updateCityOptions(currentProvince, true);
    
    // 更新当前城市显示
    const savedCity = getCookie("selectedCity") || "beijing";
    updateCurrentCity(savedCity);
}

            // 初始化应用
            document.addEventListener('DOMContentLoaded', () => {
                // 检查主题Cookie并应用
                const themeCookie = getCookie("theme");
                if (themeCookie) {
                    document.body.classList.toggle('dark-mode', themeCookie === 'dark');
                    document.getElementById('themeSelect').value = themeCookie;
                    
                    // 更新AI聊天区域主题
                    updateAIChatTheme(themeCookie === 'dark');
                }
                
                // 检查语言Cookie并应用 - 使用增强版本
                const languageCookie = getCookie("language");
                if (languageCookie) {
                    enhancedSwitchLanguage(languageCookie);
                } else {
                    // 如果没有设置语言，默认使用中文
                    enhancedSwitchLanguage('zh');
                }
                
                // 初始化登录状态
                initLoginState();
                
                // 检查保存的城市设置
                const savedCity = getCookie("selectedCity") || "beijing";
                const citySelect = document.getElementById('citySelect');
                if (citySelect) {
                    citySelect.value = savedCity;
                }
                updateCurrentCity(savedCity);
                
                // 初始化城市选择器 - 智能初始化
                updateCityOptions('all');
                
                // 设置保存的城市值（延迟确保DOM完全加载）
                setTimeout(() => {
                    const citySelect = document.getElementById('citySelect');
                    const provinceSelect = document.getElementById('provinceSelect');
                    if (citySelect && savedCity) {
                        // 找到保存城市所属的省份
                        let cityProvince = 'all';
                        for (const [provinceKey, cities] of Object.entries(cityDatabase)) {
                            if (cities.find(city => city.value === savedCity)) {
                                cityProvince = provinceKey;
                                break;
                            }
                        }
                        
                        // 如果城市在特定省份中，自动设置省份筛选器
                        if (cityProvince !== 'all' && provinceSelect) {
                            provinceSelect.value = cityProvince;
                            updateCityOptions(cityProvince, true);
                        }
                        
                        // 确保城市选择器有正确的值
                        const cityExists = Array.from(citySelect.options).find(option => option.value === savedCity);
                        if (cityExists) {
                            citySelect.value = savedCity;
                        }
                    }
                }, 100);
            });
            
            // 初始化日历
            initCalendar();
            // 工具按钮事件
            const calcKeys = document.querySelectorAll('.calc-key');
            calcKeys.forEach(key => {
                key.addEventListener('click', () => {
                    const display = document.querySelector('.calc-display');
                    const action = key.textContent;
                    
                    if (action === 'C') {
                        display.value = '0';
                    } else if (action === 'CE') {
                        display.value = display.value.length > 1 ? 
                            display.value.slice(0, -1) : '0';
                    } else if (action === '=') {
                        try {
                            const expr = display.value
                                .replace(/×/g, '*')
                                .replace(/÷/g, '/');
                            display.value = eval(expr);
                        } catch (e) {
                            display.value = '错误';
                        }
                    } else {
                        if (display.value === '0' || display.value === '错误') {
                            display.value = action;
                        } else {
                            display.value += action;
                        }
                    }
                });
            });
            
            // 初始化日历
            initCalendar();
            
            // 主题切换
            const themeSelect = document.getElementById('themeSelect');
            themeSelect.addEventListener('change', function() {
                const themeValue = this.value;
                document.body.classList.toggle('dark-mode', themeValue === 'dark');
                
                // 保存到Cookie，有效期30天
                setCookie("theme", themeValue, 30);
                
                // 更新AI聊天区域样式
                updateAIChatTheme(themeValue === 'dark');
            });
            
            // 更新AI聊天区域主题
            function updateAIChatTheme(isDarkMode) {
                const chatHistory = document.getElementById('chatHistory');
                if (chatHistory) {
                    if (isDarkMode) {
                        chatHistory.style.background = 'rgba(94,114,228,0.1)';
                    } else {
                        chatHistory.style.background = 'rgba(67,97,238,0.05)';
                    }
                }
                
                // 更新所有消息的样式
                const messages = document.querySelectorAll('.message');
                messages.forEach(message => {
                    const contentDiv = message.querySelector('div:nth-child(2)');
                    const messageText = contentDiv ? contentDiv.querySelector('div:nth-child(2)') : null;
                    const senderName = contentDiv ? contentDiv.querySelector('div:nth-child(1)') : null;
                    
                    if (contentDiv) {
                        if (message.classList.contains('ai-message')) {
                            if (isDarkMode) {
                                contentDiv.style.background = 'rgba(94, 114, 228, 0.2)';
                            } else {
                                contentDiv.style.background = 'rgba(67, 97, 238, 0.1)';
                            }
                        } else {
                            if (isDarkMode) {
                                contentDiv.style.background = '#2a2a4a';
                            } else {
                                contentDiv.style.background = 'white';
                            }
                        }
                    }
                    
                    if (messageText) {
                        if (isDarkMode) {
                            messageText.style.color = '#f0f2f5';
                        } else {
                            messageText.style.color = 'var(--text-dark)';
                        }
                    }
                    
                    if (senderName) {
                        if (isDarkMode) {
                            senderName.style.color = '#7c8cfa';
                        } else {
                            senderName.style.color = 'var(--primary-color)';
                        }
                    }
                });
            }
            
            // 语言切换 - 静默保存版本
            const languageSelect = document.getElementById('languageSelect');
            languageSelect.addEventListener('change', function() {
                const langValue = this.value;
                setCookie("language", langValue, 30);
                enhancedSwitchLanguage(langValue);
                
                // 更新城市显示（保证语言切换后城市名称正确）
                const savedCity = getCookie("selectedCity") || "beijing";
                updateCurrentCity(savedCity);
                
                // 静默保存，不再显示提示
            });
            
            // 省份筛选事件 - 智能筛选，保护用户选择
            const provinceSelect = document.getElementById('provinceSelect');
            if (provinceSelect) {
                provinceSelect.addEventListener('change', function() {
                    const selectedProvince = this.value;
                    const currentLang = getCookie("language") || "zh";
                    
                    // 检查当前选择的城市是否在新省份中
                    const currentCity = document.getElementById('citySelect').value;
                    const currentCityData = getAllCities().find(city => city.value === currentCity);
                    
                    // 如果当前城市不在新筛选的省份中，给出提示
                    if (selectedProvince !== 'all' && currentCityData) {
                        const provinceCities = cityDatabase[selectedProvince] || [];
                        const cityInProvince = provinceCities.find(city => city.value === currentCity);
                        
                        if (!cityInProvince) {
                            const message = currentLang === 'en' ? 
                                `Your current city "${currentCityData.name}" is not in the selected province. Do you want to continue filtering?` :
                                `您当前选择的城市 "${currentCityData.name}" 不在所选省份中。是否继续筛选？`;
                            
                            if (!confirm(message)) {
                                // 用户取消，恢复到"全部省份"
                                this.value = 'all';
                                return;
                            }
                        }
                    }
                    
                    // 执行筛选
                    updateCityOptions(selectedProvince, false);
                });
            }
            
            // 城市选择事件 - 静默保存，提升用户体验
            const citySelect = document.getElementById('citySelect');
            if (citySelect) {
                citySelect.addEventListener('change', function() {
                    const selectedCity = this.value;
                    updateCurrentCity(selectedCity);
                    setCookie("selectedCity", selectedCity, 30);
                    
                    // 静默保存，不再显示提示
                });
            }
            
            // 完整的城市数据库 - 按省份分类
            const cityDatabase = {
                beijing: [
                    { value: "beijing", name: "北京市", coords: { lat: 39.9042, lon: 116.4074 } }
                ],
                shanghai: [
                    { value: "shanghai", name: "上海市", coords: { lat: 31.2304, lon: 121.4737 } }
                ],
                tianjin: [
                    { value: "tianjin", name: "天津市", coords: { lat: 39.3434, lon: 117.3616 } }
                ],
                chongqing: [
                    { value: "chongqing", name: "重庆市", coords: { lat: 29.4316, lon: 106.9123 } }
                ],
                guangdong: [
                    { value: "guangzhou", name: "广州市", coords: { lat: 23.1291, lon: 113.2644 } },
                    { value: "shenzhen", name: "深圳市", coords: { lat: 22.5431, lon: 114.0579 } },
                    { value: "dongguan", name: "东莞市", coords: { lat: 23.0489, lon: 113.7447 } },
                    { value: "foshan", name: "佛山市", coords: { lat: 23.0291, lon: 113.1221 } },
                    { value: "zhongshan", name: "中山市", coords: { lat: 22.5171, lon: 113.3927 } },
                    { value: "zhuhai", name: "珠海市", coords: { lat: 22.2711, lon: 113.5767 } },
                    { value: "huizhou", name: "惠州市", coords: { lat: 23.0794, lon: 114.4152 } },
                    { value: "jiangmen", name: "江门市", coords: { lat: 22.5751, lon: 113.0946 } }
                ],
                jiangsu: [
                    { value: "nanjing", name: "南京市", coords: { lat: 32.0603, lon: 118.7969 } },
                    { value: "suzhou", name: "苏州市", coords: { lat: 31.2989, lon: 120.5853 } },
                    { value: "wuxi", name: "无锡市", coords: { lat: 31.4912, lon: 120.3119 } },
                    { value: "changzhou", name: "常州市", coords: { lat: 31.7728, lon: 119.9462 } },
                    { value: "xuzhou", name: "徐州市", coords: { lat: 34.2058, lon: 117.2848 } },
                    { value: "nantong", name: "南通市", coords: { lat: 32.0146, lon: 120.8618 } },
                    { value: "yangzhou", name: "扬州市", coords: { lat: 32.3932, lon: 119.4215 } }
                ],
                zhejiang: [
                    { value: "hangzhou", name: "杭州市", coords: { lat: 30.2741, lon: 120.1551 } },
                    { value: "ningbo", name: "宁波市", coords: { lat: 29.8683, lon: 121.5440 } },
                    { value: "wenzhou", name: "温州市", coords: { lat: 27.9944, lon: 120.6993 } },
                    { value: "jiaxing", name: "嘉兴市", coords: { lat: 30.7469, lon: 120.7505 } },
                    { value: "huzhou", name: "湖州市", coords: { lat: 30.8703, lon: 120.0933 } },
                    { value: "deqing", name: "德清县", coords: { lat: 30.5420, lon: 119.9777 } },
                    { value: "shaoxing", name: "绍兴市", coords: { lat: 30.0023, lon: 120.5810 } },
                    { value: "jinhua", name: "金华市", coords: { lat: 29.1028, lon: 119.6474 } },
                    { value: "taizhou_zj", name: "台州市", coords: { lat: 28.6569, lon: 121.4283 } }
                ],
                shandong: [
                    { value: "jinan", name: "济南市", coords: { lat: 36.6512, lon: 117.1201 } },
                    { value: "qingdao", name: "青岛市", coords: { lat: 36.0986, lon: 120.3719 } },
                    { value: "yantai", name: "烟台市", coords: { lat: 37.4638, lon: 121.4478 } },
                    { value: "weifang", name: "潍坊市", coords: { lat: 36.7062, lon: 119.1619 } },
                    { value: "linyi", name: "临沂市", coords: { lat: 35.1040, lon: 118.3564 } },
                    { value: "zibo", name: "淄博市", coords: { lat: 36.8133, lon: 118.0548 } }
                ],
                sichuan: [
                    { value: "chengdu", name: "成都市", coords: { lat: 30.5728, lon: 104.0668 } },
                    { value: "mianyang", name: "绵阳市", coords: { lat: 31.4678, lon: 104.6794 } },
                    { value: "deyang", name: "德阳市", coords: { lat: 31.1270, lon: 104.3982 } },
                    { value: "nanchong", name: "南充市", coords: { lat: 30.7953, lon: 106.0847 } },
                    { value: "yibin", name: "宜宾市", coords: { lat: 28.7519, lon: 104.6308 } }
                ],
                hubei: [
                    { value: "wuhan", name: "武汉市", coords: { lat: 30.5928, lon: 114.3055 } },
                    { value: "yichang", name: "宜昌市", coords: { lat: 30.7026, lon: 111.2900 } },
                    { value: "xiangyang", name: "襄阳市", coords: { lat: 32.0424, lon: 112.1226 } },
                    { value: "jingzhou", name: "荆州市", coords: { lat: 30.3269, lon: 112.2384 } }
                ],
                fujian: [
                    { value: "fuzhou", name: "福州市", coords: { lat: 26.0745, lon: 119.2965 } },
                    { value: "xiamen", name: "厦门市", coords: { lat: 24.4798, lon: 118.0894 } },
                    { value: "quanzhou", name: "泉州市", coords: { lat: 24.8741, lon: 118.6758 } },
                    { value: "zhangzhou", name: "漳州市", coords: { lat: 24.5204, lon: 117.6541 } }
                ],
                liaoning: [
                    { value: "shenyang", name: "沈阳市", coords: { lat: 41.8057, lon: 123.4315 } },
                    { value: "dalian", name: "大连市", coords: { lat: 38.9140, lon: 121.6147 } },
                    { value: "anshan", name: "鞍山市", coords: { lat: 41.1087, lon: 122.9944 } }
                ],
                shaanxi: [
                    { value: "xian", name: "西安市", coords: { lat: 34.3416, lon: 108.9398 } },
                    { value: "baoji", name: "宝鸡市", coords: { lat: 34.3610, lon: 107.2372 } },
                    { value: "xianyang", name: "咸阳市", coords: { lat: 34.3292, lon: 108.7093 } }
                ],
                henan: [
                    { value: "zhengzhou", name: "郑州市", coords: { lat: 34.7466, lon: 113.6254 } },
                    { value: "luoyang", name: "洛阳市", coords: { lat: 34.6197, lon: 112.4540 } },
                    { value: "kaifeng", name: "开封市", coords: { lat: 34.7972, lon: 114.3074 } }
                ],
                hebei: [
                    { value: "shijiazhuang", name: "石家庄市", coords: { lat: 38.0428, lon: 114.5149 } },
                    { value: "tangshan", name: "唐山市", coords: { lat: 39.6243, lon: 118.1944 } },
                    { value: "baoding", name: "保定市", coords: { lat: 38.8738, lon: 115.4648 } }
                ],
                hunan: [
                    { value: "changsha", name: "长沙市", coords: { lat: 28.2282, lon: 112.9388 } },
                    { value: "zhuzhou", name: "株洲市", coords: { lat: 27.8274, lon: 113.1513 } },
                    { value: "xiangtan", name: "湘潭市", coords: { lat: 27.8294, lon: 112.9441 } }
                ],
                anhui: [
                    { value: "hefei", name: "合肥市", coords: { lat: 31.8206, lon: 117.2272 } },
                    { value: "wuhu", name: "芜湖市", coords: { lat: 31.3260, lon: 118.3728 } },
                    { value: "bengbu", name: "蚌埠市", coords: { lat: 32.9161, lon: 117.3897 } }
                ],
                jiangxi: [
                    { value: "nanchang", name: "南昌市", coords: { lat: 28.6820, lon: 115.8582 } },
                    { value: "ganzhou", name: "赣州市", coords: { lat: 25.8452, lon: 114.9344 } },
                    { value: "jiujiang", name: "九江市", coords: { lat: 29.7052, lon: 115.9851 } }
                ],
                guangxi: [
                    { value: "nanning", name: "南宁市", coords: { lat: 22.8170, lon: 108.3669 } },
                    { value: "guilin", name: "桂林市", coords: { lat: 25.2342, lon: 110.1789 } },
                    { value: "liuzhou", name: "柳州市", coords: { lat: 24.3146, lon: 109.4281 } }
                ],
                yunnan: [
                    { value: "kunming", name: "昆明市", coords: { lat: 25.0389, lon: 102.7183 } },
                    { value: "dali", name: "大理市", coords: { lat: 25.6067, lon: 100.2670 } },
                    { value: "lijiang", name: "丽江市", coords: { lat: 26.8560, lon: 100.2270 } }
                ],
                international: [
                    { value: "newyork", name: "纽约 New York", coords: { lat: 40.7128, lon: -74.0060 } },
                    { value: "london", name: "伦敦 London", coords: { lat: 51.5074, lon: -0.1278 } },
                    { value: "paris", name: "巴黎 Paris", coords: { lat: 48.8566, lon: 2.3522 } },
                    { value: "tokyo", name: "东京 Tokyo", coords: { lat: 35.6762, lon: 139.6503 } },
                    { value: "seoul", name: "首尔 Seoul", coords: { lat: 37.5665, lon: 126.9780 } },
                    { value: "singapore", name: "新加坡 Singapore", coords: { lat: 1.3521, lon: 103.8198 } },
                    { value: "sydney", name: "悉尼 Sydney", coords: { lat: -33.8688, lon: 151.2093 } },
                    { value: "toronto", name: "多伦多 Toronto", coords: { lat: 43.6532, lon: -79.3832 } }
                ]
            };
            
            // 获取所有城市数据
            function getAllCities() {
                const allCities = [];
                Object.values(cityDatabase).forEach(cities => {
                    allCities.push(...cities);
                });
                return allCities;
            }
            
            // 更新城市选择器 - 优化版本，防止与自动定位冲突
            function updateCityOptions(provinceKey = 'all', preserveAutoLocationCity = false) {
                const citySelect = document.getElementById('citySelect');
                if (!citySelect) return;
                
                // 记录当前选择的城市
                const currentSelectedCity = citySelect.value || getCookie("selectedCity") || "beijing";
                
                citySelect.innerHTML = '';
                
                let citiesToShow = [];
                if (provinceKey === 'all') {
                    citiesToShow = getAllCities();
                } else {
                    citiesToShow = cityDatabase[provinceKey] || [];
                }
                
                citiesToShow.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.value;
                    option.textContent = city.name;
                    citySelect.appendChild(option);
                });
                
                // 智能恢复城市选择：
                // 1. 如果是自动定位设置的城市，优先保持
                // 2. 如果当前城市在新列表中，恢复
                // 3. 否则选择列表第一个
                const savedCity = getCookie("selectedCity") || "beijing";
                const targetCity = preserveAutoLocationCity ? currentSelectedCity : savedCity;
                const cityExists = citiesToShow.find(city => city.value === targetCity);
                
                if (cityExists) {
                    citySelect.value = targetCity;
                    // 只有当选择发生变化时才更新UI和保存
                    if (targetCity !== currentSelectedCity) {
                        updateCurrentCity(targetCity);
                        setCookie("selectedCity", targetCity, 30);
                    }
                } else if (citiesToShow.length > 0) {
                    // 当前城市不在筛选列表中，选择第一个但不自动保存
                    citySelect.value = citiesToShow[0].value;
                    // 显示提示信息而不是直接切换
                    const currentLang = getCookie("language") || "zh";
                    const message = currentLang === 'en' ? 
                        `Your selected city is not in this province. Showing first available city.` :
                        `您选择的城市不在此省份中，已显示该省份第一个城市。`;
                    
                    console.log(message);
                    // 不自动切换，让用户手动选择
                }
            }
            
            // 自动定位功能 - 使用浏览器内置地理位置API，与筛选完美配合
            const autoLocationBtn = document.getElementById('autoLocationBtn');
            if (autoLocationBtn) {
                autoLocationBtn.addEventListener('click', function() {
                    const currentLang = getCookie("language") || "zh";
                    const loadingText = currentLang === 'en' ? 'Requesting location...' : '正在请求位置权限...';
                    const successText = currentLang === 'en' ? 'Location detected' : '位置检测成功';
                    const errorText = currentLang === 'en' ? 'Unable to get location, using Beijing' : '无法获取位置，使用北京';
                    const permissionText = currentLang === 'en' ? 'Location permission denied' : '位置权限被拒绝';
                    
                    // 检查地理位置API支持
                    if (!navigator.geolocation) {
                        alert(currentLang === 'en' ? 'Geolocation not supported' : '浏览器不支持地理定位');
                        return;
                    }
                    
                    // 更新按钮状态
                    const originalHTML = this.innerHTML;
                    this.innerHTML = `<i class="fas fa-spinner fa-spin" style="margin-right: 6px;"></i>${loadingText}`;
                    this.disabled = true;
                    
                    // 请求地理位置
                    navigator.geolocation.getCurrentPosition(
                        // 成功回调
                        function(position) {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            
                            // 根据坐标范围判断可能的城市
                            const detectedCity = detectCityByCoordinates(lat, lon);
                            
                            // 找到检测到的城市所属的省份
                            let detectedProvince = 'all';
                            for (const [provinceKey, cities] of Object.entries(cityDatabase)) {
                                if (cities.find(city => city.value === detectedCity)) {
                                    detectedProvince = provinceKey;
                                    break;
                                }
                            }
                            
                            // 自动切换省份筛选器到检测到的省份
                            const provinceSelect = document.getElementById('provinceSelect');
                            if (provinceSelect && detectedProvince !== 'all') {
                                provinceSelect.value = detectedProvince;
                                // 更新城市列表到对应省份，并保持自动定位的城市
                                updateCityOptions(detectedProvince, true);
                            } else {
                                // 如果没有找到对应省份，显示全部城市
                                if (provinceSelect) provinceSelect.value = 'all';
                                updateCityOptions('all', true);
                            }
                            
                            // 设置检测到的城市
                            const citySelect = document.getElementById('citySelect');
                            if (citySelect) {
                                citySelect.value = detectedCity;
                                updateCurrentCity(detectedCity);
                                setCookie("selectedCity", detectedCity, 30);
                            }
                            
                            // 显示成功消息
                            const allCities = getAllCities();
                            const cityData = allCities.find(city => city.value === detectedCity);
                            const cityName = cityData ? cityData.name : detectedCity;
                            
                            const message = currentLang === 'en' ? 
                                `${successText}: ${cityName}${detectedProvince !== 'all' ? ' (Province filter auto-adjusted)' : ''}` :
                                `${successText}: ${cityName}${detectedProvince !== 'all' ? ' (已自动调整省份筛选)' : ''}`;
                            
                            alert(message);
                            
                            // 恢复按钮状态
                            autoLocationBtn.innerHTML = originalHTML;
                            autoLocationBtn.disabled = false;
                        },
                        // 错误回调
                        function(error) {
                            let message = errorText;
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    message = permissionText;
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    message = currentLang === 'en' ? 'Location unavailable' : '位置信息不可用';
                                    break;
                                case error.TIMEOUT:
                                    message = currentLang === 'en' ? 'Location request timeout' : '定位请求超时';
                                    break;
                            }
                            
                            // 默认使用北京，并调整到对应省份
                            const provinceSelect = document.getElementById('provinceSelect');
                            if (provinceSelect) {
                                provinceSelect.value = 'beijing'; // 北京市
                                updateCityOptions('beijing', true);
                            }
                            
                            const citySelect = document.getElementById('citySelect');
                            if (citySelect) {
                                citySelect.value = 'beijing';
                                updateCurrentCity('beijing');
                                setCookie("selectedCity", 'beijing', 30);
                            }
                            
                            alert(message);
                            
                            // 恢复按钮状态
                            autoLocationBtn.innerHTML = originalHTML;
                            autoLocationBtn.disabled = false;
                        },
                        // 选项
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000 // 5分钟缓存
                        }
                    );
                });
            }
            
            // 根据坐标检测城市（本地化实现）- 更新版本
            function detectCityByCoordinates(lat, lon) {
                const allCities = getAllCities();
                
                // 寻找最接近的城市（基于坐标范围）
                let bestMatch = null;
                let minDistance = Infinity;
                
                allCities.forEach(city => {
                    if (city.coords) {
                        // 计算距离（简化的欧几里得距离）
                        const distance = Math.sqrt(
                            Math.pow(lat - city.coords.lat, 2) + 
                            Math.pow(lon - city.coords.lon, 2)
                        );
                        
                        if (distance < minDistance) {
                            minDistance = distance;
                            bestMatch = city;
                        }
                    }
                });
                
                // 如果找到匹配的城市且距离合理（0.5度范围内）
                if (bestMatch && minDistance < 0.5) {
                    return bestMatch.value;
                }
                
                // 如果没有精确匹配，根据大致地理位置推测
                if (lat >= 20 && lat <= 50 && lon >= 73 && lon <= 135) {
                    // 在中国范围内
                    if (lat >= 39 && lat <= 41 && lon >= 115 && lon <= 118) return 'beijing';
                    if (lat >= 30 && lat <= 32 && lon >= 120 && lon <= 122) return 'shanghai';
                    if (lat >= 22 && lat <= 24 && lon >= 113 && lon <= 115) return 'guangzhou';
                    if (lat >= 30 && lat <= 31 && lon >= 103 && lon <= 105) return 'chengdu';
                    if (lat >= 30 && lat <= 31 && lon >= 114 && lon <= 115) return 'wuhan';
                    return 'beijing'; // 默认
                } else {
                    // 国外位置
                    if (lat >= 40 && lat <= 45 && lon >= -75 && lon <= -70) return 'newyork';
                    if (lat >= 51 && lat <= 52 && lon >= -1 && lon <= 1) return 'london';
                    if (lat >= 48 && lat <= 49 && lon >= 2 && lon <= 3) return 'paris';
                    if (lat >= 35 && lat <= 36 && lon >= 139 && lon <= 140) return 'tokyo';
                    if (lat >= 37 && lat <= 38 && lon >= 126 && lon <= 127) return 'seoul';
                    return 'beijing';
                }
            }
            
            // 添加省份和城市的中英文显示优化
            function updateSelectOptionsLanguage() {
                const currentLang = getCookie("language") || "zh";
                
                // 更新省份选择器
                const provinceSelect = document.getElementById('provinceSelect');
                if (provinceSelect) {
                    Array.from(provinceSelect.options).forEach(option => {
                        const key = option.textContent.trim();
                        if (langDict[key]) {
                            option.textContent = langDict[key][currentLang];
                        }
                    });
                }
                
                // 城市选择器会在updateCityOptions中自动处理语言
            }
            
            // 在语言切换后调用
            function enhancedSwitchLanguage(lang) {
                switchLanguage(lang);
                updateSelectOptionsLanguage();
                
                // 重新生成城市选项以应用语言变化
                const provinceSelect = document.getElementById('provinceSelect');
                const currentProvince = provinceSelect ? provinceSelect.value : 'all';
                updateCityOptions(currentProvince, true);
            }
            
            // 登录系统配置
            const OAUTH_CONFIG = {
                microsoft: {
                    clientId: 'YOUR_MICROSOFT_CLIENT_ID',
                    redirectUri: getOAuthRedirectUri(),
                    scope: 'openid profile email',
                    authUrl: 'https://login.microsoftonline.com/common/oauth2/v2.0/authorize'
                },
                google: {
                    clientId: 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com',
                    redirectUri: getOAuthRedirectUri(),
                    scope: 'openid profile email',
                    authUrl: 'https://accounts.google.com/o/oauth2/v2/auth'
                },
                github: {
                    clientId: 'Ov23lidhvFnKo5MsEpSm', // 已配置的GitHub客户端ID
                    clientSecret: 'd7411678b10c9e1617d715da24c8a14dc2cb1960', // GitHub客户端密钥
                    redirectUri: getOAuthRedirectUri(),
                    scope: 'user:email read:user',
                    authUrl: 'https://github.com/login/oauth/authorize'
                }
            };
            
            // 获取回调URI
            function getOAuthRedirectUri() {
                // 使用 window.location.origin + window.location.pathname 动态生成
                const origin = window.location.origin;
                const pathname = window.location.pathname;
                
                // 如果是本地文件，使用 file:// 协议
                if (origin === 'null' || origin === 'file://') {
                    // 本地文件的情况，使用完整路径
                    const fullPath = window.location.href;
                    const basePath = fullPath.substring(0, fullPath.lastIndexOf('/') + 1);
                    return basePath + 'oauth-callback.html';
                } else {
                    // 网络环境，使用 origin + pathname
                    const directory = pathname.substring(0, pathname.lastIndexOf('/') + 1);
                    return origin + directory + 'oauth-callback.html';
                }
            }
            
            // 登录系统 - 真实实现
            let currentUser = null;
            
            // 生成随机state参数用于安全验证
            function generateState() {
                return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            }
            
            // 初始化登录状态 - 增强容错处理
            function initLoginState() {
                try {
                    // 检查URL是否有登录回调参数（主页面处理错误情况）
                    const urlParams = new URLSearchParams(window.location.search);
                    const code = urlParams.get('code');
                    const error = urlParams.get('error');
                    
                    if (code || error) {
                        // 如果主页面收到登录回调，清理URL并处理
                        console.log('检测到登录回调参数，处理中...');
                        if (error) {
                            console.error('登录错误:', error);
                            alert('登录失败：' + (urlParams.get('error_description') || error));
                        } else {
                            // 有授权码但在主页面，可能是回调处理失败，尝试恢复
                            console.log('在主页面检测到授权码，尝试处理...');
                            handleMainPageOAuthCallback(code, urlParams.get('state'));
                        }
                        
                        // 清理URL参数
                        const cleanUrl = window.location.origin + window.location.pathname;
                        window.history.replaceState({}, document.title, cleanUrl);
                        return;
                    }
                    
                    // 正常加载本地存储的用户信息
                    const savedUser = localStorage.getItem('currentUser');
                    if (savedUser && savedUser !== 'null' && savedUser !== 'undefined') {
                        try {
                            const userData = JSON.parse(savedUser);
                            if (userData && userData.provider) {
                                currentUser = userData;
                                console.log('恢复用户登录状态:', userData.name || userData.username);
                                updateLoginUI();
                            } else {
                                console.log('用户数据无效，清除存储');
                                localStorage.removeItem('currentUser');
                            }
                        } catch (parseError) {
                            console.error('用户信息解析失败:', parseError);
                            localStorage.removeItem('currentUser');
                        }
                    }
                } catch (error) {
                    console.error('初始化登录状态失败:', error);
                    // 容错：即使初始化失败也要确保界面正常
                    try {
                        localStorage.removeItem('currentUser');
                        updateLoginUI();
                    } catch (e) {
                        console.error('清理失败，忽略错误继续运行');
                    }
                }
            }
            
            // 主页面登录回调处理（容错机制）
            function handleMainPageOAuthCallback(code, state) {
                try {
                    const provider = localStorage.getItem('oauth_provider') || 'github';
                    const savedState = localStorage.getItem('oauth_state');
                    
                    if (state && savedState && state === savedState) {
                        // 如果是GitHub，尝试简化处理
                        if (provider === 'github') {
                            // 保存授权码，让用户手动刷新或提供简化登录
                            const fallbackUser = {
                                id: 'github_' + Date.now(),
                                name: 'GitHub用户 (授权成功)',
                                username: 'github_authorized_user',
                                email: 'authorized@github.com',
                                avatar: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png',
                                provider: 'github',
                                note: '授权成功，但API调用受限。请在HTTPS环境下使用完整功能。'
                            };
                            
                            localStorage.setItem('currentUser', JSON.stringify(fallbackUser));
                            currentUser = fallbackUser;
                            updateLoginUI();
                            
                            alert('GitHub授权成功！\n由于是本地环境，显示基本信息。\n在HTTPS环境下可获取完整信息。');
                        }
                    } else {
                        console.warn('State验证失败，跳过回调处理');
                    }
                } catch (error) {
                    console.error('主页面登录回调处理失败:', error);
                }
            }

            
            // 更新登录界面 - 增强容错处理，确保用户名和头像始终显示
            function updateLoginUI() {
                try {
                    const loginSection = document.getElementById('loginSection');
                    const userProfile = document.getElementById('userProfile');
                    const viewProfileBtn = document.getElementById('viewProfileBtn');
                    const githubStats = document.getElementById('githubStats');
                    const userDetails = document.getElementById('userDetails');
                    
                    // 容错：检查元素是否存在
                    if (!loginSection || !userProfile) {
                        console.error('登录界面元素不存在');
                        return;
                    }
                    
                    if (currentUser && typeof currentUser === 'object') {
                        loginSection.style.display = 'none';
                        userProfile.style.display = 'block';
                        
                        // 基本用户信息 - 增强容错，确保始终有显示值
                        const displayName = currentUser.name || 
                                          currentUser.username || 
                                          currentUser.login || 
                                          `${currentUser.provider || 'GitHub'}用户`;
                        
                        const userEmail = currentUser.email || 
                                        currentUser.username ? `${currentUser.username}@${currentUser.provider || 'github'}.user` : 
                                        '未提供邮箱';
                        
                        // 处理GitHub头像URL，根据教程进行特殊处理
                        let userAvatar = currentUser.avatar_url || currentUser.avatar;
                        
                        // 如果是GitHub头像URL，进行特殊处理
                        if (userAvatar && userAvatar.includes('githubusercontent.com')) {
                            // 移除URL中的参数，确保能正确加载
                            userAvatar = userAvatar.split('?')[0];
                            // 确保使用HTTPS
                            if (userAvatar.startsWith('http://')) {
                                userAvatar = userAvatar.replace('http://', 'https://');
                            }
                        }
                        
                        // 如果没有头像URL，使用默认头像
                        if (!userAvatar) {
                            userAvatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=4361ee&color=fff&size=80`;
                        }
                        
                        // 安全设置用户名
                        const userNameEl = document.getElementById('userName');
                        if (userNameEl) {
                            userNameEl.textContent = displayName;
                        }
                        
                        // 安全设置邮箱
                        const userEmailEl = document.getElementById('userEmail');
                        if (userEmailEl) {
                            userEmailEl.textContent = userEmail;
                        }
                        
                        // 安全设置头像，多重容错
                        const avatarImg = document.getElementById('userAvatar');
                        if (avatarImg) {
                            avatarImg.onerror = function() {
                                // 头像加载失败时的多重备用方案
                                const fallbackOptions = [
                                    `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=4361ee&color=fff&size=80`,
                                    `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName.charAt(0))}&background=28a745&color=fff&size=80`,
                                    'https://via.placeholder.com/80/4361ee/ffffff?text=User',
                                    'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjNDM2MWVlIi8+Cjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIyNCI+VTwvdGV4dD4KPHN2Zz4='
                                ];
                                
                                // 找到下一个可用的备用头像
                                const currentIndex = fallbackOptions.indexOf(this.src) + 1;
                                if (currentIndex < fallbackOptions.length) {
                                    this.src = fallbackOptions[currentIndex];
                                } else {
                                    // 所有备用都失败，使用纯 CSS 样式
                                    this.style.display = 'none';
                                    const fallbackDiv = document.createElement('div');
                                    fallbackDiv.style.cssText = `
                                        width: 80px; height: 80px; border-radius: 50%; 
                                        background: #4361ee; color: white; 
                                        display: flex; align-items: center; justify-content: center;
                                        font-size: 32px; font-weight: bold;
                                        margin: 0 auto;
                                    `;
                                    fallbackDiv.textContent = displayName.charAt(0).toUpperCase();
                                    this.parentNode.insertBefore(fallbackDiv, this);
                                }
                            };
                            avatarImg.src = userAvatar;
                        }
                        
                        // GitHub 特有信息 - 增强容错
                        if (currentUser.provider === 'github') {
                            if (viewProfileBtn) {
                                viewProfileBtn.style.display = 'inline-block';
                            }
                            
                            // 安全设置详细信息
                            if (userDetails) {
                                let detailsHTML = '';
                                
                                if (currentUser.username || currentUser.login) {
                                    const username = currentUser.username || currentUser.login;
                                    detailsHTML += `<span style="color: var(--primary-color); font-weight: 600;">@${username}</span>`;
                                }
                                
                                if (currentUser.location) {
                                    detailsHTML += ` • <i class="fas fa-map-marker-alt" style="color: #28a745;"></i> ${currentUser.location}`;
                                }
                                
                                if (currentUser.company) {
                                    detailsHTML += ` • <i class="fas fa-building" style="color: #17a2b8;"></i> ${currentUser.company}`;
                                }
                                
                                if (currentUser.created_at) {
                                    try {
                                        const joinDate = new Date(currentUser.created_at).toLocaleDateString('zh-CN');
                                        detailsHTML += ` • <i class="fas fa-calendar-alt" style="color: #6f42c1;"></i> ${joinDate}加入`;
                                    } catch (dateError) {
                                        console.log('日期解析失败，跳过');
                                    }
                                }
                                
                                // 显示特殊注释（如本地环境限制）
                                if (currentUser.note) {
                                    detailsHTML += `<br><small style="color: #ffc107; font-style: italic;"><i class="fas fa-info-circle"></i> ${currentUser.note}</small>`;
                                }
                                
                                userDetails.innerHTML = detailsHTML;
                                
                                // 安全显示 bio
                                if (currentUser.bio) {
                                    const bioElement = document.createElement('div');
                                    bioElement.innerHTML = `<p style="font-style: italic; margin-top: 10px; padding: 12px; background: rgba(67,97,238,0.1); border-radius: 8px; font-size: 0.9rem; border-left: 3px solid var(--primary-color);"><i class="fas fa-quote-left" style="opacity: 0.6; margin-right: 6px;"></i>${currentUser.bio}</p>`;
                                    userDetails.appendChild(bioElement);
                                }
                                
                                // 容错处理错误信息
                                if (currentUser.error) {
                                    const errorElement = document.createElement('div');
                                    errorElement.innerHTML = `<p style="color: #ff6b6b; font-size: 0.85rem; margin-top: 8px; padding: 8px; background: rgba(255,107,107,0.1); border-radius: 6px;"><i class="fas fa-exclamation-triangle"></i> 部分信息获取失败：${currentUser.error}</p>`;
                                    userDetails.appendChild(errorElement);
                                }
                            }
                            
                            // 安全显示GitHub统计信息
                            if (githubStats && typeof currentUser.public_repos === 'number') {
                                githubStats.style.display = 'block';
                                const profileUrl = currentUser.html_url || currentUser.profile_url || `https://github.com/${currentUser.username || currentUser.login || ''}`;
                                
                                // 获取当前语言
                                const currentLang = getCookie("language") || "zh";
                                
                                // 根据语言获取翻译文本
                                const reposText = currentLang === "en" ? "Repositories" : "仓库";
                                const followersText = currentLang === "en" ? "Followers" : "关注者";
                                const followingText = currentLang === "en" ? "Following" : "关注中";
                                
                                githubStats.innerHTML = `
                                    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; padding: 15px; background: rgba(36,41,46,0.1); border-radius: 10px; margin-top: 10px;">
                                        <div style="text-align: center; cursor: pointer;" onclick="window.open('${profileUrl}?tab=repositories', '_blank')">
                                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-color);">${currentUser.public_repos || 0}</div>
                                            <div style="font-size: 0.8rem; opacity: 0.7;"><i class="fas fa-code-branch"></i> ${reposText}</div>
                                        </div>
                                        <div style="text-align: center; cursor: pointer;" onclick="window.open('${profileUrl}?tab=followers', '_blank')">
                                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-color);">${currentUser.followers || 0}</div>
                                            <div style="font-size: 0.8rem; opacity: 0.7;"><i class="fas fa-users"></i> ${followersText}</div>
                                        </div>
                                        <div style="text-align: center; cursor: pointer;" onclick="window.open('${profileUrl}?tab=following', '_blank')">
                                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-color);">${currentUser.following || 0}</div>
                                            <div style="font-size: 0.8rem; opacity: 0.7;"><i class="fas fa-user-plus"></i> ${followingText}</div>
                                        </div>
                                    </div>
                                `;
                            } else if (githubStats) {
                                githubStats.style.display = 'none';
                            }
                            
                        } else {
                            // 非GitHub登录用户
                            if (viewProfileBtn) viewProfileBtn.style.display = 'none';
                            if (githubStats) githubStats.style.display = 'none';
                            
                            if (userDetails) {
                                const providerName = currentUser.provider ? 
                                    currentUser.provider.charAt(0).toUpperCase() + currentUser.provider.slice(1) : 
                                    '未知平台';
                                userDetails.innerHTML = `<span style="opacity: 0.7;"><i class="fas fa-info-circle"></i> 来自 ${providerName}</span>`;
                            }
                        }
                    } else {
                        // 未登录状态
                        loginSection.style.display = 'block';
                        userProfile.style.display = 'none';
                    }
                } catch (error) {
                    console.error('更新登录界面失败:', error);
                    // 容错：即使出错也要保证基本显示
                    try {
                        const loginSection = document.getElementById('loginSection');
                        const userProfile = document.getElementById('userProfile');
                        if (loginSection && userProfile) {
                            if (currentUser) {
                                loginSection.style.display = 'none';
                                userProfile.style.display = 'block';
                                // 简化显示
                                const userNameEl = document.getElementById('userName');
                                if (userNameEl) userNameEl.textContent = '登录用户';
                            } else {
                                loginSection.style.display = 'block';
                                userProfile.style.display = 'none';
                            }
                        }
                    } catch (fallbackError) {
                        console.error('容错显示也失败:', fallbackError);
                    }
                }
            }
            
            // 查看GitHub个人主页
            function viewGitHubProfile() {
                if (currentUser && currentUser.provider === 'github' && currentUser.profile_url) {
                    window.open(currentUser.profile_url, '_blank');
                } else if (currentUser && currentUser.username) {
                    window.open(`https://github.com/${currentUser.username}`, '_blank');
                }
            }
            
            // 登录功能 - 增强容错处理
            function loginWithProvider(provider) {
                try {
                    const currentLang = getCookie("language") || "zh";
                    
                    // 检查配置
                    const config = OAUTH_CONFIG[provider];
                    if (!config) {
                        const errorMsg = currentLang === 'en' ? 
                            'Unsupported login provider' :
                            '不支持的登录方式';
                        alert(errorMsg);
                        return;
                    }
                    
                    // 生成state参数用于安全验证
                    const state = generateState();
                    
                    // 容错存储
                    try {
                        localStorage.setItem('oauth_state', state);
                        localStorage.setItem('oauth_provider', provider);
                    } catch (storageError) {
                        console.warn('无法保存登录状态到本地存储，继续登录流程');
                    }
                    
                    // 构建授权URL - 容错处理
                    let authUrl;
                    try {
                        if (provider === 'microsoft') {
                            authUrl = `${config.authUrl}?client_id=${config.clientId}&response_type=code&redirect_uri=${encodeURIComponent(config.redirectUri)}&scope=${encodeURIComponent(config.scope)}&state=${state}&response_mode=query`;
                        } else if (provider === 'google') {
                            authUrl = `${config.authUrl}?client_id=${config.clientId}&response_type=code&redirect_uri=${encodeURIComponent(config.redirectUri)}&scope=${encodeURIComponent(config.scope)}&state=${state}&access_type=offline&prompt=consent`;
                        } else if (provider === 'github') {
                            authUrl = `${config.authUrl}?client_id=${config.clientId}&redirect_uri=${encodeURIComponent(config.redirectUri)}&scope=${encodeURIComponent(config.scope)}&state=${state}&allow_signup=true`;
                        }
                        
                        if (!authUrl) {
                            throw new Error('无法构建授权URL');
                        }
                        
                        console.log('跳转到授权页面:', authUrl);
                        
                        // 跳转到授权页面
                        window.location.href = authUrl;
                        
                    } catch (urlError) {
                        console.error('构建授权URL失败:', urlError);
                        const errorMsg = currentLang === 'en' ? 
                            'Login service temporarily unavailable. Please try again later.' :
                            '登录服务暂时不可用，请稍后再试。';
                        alert(errorMsg);
                    }
                    
                } catch (error) {
                    console.error('登录出错:', error);
                    const currentLang = getCookie("language") || "zh";
                    const errorMsg = currentLang === 'en' ? 
                        `Login failed: ${error.message}` :
                        `登录失败：${error.message}`;
                    alert(errorMsg);
                }
            }
            
            // 退出登录
            function logout() {
                const currentLang = getCookie("language") || "zh";
                const confirmMsg = currentLang === 'en' ? 
                    'Are you sure you want to sign out?' :
                    '确定要退出登录吗？';
                
                if (confirm(confirmMsg)) {
                    currentUser = null;
                    localStorage.removeItem('currentUser');
                    updateLoginUI();
                    
                    const successMsg = currentLang === 'en' ? 
                        'Successfully signed out' :
                        '已成功退出登录';
                    alert(successMsg);
                }
            }
            
            // 同步设置功能
            function syncSettings() {
                const currentLang = getCookie("language") || "zh";
                
                if (!currentUser) {
                    const errorMsg = currentLang === 'en' ? 
                        'Please login first' :
                        '请先登录';
                    alert(errorMsg);
                    return;
                }
                
                // 模拟同步过程
                const loadingMsg = currentLang === 'en' ? 
                    'Syncing settings...' :
                    '正在同步设置...';
                alert(loadingMsg);
                
                // 模拟延迟
                setTimeout(() => {
                    const successMsg = currentLang === 'en' ? 
                        'Settings synced successfully!' :
                        '设置同步成功！';
                    alert(successMsg);
                }, 1000);
            }
            
            // Cookie和数据管理功能
            function showCookieInfo() {
                const currentLang = getCookie("language") || "zh";
                
                try {
                    let info = currentLang === 'en' ? 'Stored Data Information:\n\n' : '存储数据信息：\n\n';
                    
                    // 统计Cookie
                    const cookies = document.cookie.split(';').filter(c => c.trim().length > 0);
                    info += currentLang === 'en' ? 
                        `Cookies: ${cookies.length} items\n` :
                        `Cookie数据：${cookies.length} 条\n`;
                    
                    // 统计localStorage
                    const localStorageCount = localStorage.length;
                    info += currentLang === 'en' ? 
                        `LocalStorage: ${localStorageCount} items\n\n` :
                        `本地存储：${localStorageCount} 条\n\n`;
                    
                    // 列出主要数据
                    info += currentLang === 'en' ? 'Main Data:\n' : '主要数据：\n';
                    
                    const mainKeys = ['theme', 'language', 'selectedCity'];
                    mainKeys.forEach(key => {
                        const value = getCookie(key) || localStorage.getItem(key);
                        if (value) {
                            info += `- ${key}: ${value}\n`;
                        }
                    });
                    
                    alert(info);
                } catch (error) {
                    const errorMsg = currentLang === 'en' ? 
                        'Unable to read data information' :
                        '无法读取数据信息';
                    alert(errorMsg);
                }
            }
            
            function clearAllData() {
                const currentLang = getCookie("language") || "zh";
                const confirmMsg = currentLang === 'en' ? 
                    'Are you sure you want to clear all data?\nThis will reset all settings to default.' :
                    '确定要清除所有数据吗？\n这将重置所有设置为默认值。';
                
                if (confirm(confirmMsg)) {
                    try {
                        // 清除Cookie
                        const cookies = document.cookie.split(";");
                        for (let cookie of cookies) {
                            const eqPos = cookie.indexOf("=");
                            const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
                            if (name) {
                                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
                            }
                        }
                        
                        // 清除localStorage
                        localStorage.clear();
                        
                        // 重置登录状态
                        currentUser = null;
                        updateLoginUI();
                        
                        // 重置界面设置
                        document.body.classList.remove('dark-mode');
                        document.getElementById('themeSelect').value = 'light';
                        document.getElementById('languageSelect').value = 'zh';
                        
                        // 重置城市选择
                        const citySelect = document.getElementById('citySelect');
                        const provinceSelect = document.getElementById('provinceSelect');
                        if (provinceSelect) provinceSelect.value = 'all';
                        updateCityOptions('all');
                        if (citySelect) citySelect.value = 'beijing';
                        updateCurrentCity('beijing');
                        
                        // 重置语言
                        enhancedSwitchLanguage('zh');
                        
                        const successMsg = currentLang === 'en' ? 
                            'All data cleared successfully!\nPage will reload to apply changes.' :
                            '所有数据清除成功！\n页面将重新加载以应用更改。';
                        alert(successMsg);
                        
                        // 延迟重载页面
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                        
                    } catch (error) {
                        const errorMsg = currentLang === 'en' ? 
                            'Failed to clear data: ' + error.message :
                            '清除数据失败：' + error.message;
                        alert(errorMsg);
                    }
                }
            }
            
            // 导出设置
            function exportSettings() {
                const currentLang = getCookie("language") || "zh";
                
                try {
                    const settings = {
                        theme: getCookie("theme") || "light",
                        language: getCookie("language") || "zh",
                        selectedCity: getCookie("selectedCity") || "beijing",
                        customWebsites: JSON.parse(localStorage.getItem('customWebsites') || '[]'),
                        exportDate: new Date().toISOString(),
                        version: "1.0"
                    };
                    
                    const dataStr = JSON.stringify(settings, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `toolbox-settings-${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    
                    const successMsg = currentLang === 'en' ? 
                        'Settings exported successfully!' :
                        '设置导出成功！';
                    alert(successMsg);
                    
                } catch (error) {
                    const errorMsg = currentLang === 'en' ? 
                        'Export failed: ' + error.message :
                        '导出失败：' + error.message;
                    alert(errorMsg);
                }
            }
            
            // 导入设置
            function importSettings() {
                document.getElementById('importFileInput').click();
            }
            
            function handleImportFile(event) {
                const currentLang = getCookie("language") || "zh";
                const file = event.target.files[0];
                
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const settings = JSON.parse(e.target.result);
                        
                        // 验证文件格式
                        if (!settings.version) {
                            throw new Error('无效的设置文件格式');
                        }
                        
                        const confirmMsg = currentLang === 'en' ? 
                            `Import settings from ${settings.exportDate ? new Date(settings.exportDate).toLocaleDateString() : 'unknown date'}?\nThis will overwrite current settings.` :
                            `导入来自 ${settings.exportDate ? new Date(settings.exportDate).toLocaleDateString() : '未知日期'} 的设置？\n这将覆盖当前设置。`;
                        
                        if (confirm(confirmMsg)) {
                            // 应用设置
                            if (settings.theme) {
                                setCookie("theme", settings.theme, 30);
                                document.body.classList.toggle('dark-mode', settings.theme === 'dark');
                                document.getElementById('themeSelect').value = settings.theme;
                            }
                            
                            if (settings.language) {
                                setCookie("language", settings.language, 30);
                                enhancedSwitchLanguage(settings.language);
                            }
                            
                            if (settings.selectedCity) {
                                setCookie("selectedCity", settings.selectedCity, 30);
                                updateCurrentCity(settings.selectedCity);
                            }
                            
                            if (settings.customWebsites) {
                                localStorage.setItem('customWebsites', JSON.stringify(settings.customWebsites));
                                loadWebsites(getWebsites());
                            }
                            
                            const successMsg = currentLang === 'en' ? 
                                'Settings imported successfully!' :
                                '设置导入成功！';
                            alert(successMsg);
                        }
                        
                    } catch (error) {
                        const errorMsg = currentLang === 'en' ? 
                            'Import failed: Invalid file format' :
                            '导入失败：文件格式无效';
                        alert(errorMsg);
                    }
                };
                
                reader.readAsText(file);
                // 清空文件输入
                event.target.value = '';
            }

            
            // 快速登录功能（提供游客账户体验）
            function testGitHubLogin() {
                const currentLang = getCookie("language") || "zh";
                
                const confirmMsg = currentLang === 'en' ? 
                    'Quick Login will create a guest account to experience all features. Continue?' :
                    '快速登录将创建一个游客账户来体验所有功能。继续？';
                
                if (confirm(confirmMsg)) {
                    // 生成六位随机数字
                    const guestNumber = Math.floor(Math.random() * 900000) + 100000;
                    
                    // 创建游客登录用户信息
                    const quickLoginUser = {
                        id: 'guest_' + guestNumber,
                        name: '游客' + guestNumber,
                        username: 'guest' + guestNumber,
                        login: 'guest' + guestNumber,
                        email: `guest${guestNumber}@toolbox.demo`,
                        avatar_url: `https://ui-avatars.com/api/?name=游客${guestNumber}&background=28a745&color=fff&size=80&font-size=0.33`,
                        avatar: `https://ui-avatars.com/api/?name=游客${guestNumber}&background=28a745&color=fff&size=80&font-size=0.33`,
                        provider: 'github',
                        html_url: 'https://github.com',
                        profile_url: 'https://github.com',
                        bio: '游客账户，用于体验工具箱的完整登录功能和用户信息显示。',
                        location: '云端服务器',
                        company: '阮铭泽工具箱',
                        public_repos: Math.floor(Math.random() * 20) + 5,
                        followers: Math.floor(Math.random() * 50) + 10,
                        following: Math.floor(Math.random() * 30) + 8,
                        created_at: '2023-01-01T00:00:00Z',
                        updated_at: new Date().toISOString(),
                        note: '游客模式：体验数据，无需OAuth配置'
                    };
                    
                    try {
                        localStorage.setItem('currentUser', JSON.stringify(quickLoginUser));
                        currentUser = quickLoginUser;
                        updateLoginUI();
                        
                        const successMsg = currentLang === 'en' ? 
                            `Quick login successful! Welcome, Guest ${guestNumber}. Experience all features as a guest.` :
                            `快速登录成功！欢迎，游客${guestNumber}。以游客身份体验所有功能。`;
                        alert(successMsg);
                    } catch (error) {
                        console.error('快速登录失败:', error);
                        const errorMsg = currentLang === 'en' ? 
                            'Quick login failed: ' + error.message :
                            '快速登录失败：' + error.message;
                        alert(errorMsg);
                    }
                }
            }

            // 手机号登录功能
            // 登录账户功能
            function loginAccount() {
                // 跳转到登录页面
                window.location.href = 'login.html';
            }

            // 注册账户功能
            function registerAccount() {
                // 跳转到注册页面
                window.location.href = 'register.html';
            }

            // 用户登录函数（使用后端API）
            async function userLogin(username, password) {
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // 创建用户对象
                        const user = {
                            id: 'user_' + Date.now(),
                            name: result.user.name,
                            username: result.user.username,
                            email: result.user.email,
                            phone: result.user.phone,
                            avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(result.user.name)}&background=4361ee&color=fff&size=80`,
                            provider: 'local',
                            created_at: result.user.createdAt
                        };
                        
                        // 保存用户信息到localStorage
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        currentUser = user;
                        
                        // 保存登录状态到Cookie
                        setCookie("loginStatus", "logged_in", 30);
                        setCookie("currentUser", JSON.stringify(user), 30);
                        
                        // 更新UI
                        updateLoginUI();
                        
                        // 返回成功
                        return { success: true };
                    } else {
                        // 返回失败
                        return { success: false, message: result.message };
                    }
                } catch (error) {
                    console.error('登录请求失败:', error);
                    return { success: false, message: '网络错误，请稍后重试' };
                }
            }

            // 用户注册函数（使用后端API）
            async function userRegister(name, username, password, email, phone) {
                try {
                    const response = await fetch('/api/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name, username, password, email, phone })
                    });
                    
                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error('注册请求失败:', error);
                    return { success: false, message: '网络错误，请稍后重试' };
                }
            }
            
            // 切换标签功能
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // 移除所有活动标签
                    tabBtns.forEach(b => b.classList.remove('active'));
                    // 设置当前标签为活动
                    btn.classList.add('active');
                    
                    // 隐藏所有内容
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // 显示当前内容
                    const tabId = btn.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // 设置按钮点击事件
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', () => {
                    // 移除所有活动标签
                    tabBtns.forEach(b => b.classList.remove('active'));
                    // 设置当前标签为活动
                    settingsBtn.classList.add('active');
                    
                    // 隐藏所有内容
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // 显示设置内容
                    document.getElementById('settings').classList.add('active');
                });
            }
            
            // 工具栏滚动隐藏/显示控制 - 优化版本
            let lastScrollY = window.scrollY;
            let ticking = false; // 防抖优化
            
            // 确保工具栏在页面加载时正确显示
            document.addEventListener('DOMContentLoaded', function() {
                const header = document.getElementById('mainHeader');
                if (header) {
                    header.style.transform = 'translateY(0)';
                }
            });
            
            window.addEventListener('scroll', () => {
                if (!ticking) {
                    requestAnimationFrame(() => {
                        const currentScrollY = window.scrollY;
                        const header = document.getElementById('mainHeader');
                        
                        // 判断滚动方向
                        if (currentScrollY > lastScrollY && currentScrollY > 50) {
                            // 向下滚动，隐藏工具栏
                            header.style.transform = 'translateY(-100%)';
                        } else if (currentScrollY < lastScrollY || currentScrollY <= 0) {
                            // 向上滚动或回到顶部，显示工具栏
                            header.style.transform = 'translateY(0)';
                        }
                        
                        lastScrollY = currentScrollY;
                        ticking = false;
                    });
                    ticking = true;
                }
            });
            
            // 鼠标移动到页面顶部区域时显示工具栏，移出时隐藏
            let toolBarTimeout;
            document.addEventListener('mousemove', (e) => {
                const header = document.getElementById('mainHeader');
                
                // 如果鼠标在页面顶部区域（前50px）
                if (e.clientY <= 50) {
                    // 显示工具栏
                    header.style.transform = 'translateY(0)';
                    
                    // 清除之前的定时器
                    if (toolBarTimeout) clearTimeout(toolBarTimeout);
                    
                    // 2秒后自动隐藏（仅当页面不在顶部时）
                    if (window.scrollY > 50) {
                        toolBarTimeout = setTimeout(() => {
                            header.style.transform = 'translateY(-100%)';
                        }, 2000);
                    }
                } else if (e.clientY > 100 && window.scrollY > 50) {
                    // 如果鼠标移动到下方且工具栏处于显示状态，则隐藏工具栏
                    if (header && header.style.transform !== 'translateY(-100%)') {
                        header.style.transform = 'translateY(-100%)';
                        // 清除定时器
                        if (toolBarTimeout) clearTimeout(toolBarTimeout);
                    }
                }
            });
            
            // 页面切换时重置工具栏状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const header = document.getElementById('mainHeader');
                    if (header) {
                        header.style.transform = 'translateY(0)';
                        // 清除定时器
                        if (toolBarTimeout) clearTimeout(toolBarTimeout);
                    }
                });
            });
            
            // 窗口大小改变时重置工具栏状态
            window.addEventListener('resize', () => {
                const header = document.getElementById('mainHeader');
                if (header) {
                    header.style.transform = 'translateY(0)';
                    // 清除定时器
                    if (toolBarTimeout) clearTimeout(toolBarTimeout);
                }
            });
            
            // 彩蛋效果 - 优化版本，随机触发三种效果之一
            const easterBtn = document.getElementById('easterEggBtn');
            easterBtn.addEventListener('click', () => {
                // 随机选择一种效果 (1-3)
                const effectType = Math.floor(Math.random() * 3) + 1;
                
                switch(effectType) {
                    case 1:
                        // 效果1：原来的视觉特效
                        triggerOriginalEffect();
                        break;
                    case 2:
                        // 效果2：下载并播放音频文件
                        triggerAudioEffect();
                        break;
                    case 3:
                        // 效果3：打开烧显卡测试网站
                        triggerWebsiteEffect();
                        break;
                }
            });
            
            // 效果1：原来的视觉特效
            function triggerOriginalEffect() {
                // 直接触发效果，不显示提示
                document.body.classList.add('crazy-mode');
                document.documentElement.classList.add('crazy-mode');
                
                // 优化后的颜色变化（减少频率）
                const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
                let colorIndex = 0;
                const colorInterval = setInterval(() => {
                    const randomAngle = Math.random() * 360;
                    document.body.style.background = `linear-gradient(${randomAngle}deg, ${colors[colorIndex % colors.length]}, ${colors[(colorIndex + 1) % colors.length]})`;
                    colorIndex++;
                }, 500); // 从200ms改为500ms
                
                // 轻微的抖动效果（减少页面抖动）
                const shakeInterval = setInterval(() => {
                    const shakeX = (Math.random() - 0.5) * 4; // 从10减少到4
                    const shakeY = (Math.random() - 0.5) * 4;
                    const shakeRotate = (Math.random() - 0.5) * 2; // 从4减少到2
                    document.body.style.transform = `translate(${shakeX}px, ${shakeY}px) rotate(${shakeRotate}deg)`;
                }, 200); // 从100ms改为200ms
                
                // 文字颜色变化（减少频率）
                const textElements = document.querySelectorAll('.card-title, .tool-title, .resource-name');
                const textInterval = setInterval(() => {
                    textElements.forEach(el => {
                        el.style.color = colors[Math.floor(Math.random() * colors.length)];
                        el.style.textShadow = `0 0 ${Math.random() * 10 + 5}px ${colors[Math.floor(Math.random() * colors.length)]}`; // 从20减少到10
                    });
                }, 300); // 从150ms改为300ms
                
                // 25秒后清理效果（从35秒减少到25秒）
                setTimeout(() => {
                    document.body.classList.remove('crazy-mode');
                    document.documentElement.classList.remove('crazy-mode');
                    clearInterval(colorInterval);
                    clearInterval(shakeInterval);
                    clearInterval(textInterval);
                    
                    // 恢复原始样式
                    document.body.style.background = '';
                    document.body.style.transform = '';
                    textElements.forEach(el => {
                        el.style.color = '';
                        el.style.textShadow = '';
                    });
                    
                    // 不显示结束提示
                }, 25000); // 25秒
            }
            
            // 效果2：播放音频文件
            function triggerAudioEffect() {
                // 使用相对路径引用音频文件
                const audioPath = "_/%E7%A9%BA/%E7%9C%9F%E6%B2%A1%E4%BA%86/%E7%9B%B8%E4%BF%A1%E6%88%91%E5%90%97/%E7%9C%9F%E7%9A%84%E6%B2%A1%E5%95%A6%EF%BC%81%EF%BC%81%EF%BC%81%EF%BC%81%EF%BC%81/%E7%9C%9F~%E7%9A%84~%E6%B2%A1~%E6%9C%89~%E5%95%A6/%E5%93%BC/%EF%BC%9F%EF%BC%9F%EF%BC%9F.mp3";
                
                // 创建音频元素
                const audio = new Audio(audioPath);
                audio.controls = true;
                audio.autoplay = true;
                
                // 尝试播放音频
                audio.play()
                    .then(() => {
                        console.log('音频开始播放');
                        // 创建一个临时的音频播放界面
                        createAudioUI(audio);
                    })
                    .catch(error => {
                        console.error('音频播放失败:', error);
                        // 如果播放失败，提示用户手动打开
                        const currentLang = getCookie("language") || "zh";
                        const errorMsg = currentLang === 'en' ? 
                            'Failed to play audio automatically. Please manually open the audio file.' :
                            '无法自动播放音频，请手动打开音频文件。';
                        alert(errorMsg);
                        
                        // 尝试创建下载链接
                        const link = document.createElement('a');
                        link.href = audioPath;
                        link.download = '？？？.mp3';
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    });
            }
            
            // 创建音频播放界面
            function createAudioUI(audio) {
                // 创建一个浮动的音频控制面板
                const audioPanel = document.createElement('div');
                audioPanel.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 15px;
                    border-radius: 10px;
                    z-index: 9999;
                    max-width: 300px;
                `;
                
                audioPanel.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span>？？？</span>
                        <button id="closeAudioPanel" style="background: red; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">×</button>
                    </div>
                `;
                
                // 添加音频控件
                audio.style.width = '100%';
                audio.style.marginTop = '10px';
                
                audioPanel.appendChild(audio);
                document.body.appendChild(audioPanel);
                
                // 添加关闭按钮事件
                document.getElementById('closeAudioPanel').addEventListener('click', () => {
                    document.body.removeChild(audioPanel);
                    audio.remove();
                });
                
                // 音频播放结束后自动移除面板
                audio.addEventListener('ended', () => {
                    if (document.body.contains(audioPanel)) {
                        document.body.removeChild(audioPanel);
                    }
                });
            }
            
            // 效果3：打开烧显卡测试网站
            function triggerWebsiteEffect() {
                // 直接打开网站，不显示风险提示
                window.open('https://cznull.github.io/vsbm', '_blank');
            }
            
            // 实用网站卡片动态加载
const websiteList = document.getElementById('websiteList');
const defaultWebsites = [
    {
        name: "GitHub",
        desc: "全球最大开源资源库，托管代码与项目协作",
        url: "https://github.com/",
        icon: "https://github.githubassets.com/favicons/favicon.svg"
    },
    {
        name: "msdn.itellyou.cn",
        desc: "微软官方系统镜像下载与信息查询",
        url: "https://msdn.itellyou.cn/",
        icon: "https://msdn.itellyou.cn/favicon.ico"
    },
    {
        name: "哔哩哔哩",
        desc: "国内知名视频弹幕网站，学习与娱乐资源丰富",
        url: "https://www.bilibili.com/",
        icon: "https://www.bilibili.com/favicon.ico"
    },
    {
        name: "每日壁纸",
        desc: "必应每日高清壁纸，自动更新美图",
        url: "https://bing.wdbyte.com/zh-cn/",
        icon: "https://bing.wdbyte.com/favicon.ico"
    },
    {
        name: "Pexels",
        desc: "高质量免费素材图片搜索下载平台",
        url: "https://www.pexels.com/zh-cn/",
        icon: "https://www.pexels.com/favicon.ico"
    },
    {
        name: "摸鱼小游戏",
        desc: "精选各种有趣的小游戏，休闲放松好去处",
        url: "https://moyu.games/",
        icon: "https://moyu.games/favicon.ico"
    }
];

function getWebsites() {
    // 只加载一次默认+自定义
    const customWebsites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
    return defaultWebsites.concat(customWebsites);
}

function saveCustomWebsites(list) {
    localStorage.setItem('customWebsites', JSON.stringify(list));
    
    // 同时发送到后端保存
    saveWebsitesToServer(list);
}

// 保存网站到后端服务器
async function saveWebsitesToServer(websites) {
    try {
        // 这里应该调用后端API来保存网站列表
        // 示例代码，实际实现需要根据后端API调整
        /*
        const response = await fetch('/api/websites', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getAuthToken() // 如果需要认证
            },
            body: JSON.stringify({ websites: websites })
        });
        
        if (!response.ok) {
            throw new Error('保存失败');
        }
        */
        console.log('网站列表已保存到服务器');
    } catch (error) {
        console.error('保存网站列表到服务器失败:', error);
        // 可以在这里添加错误提示
    }
}

function loadWebsites(websites) {
    websiteList.innerHTML = '';
    websites.forEach((site, idx) => {
        const card = document.createElement('div');
        card.className = 'resource-card';
        card.style.cursor = 'pointer';

        const icon = document.createElement('div');
        icon.className = 'resource-icon';
        const img = document.createElement('img');
        img.src = site.icon;
        img.alt = site.name;
        img.onerror = function() {
            // 图片加载失败时显示默认图标
            this.style.display = 'none';
            const fallbackIcon = document.createElement('i');
            fallbackIcon.className = 'fas fa-globe';
            fallbackIcon.style.fontSize = '32px';
            fallbackIcon.style.color = 'var(--primary-color)';
            icon.appendChild(fallbackIcon);
        };
        icon.appendChild(img);

        const info = document.createElement('div');
        info.className = 'website-info';

        const name = document.createElement('div');
        name.className = 'resource-name';
        name.textContent = site.name;
        
        const desc = document.createElement('div');
        desc.className = 'website-desc';
        desc.textContent = site.desc || ''; // 简介是可选的
        
        info.appendChild(name);
        info.appendChild(desc);

        card.appendChild(icon);
        card.appendChild(info);
        
        card.addEventListener('click', () => {
            window.open(site.url, '_blank');
        });

        // 仅自定义网站显示删除按钮
        if (idx >= defaultWebsites.length) {
            const delBtn = document.createElement('button');
            delBtn.className = 'delete-btn';
            delBtn.textContent = '删除';
            delBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const customWebsites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
                customWebsites.splice(idx - defaultWebsites.length, 1);
                saveCustomWebsites(customWebsites);
                loadWebsites(getWebsites());
            });
            card.appendChild(delBtn);
        }
        
        websiteList.appendChild(card);
    });
}

// 加载网站（只加载一次）
loadWebsites(getWebsites());

// 添加网站功能
const addWebsiteBtn = document.getElementById('addWebsiteBtn');
const addWebsiteModal = document.getElementById('addWebsiteModal');
const cancelAddWebsite = document.getElementById('cancelAddWebsite');
const websiteForm = document.getElementById('websiteForm');

addWebsiteBtn.addEventListener('click', () => {
    addWebsiteModal.style.display = 'flex';
});

cancelAddWebsite.addEventListener('click', () => {
    addWebsiteModal.style.display = 'none';
});

websiteForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const siteName = document.getElementById('siteName').value.trim();
    const siteDesc = document.getElementById('siteDesc').value.trim();
    const siteUrl = document.getElementById('siteUrl').value.trim();
    const siteIcon = document.getElementById('siteIcon').files[0];
    
    if (!siteName || !siteUrl) {
        alert("请填写网站名称和网址！");
        return;
    }
    
    // 验证URL格式
    try {
        new URL(siteUrl);
    } catch (e) {
        alert("请输入有效的网址（以https://或http://开头）");
        return;
    }
    
    let iconUrl = 'https://via.placeholder.com/44'; // 默认图标
    if (siteIcon) {
        // 验证文件类型
        const allowedTypes = ['image/jpeg', 'image/png', 'image/x-icon', 'image/vnd.microsoft.icon'];
        if (!allowedTypes.includes(siteIcon.type)) {
            alert("请选择jpg、png或ico格式的图片");
            return;
        }
        
        // 验证文件大小（不超过1MB）
        if (siteIcon.size > 1024 * 1024) {
            alert("图片大小不能超过1MB");
            return;
        }
        
        // 将图片转换为Base64编码
        const reader = new FileReader();
        reader.onload = function(e) {
            iconUrl = e.target.result;
            addWebsiteToList(siteName, siteDesc, siteUrl, iconUrl);
        };
        reader.readAsDataURL(siteIcon);
    } else {
        // 如果没有上传图标，尝试从网站获取favicon
        iconUrl = getFaviconUrl(siteUrl);
        addWebsiteToList(siteName, siteDesc, siteUrl, iconUrl);
    }
});

// 获取网站favicon的URL
function getFaviconUrl(websiteUrl) {
    try {
        const url = new URL(websiteUrl);
        return `${url.origin}/favicon.ico`;
    } catch (e) {
        return 'https://via.placeholder.com/44';
    }
}

// 添加网站到列表
function addWebsiteToList(name, desc, url, icon) {
    const customWebsites = JSON.parse(localStorage.getItem('customWebsites') || '[]');
    customWebsites.push({ 
        name: name, 
        desc: desc || '', 
        url: url, 
        icon: icon 
    });
    saveCustomWebsites(customWebsites);
    loadWebsites(getWebsites());
    addWebsiteModal.style.display = 'none';
    websiteForm.reset();
}
        
        // 日历初始化
        function initCalendar() {
            const currentMonthEl = document.getElementById('currentMonth');
            const prevBtn = document.getElementById('prevMonth');
            const nextBtn = document.getElementById('nextMonth');
            const calendarGrid = document.querySelector('.calendar-grid');
            
            // 节日数据库
            // 节日数据库
            const festivals = {
                // 国际节日
                '1-1': { name: '元旦', description: '公历新年，世界多数国家通称"新年"' },
                '2-14': { name: '情人节', description: '西方传统节日，男女互赠礼物表达爱意' },
                '3-8': { name: '妇女节', description: '庆祝妇女在经济、政治和社会等领域做出的重要贡献' },
                '4-1': { name: '愚人节', description: '西方传统节日，人们互相开玩笑、捉弄他人' },
                '5-1': { name: '劳动节', description: '全世界劳动人民的节日' },
                '5-4': { name: '青年节', description: '纪念五四运动，弘扬爱国主义精神' },
                '6-1': { name: '儿童节', description: '保障儿童权利，反对虐杀和毒害儿童' },
                '7-1': { name: '建党节', description: '中国共产党建党纪念日' },
                '8-1': { name: '建军节', description: '中国人民解放军建军纪念日' },
                '9-10': { name: '教师节', description: '表彰教师的节日，中国于1985年设立' },
                '10-1': { name: '国庆节', description: '中华人民共和国中央人民政府成立纪念日' },
                '12-25': { name: '圣诞节', description: '基督教纪念耶稣诞生的节日' },
                
                // 中国传统节日（按农历计算，这里使用近似日期）
                '2-10': { name: '春节', description: '农历新年，中国人最重要的传统节日' },
                '2-24': { name: '元宵节', description: '春节之后的第一个重要节日，吃汤圆赏花灯' },
                '4-4': { name: '清明节', description: '祭祖扫墓的日子，也是踏青的好时节' },
                '6-10': { name: '端午节', description: '纪念屈原，吃粽子、赛龙舟' },
                '8-15': { name: '中秋节', description: '团圆节，赏月吃月饼' },
                '9-9': { name: '重阳节', description: '敬老节，登高赏菊' },
                '12-23': { name: '小年', description: '中国传统节日，春节的前奏' },
                '12-30': { name: '除夕', description: '农历年的最后一天，家人团聚吃年夜饭' },
                
                // 重要纪念日
                '9-3': { name: '抗战胜利纪念日', description: '中国人民抗日战争胜利纪念日' },
                '12-13': { name: '国家公祭日', description: '南京大屠杀死难者国家公祭日' }
            };
            
            // 初始化当前日期
            const today = new Date();
            let currentMonth = today.getMonth();
            let currentYear = today.getFullYear();
            
            // 渲染日历
            renderCalendar(currentYear, currentMonth);
            
            prevBtn.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar(currentYear, currentMonth);
            });
            
            nextBtn.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar(currentYear, currentMonth);
            });
            
            function renderCalendar(year, month) {
                // 设置月份标题（根据当前语言）
                const currentLang = getCookie("language") || "zh";
                const monthNamesZh = ["一月", "二月", "三月", "四月", "五月", "六月",
                                  "七月", "八月", "九月", "十月", "十一月", "十二月"];
                const monthNamesEn = ["January", "February", "March", "April", "May", "June",
                                  "July", "August", "September", "October", "November", "December"];
                const monthNames = currentLang === "en" ? monthNamesEn : monthNamesZh;
                currentMonthEl.textContent = currentLang === "en" ? `${monthNames[month]} ${year}` : `${year}年 ${monthNames[month]}`;
                
                // 计算月份第一天是周几
                const firstDay = new Date(year, month, 1);
                const firstDayOfWeek = firstDay.getDay(); // 0-6（周日到周六）
                
                // 计算月份有多少天
                const lastDate = new Date(year, month + 1, 0);
                const daysInMonth = lastDate.getDate();
                
                // 清空日历网格（跳过前7个星期几元素）
                for (let i = 7; i < calendarGrid.children.length; ) {
                    calendarGrid.removeChild(calendarGrid.children[i]);
                }
                
                // 添加空白填充（上个月的天数）
                for (let i = 0; i < firstDayOfWeek; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day empty';
                    calendarGrid.appendChild(emptyDay);
                }
                
                // 添加本月天数
                const today = new Date();
                const currentDay = today.getDate();
                const currentMonthToday = today.getMonth();
                const currentYearToday = today.getFullYear();
                
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.textContent = i;
                    
                    // 标记今天
                    if (i === currentDay && month === currentMonthToday && year === currentYearToday) {
                        dayEl.classList.add('today');
                    }
                    
                    // 检查是否有节日
                    const monthDay = `${month + 1}-${i}`;
                    if (festivals[monthDay]) {
                        dayEl.classList.add('event', 'festival');
                        dayEl.setAttribute('data-festival', festivals[monthDay].description);
                    }
                    
                    calendarGrid.appendChild(dayEl);
                }
            }
        }
        


// 知识内容折叠展开功能
function toggleKnowledge(element) {
    const header = element;
    const content = header.nextElementSibling;
    const icon = header.querySelector('.toggle-icon');
    
    if (content.style.display === 'none' || content.style.display === '') {
        // 展开内容
        content.style.display = 'block';
        icon.style.transform = 'rotate(90deg)';
    } else {
        // 折叠内容
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
    }
}

// 页面加载完成后初始化知识内容为折叠状态
document.addEventListener('DOMContentLoaded', function() {
    const knowledgeContents = document.querySelectorAll('.knowledge-content');
    knowledgeContents.forEach(content => {
        content.style.display = 'none';
    });
    
    // 应用保存的主题设置
    const savedTheme = getCookie("theme") || "light";
    if (savedTheme === "dark") {
        document.body.classList.add('dark-mode');
        // 更新模态框样式
        const modal = document.getElementById('addWebsiteModal');
        const form = document.getElementById('websiteForm');
        const inputs = modal.querySelectorAll('input');
        const labels = modal.querySelectorAll('label');
        
        if (form) {
            form.style.background = '#252540';
            form.style.color = '#f0f2f5';
        }
        
        inputs.forEach(input => {
            input.style.background = '#2a2a4a';
            input.style.borderColor = 'rgba(94,114,228,0.3)';
            input.style.color = '#f0f2f5';
        });
        
        labels.forEach(label => {
            label.style.color = '#f0f2f5';
        });
    }
    
    // 初始化毛玻璃效果设置
    initBlurEffect();
    
    // 主题切换
    const themeSelect = document.getElementById('themeSelect');
    themeSelect.addEventListener('change', function() {
        const themeValue = this.value;
        document.body.classList.toggle('dark-mode', themeValue === 'dark');
        
        // 保存到Cookie，有效期30天
        setCookie("theme", themeValue, 30);
        
        // 更新模态框样式
        const modal = document.getElementById('addWebsiteModal');
        const form = document.getElementById('websiteForm');
        const inputs = modal.querySelectorAll('input');
        const labels = modal.querySelectorAll('label');
        
        if (themeValue === 'dark') {
            // 深色模式样式
            if (form) {
                form.style.background = '#252540';
                form.style.color = '#f0f2f5';
            }
            
            inputs.forEach(input => {
                input.style.background = '#2a2a4a';
                input.style.borderColor = 'rgba(94,114,228,0.3)';
                input.style.color = '#f0f2f5';
            });
            
            labels.forEach(label => {
                label.style.color = '#f0f2f5';
            });
        } else {
            // 浅色模式样式
            if (form) {
                form.style.background = '#ffffff';
                form.style.color = '#333';
            }
            
            inputs.forEach(input => {
                input.style.background = '#ffffff';
                input.style.borderColor = 'rgba(67,97,238,0.3)';
                input.style.color = '#333';
            });
            
            labels.forEach(label => {
                label.style.color = '#333';
            });
        }
    });
    
    // 添加头像上传功能
    const avatarUpload = document.getElementById('avatarUpload');
    if (avatarUpload) {
        avatarUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // 验证文件类型
                const allowedTypes = ['image/jpeg', 'image/png', 'image/x-icon', 'image/vnd.microsoft.icon'];
                if (!allowedTypes.includes(file.type)) {
                    showError('avatarError', '请选择jpg、png或ico格式的图片');
                    e.target.value = '';
                    return;
                }
                
                // 验证文件大小（不超过5MB）
                if (file.size > 5 * 1024 * 1024) {
                    showError('avatarError', '图片大小不能超过5MB');
                    e.target.value = '';
                    return;
                }
                
                // 显示加载指示器
                const loadingIndicator = document.createElement('div');
                loadingIndicator.textContent = '上传中...';
                loadingIndicator.style.color = 'var(--primary-color)';
                loadingIndicator.style.marginTop = '5px';
                loadingIndicator.id = 'avatarLoading';
                document.getElementById('avatarError').parentNode.appendChild(loadingIndicator);
                
                // 隐藏错误信息
                hideError('avatarError');
                
                // 将图片转换为Base64编码
                const reader = new FileReader();
                reader.onload = function(e) {
                    // 移除加载指示器
                    const loadingElement = document.getElementById('avatarLoading');
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    
                    // 更新用户头像
                    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                    if (currentUser) {
                        // 更新用户对象中的头像数据
                        currentUser.avatar = e.target.result;
                        
                        // 保存到localStorage
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        
                        // 更新页面上的头像显示
                        const userAvatar = document.getElementById('userAvatar');
                        if (userAvatar) {
                            userAvatar.src = e.target.result;
                        }
                        
                        // 如果是本地账户，还需要更新服务器上的头像
                        if (currentUser.provider === 'local') {
                            updateAvatarOnServer(currentUser, e.target.result);
                        }
                        
                        alert('头像更新成功！');
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
});

// 初始化毛玻璃效果
function initBlurEffect() {
    // 获取相关元素
    const toggleBlurBtn = document.getElementById('toggleBlurBtn');
    const toggleBlurText = document.getElementById('toggleBlurText');
    const blurSettings = document.getElementById('blurSettings');
    const blurSlider = document.getElementById('blurSlider');
    const blurValue = document.getElementById('blurValue');
    const backgroundUpload = document.getElementById('backgroundUpload');
    const resetBackground = document.getElementById('resetBackground');
    const backgroundSettings = document.getElementById('backgroundSettings');
    
    // 检查元素是否存在
    if (!toggleBlurBtn || !toggleBlurText || !blurSettings || !blurSlider || !blurValue || !backgroundSettings) {
        console.log('毛玻璃效果相关元素未找到');
        return;
    }
    
    // 从Cookie中读取保存的设置
    const isBlurEnabled = getCookie("blurEffect") === "true";
    const savedBlurValue = getCookie("blurStrength") || "10";
    const savedBackground = getCookie("customBackground");
    
    // 应用保存的设置
    if (isBlurEnabled) {
        toggleBlurText.textContent = '关闭毛玻璃';
        blurSettings.style.display = 'block';
        // 延迟应用模糊效果，确保DOM元素完全加载
        setTimeout(() => {
            applyBlurEffect(true, savedBlurValue);
        }, 100);
    } else {
        toggleBlurText.textContent = '开启毛玻璃';
        blurSettings.style.display = 'block'; // 始终显示模糊度设置
        applyBlurEffect(false);
    }
    
    // 背景设置始终可见
    backgroundSettings.style.display = 'block';
    
    // 设置滑块值和显示
    blurSlider.value = savedBlurValue;
    blurValue.textContent = savedBlurValue + 'px';
    
    // 如果有保存的背景，应用它
    if (savedBackground) {
        applyCustomBackground(savedBackground);
    }
    
    // 添加切换按钮事件监听器
    toggleBlurBtn.addEventListener('click', function() {
        const isCurrentlyEnabled = getCookie("blurEffect") === "true";
        const newEnabledState = !isCurrentlyEnabled;
        
        // 保存设置到Cookie
        setCookie("blurEffect", newEnabledState.toString(), 30);
        
        if (newEnabledState) {
            toggleBlurText.textContent = '关闭毛玻璃';
            // 应用模糊效果，使用保存的强度值
            const currentBlurValue = getCookie("blurStrength") || "10";
            applyBlurEffect(true, currentBlurValue);
        } else {
            toggleBlurText.textContent = '开启毛玻璃';
            applyBlurEffect(false);
        }
    });
    
    // 添加模糊度滑块事件监听器
    blurSlider.addEventListener('input', function() {
        const blurStrength = this.value;
        blurValue.textContent = blurStrength + 'px';
        
        // 保存设置到Cookie
        setCookie("blurStrength", blurStrength, 30);
        
        // 应用模糊效果（仅当效果已启用时）
        if (getCookie("blurEffect") === "true") {
            applyBlurEffect(true, blurStrength);
        }
    });
    
    // 添加背景上传事件监听器
    if (backgroundUpload) {
        backgroundUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // 验证文件类型
                if (!file.type.match('image.*')) {
                    alert('请选择图片文件');
                    return;
                }
                
                // 验证文件大小（不超过5MB）
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片大小不能超过5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    // 保存背景到Cookie
                    setCookie("customBackground", e.target.result, 30);
                    // 应用自定义背景
                    applyCustomBackground(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // 添加重置背景按钮事件监听器
    if (resetBackground) {
        resetBackground.addEventListener('click', function() {
            // 清除保存的背景
            setCookie("customBackground", "", 30);
            // 移除自定义背景
            removeCustomBackground();
        });
    }
}

// 应用模糊效果到指定元素
function applyBlurEffect(enabled, strength = "10") {
    // 更新CSS变量
    document.documentElement.style.setProperty('--blur-strength', strength + 'px');
    
    // 获取所有需要应用毛玻璃效果的元素
    const elements = document.querySelectorAll(
        '.card, header, .calculator, #musicPlayer, .resource-card, .knowledge-item, ' +
        '.setting-option, .tool-card, .calendar-card, .weather-card'
    );
    
    if (enabled) {
        // 为所有元素添加毛玻璃效果类
        elements.forEach(element => {
            // 添加毛玻璃效果类
            element.classList.add('blur-element');
        });
        
        // 添加全局样式
        updateBlurStyles(strength);
    } else {
        // 为所有元素移除毛玻璃效果类
        elements.forEach(element => {
            element.classList.remove('blur-element');
        });
        
        // 移除全局样式
        removeBlurStyles();
    }
}

// 更新模糊样式
function updateBlurStyles(strength) {
    // 获取或创建样式元素
    let style = document.getElementById('blur-effect-style');
    if (!style) {
        style = document.createElement('style');
        style.id = 'blur-effect-style';
        document.head.appendChild(style);
    }
    
    // 更新样式内容
    style.textContent = `
        .blur-element {
            background: rgba(255, 255, 255, 0.2) !important;
            backdrop-filter: blur(${strength}px) !important;
            -webkit-backdrop-filter: blur(${strength}px) !important;
            /* 保持原有布局属性 */
            border-radius: inherit !important;
        }
        
        .dark-mode .blur-element {
            background: rgba(30, 30, 40, 0.2) !important;
        }
        
        /* 确保应用毛玻璃效果的元素保持原有样式 */
    `;
}

// 移除模糊样式
function removeBlurStyles() {
    const style = document.getElementById('blur-effect-style');
    if (style) {
        style.remove();
    }
}

// 应用自定义背景
function applyCustomBackground(backgroundDataUrl) {
    document.body.style.backgroundImage = `url(${backgroundDataUrl})`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
    document.body.style.backgroundAttachment = 'fixed';
}

// 移除自定义背景
function removeCustomBackground() {
    document.body.style.backgroundImage = 'none';
}

// 更新服务器上的头像（这是一个示例函数，实际实现需要根据后端API调整）
async function updateAvatarOnServer(user, avatarBase64) {
    try {
        // 这里应该调用后端API来更新头像
        // 由于当前后端没有提供更新头像的API，我们只在本地更新
        console.log('头像已更新到本地存储');
    } catch (error) {
        console.error('更新头像失败:', error);
    }
}

// 显示错误信息
function hideError(elementId) {
    const errorElement = document.getElementById(elementId);
    if (errorElement) {
        errorElement.style.display = 'none';
    }
}

// Python编程环境展开/收起功能
document.addEventListener('DOMContentLoaded', function() {
    const pythonCard = document.getElementById('pythonCard');
    const scratchCard = document.getElementById('scratchCard');
    const multiLangCard = document.getElementById('multiLangCard');
    const pythonEditorCard = document.getElementById('pythonEditorCard');
    const closePythonEditor = document.getElementById('closePythonEditor');
    
    // 初始化状态
    if (pythonEditorCard) pythonEditorCard.style.display = 'none';
    if (scratchCard) scratchCard.style.display = 'block';
    if (multiLangCard) multiLangCard.style.display = 'block';
    
    // 点击Python卡片展开编辑器
    if (pythonCard) {
        pythonCard.addEventListener('click', function(e) {
            // 阻止默认的链接跳转行为
            e.preventDefault();
            
            // 隐藏其他卡片
            if (scratchCard) scratchCard.style.display = 'none';
            if (multiLangCard) multiLangCard.style.display = 'none';
            
            // 显示Python编辑器
            if (pythonEditorCard) pythonEditorCard.style.display = 'block';
        });
        
        // 也为Python卡片中的按钮添加事件监听器
        const pythonButton = pythonCard.querySelector('.tool-link');
        if (pythonButton) {
            pythonButton.addEventListener('click', function(e) {
                // 阻止默认的链接跳转行为
                e.preventDefault();
                e.stopPropagation();
                
                // 隐藏其他卡片
                if (scratchCard) scratchCard.style.display = 'none';
                if (multiLangCard) multiLangCard.style.display = 'none';
                
                // 显示Python编辑器
                if (pythonEditorCard) pythonEditorCard.style.display = 'block';
            });
        }
    }
    
    // 点击收起按钮
    if (closePythonEditor) {
        closePythonEditor.addEventListener('click', function() {
            // 隐藏Python编辑器
            if (pythonEditorCard) pythonEditorCard.style.display = 'none';
            
            // 显示其他卡片
            if (scratchCard) scratchCard.style.display = 'block';
            if (multiLangCard) multiLangCard.style.display = 'block';
        });
    }
    
    // 运行Python代码功能
    const runPythonCode = document.getElementById('runPythonCode');
    const clearPythonOutput = document.getElementById('clearPythonOutput');
    const pythonCode = document.getElementById('pythonCode');
    const pythonOutput = document.getElementById('pythonOutput');
    
    if (runPythonCode && pythonCode && pythonOutput) {
        runPythonCode.addEventListener('click', function() {
            const code = pythonCode.value;
            if (!code.trim()) {
                pythonOutput.textContent = "请输入Python代码";
                return;
            }
            
            pythonOutput.textContent = "正在执行Python代码...\n\n";
            
            // 使用Django后端执行Python代码
            fetch('http://localhost:8001/api/execute-python/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code: code })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    pythonOutput.textContent = data.output;
                } else {
                    pythonOutput.textContent = "执行错误: " + data.output;
                }
            })
            .catch(error => {
                // 如果Django后端不可用，回退到模拟执行
                console.error('Django后端执行失败，回退到模拟执行:', error);
                pythonOutput.textContent = "正在执行Python代码...\n\n";
                
                // 模拟执行过程
                setTimeout(() => {
                    try {
                        // 获取编辑器中所有print调用的参数
                        const printCalls = [];
                        const regex = /print\(([^)]+)\)/g;
                        let match;
                        
                        while ((match = regex.exec(code)) !== null) {
                            printCalls.push(match[1].trim());
                        }
                        
                        // 生成输出结果
                        let resultOutput = "";
                        if (printCalls.length > 0) {
                            printCalls.forEach((call, index) => {
                                // 生成示例输出，模仿废稿文件中的实现
                                let value = "";
                                if (call.includes('factorial')) {
                                    value = "5的阶乘是: 120";
                                } else if (call.includes('names')) {
                                    value = "名字列表: ['阮铭泽', '张三', '李四', '王五']";
                                } else if (call.includes('欢迎')) {
                                    value = "欢迎使用阮铭泽的Python编辑器";
                                } else if (call.startsWith('f"') || call.startsWith("f'") || 
                                    call.startsWith('"') || call.startsWith("'")) {
                                    // 字符串处理
                                    value = call.replace(/^f?["']|['"]$/g, '').replace(/\\n/g, '\n');
                                } else {
                                    // 尝试执行简单计算
                                    try {
                                        // 处理简单的数学表达式
                                        let expression = call.replace(/^f?["']|['"]$/g, '');
                                        // 如果是简单的数学表达式，尝试计算
                                        if (/^[0-9+\-*/(). ]+$/.test(expression)) {
                                            value = eval(expression).toString();
                                        } else {
                                            // 否则直接输出原始内容
                                            value = expression;
                                        }
                                    } catch (e) {
                                        value = call.replace(/^f?["']|['"]$/g, '').replace(/\\n/g, '\n');
                                    }
                                }
                                resultOutput += `>>> ${value}\n`;
                            });
                            pythonOutput.textContent = resultOutput;
                        } else {
                            pythonOutput.textContent = "代码执行成功（没有输出语句）";
                        }
                    } catch (error) {
                        pythonOutput.textContent = "执行错误: " + error.message;
                    }
                }, 1000);
            });
        });
    }
    
    if (clearPythonOutput && pythonOutput) {
        clearPythonOutput.addEventListener('click', function() {
            pythonOutput.textContent = "";
        });
    }
});

// 时钟功能
function updateClock() {
    // 获取时区设置
    const selectedTimezone = getCookie("selectedTimezone") || "Asia/Shanghai";
    
    // 创建对应时区的日期对象
    let now;
    try {
        // 使用Intl.DateTimeFormat来处理时区转换
        const formatter = new Intl.DateTimeFormat('zh-CN', {
            timeZone: selectedTimezone,
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            weekday: 'long'
        });
        
        // 获取格式化的时间字符串并解析
        const parts = formatter.formatToParts(new Date());
        const dateObj = {};
        parts.forEach(part => {
            if (part.type !== 'literal') {
                dateObj[part.type] = part.value;
            }
        });
        
        // 创建新的Date对象
        now = new Date(
            parseInt(dateObj.year),
            parseInt(dateObj.month) - 1, // 月份从0开始
            parseInt(dateObj.day),
            parseInt(dateObj.hour),
            parseInt(dateObj.minute),
            parseInt(dateObj.second)
        );
    } catch (e) {
        // 如果时区处理失败，使用本地时间
        console.log('时区处理失败，使用本地时间:', e);
        now = new Date();
    }
    
    // 获取时钟显示元素
    const clockElement = document.getElementById('mainClock');
    const dateElement = document.getElementById('clockDate');
    
    if (clockElement && dateElement) {
        // 获取时钟格式设置（默认只显示小时和分钟）
        const showSeconds = getCookie("clockShowSeconds") === "true";
        
        // 格式化时间
        let hours = now.getHours().toString().padStart(2, '0');
        let minutes = now.getMinutes().toString().padStart(2, '0');
        
        if (showSeconds) {
            let seconds = now.getSeconds().toString().padStart(2, '0');
            clockElement.textContent = `${hours}:${minutes}:${seconds}`;
        } else {
            clockElement.textContent = `${hours}:${minutes}`;
        }
        
        // 格式化日期
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        
        // 星期几
        const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
        const weekday = weekdays[now.getDay()];
        
        dateElement.textContent = `${year}年${month}月${day}日 ${weekday}`;
    }
}

// 初始化时钟
document.addEventListener('DOMContentLoaded', function() {
            // 页面加载完成后初始化AI聊天功能

    // 立即更新一次时钟
    updateClock();
    
    // 每秒更新时钟
    setInterval(updateClock, 1000);
    
    // 时钟秒显示切换功能
    const toggleSecondsBtn = document.getElementById('toggleSecondsBtn');
    const toggleSecondsText = document.getElementById('toggleSecondsText');
    
    if (toggleSecondsBtn && toggleSecondsText) {
        // 根据当前设置初始化按钮状态
        const showSeconds = getCookie("clockShowSeconds") === "true";
        if (showSeconds) {
            toggleSecondsText.textContent = '隐藏秒';
        } else {
            toggleSecondsText.textContent = '显示秒';
        }
        
        // 添加点击事件
        toggleSecondsBtn.addEventListener('click', function() {
            const currentShowSeconds = getCookie("clockShowSeconds") === "true";
            const newShowSeconds = !currentShowSeconds;
            
            // 保存设置到Cookie
            setCookie("clockShowSeconds", newShowSeconds.toString(), 30);
            
            // 更新按钮文本
            if (newShowSeconds) {
                toggleSecondsText.textContent = '隐藏秒';
            } else {
                toggleSecondsText.textContent = '显示秒';
            }
            
            // 立即更新时钟显示
            updateClock();
        });
    }});
    
    // 时区设置功能
    const autoTimezoneBtn = document.getElementById('autoTimezoneBtn');
    const timezoneSelect = document.getElementById('timezoneSelect');
    
    if (timezoneSelect) {
        // 根据保存的时区设置初始化选择器
        const savedTimezone = getCookie("selectedTimezone") || "Asia/Shanghai";
        timezoneSelect.value = savedTimezone;
        
        // 添加时区选择事件
        timezoneSelect.addEventListener('change', function() {
            const selectedTimezone = this.value;
            setCookie("selectedTimezone", selectedTimezone, 30);
            // 立即更新时钟显示
            updateClock();
        });
    }
    
    if (autoTimezoneBtn) {
        // 添加自动获取时区事件
        autoTimezoneBtn.addEventListener('click', function() {
            try {
                // 使用Intl.DateTimeFormat获取本地时区
                const localTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                // 如果时区选择器存在，设置为检测到的时区
                if (timezoneSelect) {
                    timezoneSelect.value = localTimezone;
                    setCookie("selectedTimezone", localTimezone, 30);
                    // 立即更新时钟显示
                    updateClock();
                    
                    // 显示成功消息
                    alert(`时区已自动设置为: ${localTimezone}`);
                }
            } catch (error) {
                console.log('自动获取时区失败:', error);
                // 如果自动获取失败，使用默认时区
                if (timezoneSelect) {
                    timezoneSelect.value = "Asia/Shanghai";
                    setCookie("selectedTimezone", "Asia/Shanghai", 30);
                    updateClock();
                }
                alert('无法自动获取时区，已使用默认时区(上海)');
            }
        });
    }
    
    // 显示逆向趣事函数
    window.showReverseStory = function(storyTitle) {
        const currentLang = getCookie("language") || "zh";
        let storyContent = "";
        
        switch(storyTitle) {
            case '游戏破解的故事':
                storyContent = currentLang === 'en' ? 
                    "Game cracking has a long history in the tech world. In the 1980s and 90s, crackers would spend countless hours reverse engineering games to remove copy protection. Some of the most interesting stories involve crackers who not only removed protection but also improved the games themselves, fixing bugs and adding features that the original developers missed. The demoscene community, which emerged from the cracking scene, created incredible audiovisual demonstrations that pushed hardware to its limits. These crackers were often motivated by technical challenge and the desire to share software freely, rather than financial gain."
                    :
                    "游戏破解在技术界有着悠久的历史。在1980年代和1990年代，破解者会花费无数小时逆向分析游戏以去除复制保护。一些最有趣的故事涉及那些不仅去除了保护，还改进了游戏本身的破解者，他们修复了原开发者遗漏的bug并添加了新功能。从破解场景中诞生的演示场景社区，创造了令人难以置信的视听演示，将硬件推向了极限。这些破解者往往是由技术挑战和自由分享软件的愿望驱动，而不是经济利益。";
                break;
            case '手机App逆向':
                storyContent = currentLang === 'en' ? 
                    "Mobile app reverse engineering has become increasingly popular with the rise of smartphones. One fascinating aspect is how security researchers use reverse engineering to find vulnerabilities in popular apps, helping developers fix security issues before they can be exploited. There have been cases where researchers discovered that popular apps were secretly collecting more user data than disclosed in their privacy policies. Reverse engineering has also been used to understand how apps implement encryption and to develop better security practices. The cat-and-mouse game between app developers trying to protect their code and researchers trying to understand it continues to evolve, leading to better security for everyone."
                    :
                    "随着智能手机的兴起，移动应用逆向工程变得越来越流行。一个引人入胜的方面是安全研究人员如何使用逆向工程来发现流行应用中的漏洞，帮助开发者在被利用之前修复安全问题。曾有研究人员发现一些流行应用秘密收集的用户数据超出了其隐私政策中披露的范围。逆向工程还被用来理解应用如何实现加密，并开发更好的安全实践。应用开发者试图保护其代码与研究人员试图理解代码之间的猫鼠游戏不断演变，为每个人带来了更好的安全性。";
                break;
            case '安全防护对抗':
                storyContent = currentLang === 'en' ? 
                    "The ongoing battle between software protection mechanisms and reverse engineers has produced some remarkable innovations. Software developers have created increasingly sophisticated anti-debugging techniques, virtual machines for code obfuscation, and hardware-based protection schemes. In response, reverse engineers have developed advanced tools and techniques to defeat these protections. One amusing example is the use of 'packers' that compress and encrypt executable files, only to be unpacked at runtime. The reverse engineering community has created 'unpackers' to defeat these protections. This technological arms race has led to fascinating developments in both offensive and defensive cybersecurity techniques."
                    :
                    "软件保护机制与逆向工程师之间的持续对抗产生了一些显著的创新。软件开发者创造了日益复杂的反调试技术、用于代码混淆的虚拟机和基于硬件的保护方案。作为回应，逆向工程师开发了先进的工具和技术来击败这些保护。一个有趣的例子是使用'打包器'来压缩和加密可执行文件，只在运行时解包。逆向工程社区创造了'解包器'来击败这些保护。这场技术军备竞赛推动了攻防网络安全技术的迷人发展。";
                break;
            default:
                storyContent = currentLang === 'en' ? 
                    "This is an interesting story about reverse engineering."
                    :
                    "这是一个关于逆向工程的有趣故事。";
        }
        
        alert(storyTitle + "\n\n" + storyContent);
    };
    
    // 添加窗口控制按钮事件监听
    const minimizeBtn = document.getElementById('minimize-btn');
    const maximizeBtn = document.getElementById('maximize-btn');
    const closeBtn = document.getElementById('close-btn');
    
    // 为窗口控制按钮添加事件监听器
    if (minimizeBtn) {
        minimizeBtn.addEventListener('click', () => {
            if (window.electronAPI) {
                window.electronAPI.minimizeWindow();
            } else {
                // 在非Electron环境中使用浏览器API
                if (window.outerWidth && window.outerHeight) {
                    // 这里可以添加浏览器环境下的最小化逻辑
                    alert('在浏览器环境中，最小化功能不可用');
                }
            }
        });
    }
    
    if (maximizeBtn) {
        maximizeBtn.addEventListener('click', () => {
            if (window.electronAPI) {
                window.electronAPI.maximizeWindow();
            } else {
                // 在非Electron环境中使用浏览器API
                if (!window.isMaximized) {
                    // 保存当前窗口状态
                    window.originalWidth = window.outerWidth;
                    window.originalHeight = window.outerHeight;
                    window.originalX = window.screenX;
                    window.originalY = window.screenY;
                    
                    // 最大化窗口
                    window.moveTo(0, 0);
                    window.resizeTo(screen.availWidth, screen.availHeight);
                    window.isMaximized = true;
                    
                    // 更新图标
                    const maximizeIcon = maximizeBtn.querySelector('i');
                    if (maximizeIcon) {
                        maximizeIcon.classList.remove('fa-window-maximize');
                        maximizeIcon.classList.add('fa-window-restore');
                    }
                } else {
                    // 恢复窗口
                    if (window.originalWidth && window.originalHeight) {
                        window.moveTo(window.originalX, window.originalY);
                        window.resizeTo(window.originalWidth, window.originalHeight);
                    }
                    window.isMaximized = false;
                    
                    // 更新图标
                    const maximizeIcon = maximizeBtn.querySelector('i');
                    if (maximizeIcon) {
                        maximizeIcon.classList.remove('fa-window-restore');
                        maximizeIcon.classList.add('fa-window-maximize');
                    }
                }
            }
        });
    }
    
    if (closeBtn) {
        closeBtn.addEventListener('click', () => {
            if (window.electronAPI) {
                window.electronAPI.closeWindow();
            } else {
                // 在非Electron环境中使用浏览器API
                if (confirm('您确定要关闭此页面吗？')) {
                    window.close();
                }
            }
        });
    }
    
    // 窗口最大化状态监听（仅在Electron环境中）
    if (window.electronAPI) {
        window.electronAPI.onWindowMaximized(() => {
            const maximizeIcon = maximizeBtn.querySelector('i');
            if (maximizeIcon) {
                maximizeIcon.classList.remove('fa-window-maximize');
                maximizeIcon.classList.add('fa-window-restore');
            }
        });
        
        window.electronAPI.onWindowUnmaximized(() => {
            const maximizeIcon = maximizeBtn.querySelector('i');
            if (maximizeIcon) {
                maximizeIcon.classList.remove('fa-window-restore');
                maximizeIcon.classList.add('fa-window-maximize');
            }
        });
    }

    if (toggleBtn && collapseBtn && basicInfo && detailedInfo) {
        toggleBtn.addEventListener('click', function() {
            basicInfo.style.display = 'none';
            detailedInfo.style.display = 'block';
        });
        
        collapseBtn.addEventListener('click', function() {
            detailedInfo.style.display = 'none';
            basicInfo.style.display = 'block';
        });
    }
    
    // 退出确认对话框相关功能
    const exitDialog = document.getElementById('exitDialog');
    const exitAppBtn = document.getElementById('exitAppBtn');
    const minimizeToTrayBtn = document.getElementById('minimizeToTrayBtn');
    const cancelExitBtn = document.getElementById('cancelExitBtn');
    const rememberExitChoice = document.getElementById('rememberExitChoice');
    const exitConfirmToggle = document.getElementById('exitConfirmToggle');
    const rememberExitChoiceToggle = document.getElementById('rememberExitChoiceToggle');
    const defaultExitAction = document.getElementById('defaultExitAction');
    
    // 从Cookie加载设置
    function loadExitSettings() {
        const confirmEnabled = getCookie("exitConfirmEnabled");
        const rememberChoice = getCookie("rememberExitChoice");
        const defaultAction = getCookie("defaultExitAction");
        
        if (confirmEnabled !== null) {
            exitConfirmToggle.checked = confirmEnabled === "true";
        }
        
        if (rememberChoice !== null) {
            rememberExitChoiceToggle.checked = rememberChoice === "true";
        }
        
        if (defaultAction) {
            defaultExitAction.value = defaultAction;
        }
    }
    
    // 保存设置到Cookie
    function saveExitSettings() {
        setCookie("exitConfirmEnabled", exitConfirmToggle.checked, 365);
        setCookie("rememberExitChoice", rememberExitChoiceToggle.checked, 365);
        setCookie("defaultExitAction", defaultExitAction.value, 365);
    }
    
    // 初始化退出设置
    loadExitSettings();
    
    // 监听设置变化
    exitConfirmToggle.addEventListener('change', saveExitSettings);
    rememberExitChoiceToggle.addEventListener('change', saveExitSettings);
    defaultExitAction.addEventListener('change', saveExitSettings);
    
    // 监听退出确认对话框按钮
    exitAppBtn.addEventListener('click', function() {
        // 如果用户选择记住选择
        if (rememberExitChoice.checked) {
            setCookie("rememberExitChoice", "true", 365);
            setCookie("defaultExitAction", "exit", 365);
        }
        
        // 关闭对话框
        exitDialog.style.display = 'none';
        
        // 完全退出应用
        window.electronAPI.closeWindow();
    });
    
    minimizeToTrayBtn.addEventListener('click', function() {
        // 如果用户选择记住选择
        if (rememberExitChoice.checked) {
            setCookie("rememberExitChoice", "true", 365);
            setCookie("defaultExitAction", "minimize", 365);
        }
        
        // 关闭对话框
        exitDialog.style.display = 'none';
        
        // 最小化到托盘
        window.electronAPI.minimizeWindow();
    });
    
    cancelExitBtn.addEventListener('click', function() {
        // 关闭对话框
        exitDialog.style.display = 'none';
    });
    
    // 监听来自主进程的显示退出对话框请求
    if (window.electronAPI) {
        window.electronAPI.onShowExitDialog(() => {
            // 检查是否启用了退出确认
            const confirmEnabled = getCookie("exitConfirmEnabled");
            const rememberChoice = getCookie("rememberExitChoice");
            const defaultAction = getCookie("defaultExitAction");
            
            // 如果禁用了退出确认或记住了选择，则直接执行默认操作
            if (confirmEnabled === "false" || rememberChoice === "true") {
                if (defaultAction === "minimize") {
                    window.electronAPI.minimizeWindow();
                } else {
                    window.electronAPI.closeWindow();
                }
                return;
            }
            
            // 显示退出确认对话框
            exitDialog.style.display = 'flex';
        });
    } else {
        // 在非Electron环境中隐藏退出确认相关元素
        if (exitDialog) {
            exitDialog.style.display = 'none';
        }
    }
    // AI聊天功能实现
    function initAIChat() {
        // 获取相关元素
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');
    const chatHistory = document.getElementById('chatHistory');
    const aiApiKey = document.getElementById('aiApiKey');
    const saveAiApiKey = document.getElementById('saveAiApiKey');
    const aiModelSelect = document.getElementById('aiModelSelect');
    const customModelContainer = document.getElementById('customModelContainer');
    const customModelName = document.getElementById('customModelName');
    
    // 从Cookie加载保存的设置
    const savedApiKey = getCookie('aiApiKey');
    const savedModel = getCookie('aiModel');
    const savedCustomModel = getCookie('customModelName');
    
    if (savedApiKey) {
        aiApiKey.value = savedApiKey;
    }
    
    if (savedModel) {
        aiModelSelect.value = savedModel;
        if (savedModel === 'custom') {
            customModelContainer.style.display = 'block';
        }
    }
    
    if (savedCustomModel) {
        customModelName.value = savedCustomModel;
    }
    
    // 模型选择变化事件
    aiModelSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            customModelContainer.style.display = 'block';
        } else {
            customModelContainer.style.display = 'none';
        }
    });
    
    // 保存API密钥
    saveAiApiKey.addEventListener('click', function() {
        const apiKey = aiApiKey.value.trim();
        const model = aiModelSelect.value;
        const customModel = customModelName.value.trim();
        
        if (apiKey) {
            setCookie('aiApiKey', apiKey, 365);
            setCookie('aiModel', model, 365);
            
            if (model === 'custom' && customModel) {
                setCookie('customModelName', customModel, 365);
            }
            
            alert('API密钥已保存！');
        } else {
            alert('请输入有效的API密钥！');
        }
    });
    
    // 发送消息功能
    function sendChatMessage() {
        const message = chatInput.value.trim();
        if (!message) return;
        
        // 添加用户消息到聊天历史
        addMessageToChat('user', message);
        
        // 清空输入框
        chatInput.value = '';
        
        // 模拟AI回复（实际应用中应调用AI API）
        simulateAIResponse(message);
    }
    
    // 添加消息到聊天历史
    function addMessageToChat(sender, message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        messageDiv.style.marginBottom = '15px';
        messageDiv.style.display = 'flex';
        messageDiv.style.alignItems = 'flex-start';
        messageDiv.style.gap = '10px';
        
        // 创建头像
        const avatarDiv = document.createElement('div');
        avatarDiv.style.width = '36px';
        avatarDiv.style.height = '36px';
        avatarDiv.style.borderRadius = '50%';
        avatarDiv.style.display = 'flex';
        avatarDiv.style.alignItems = 'center';
        avatarDiv.style.justifyContent = 'center';
        avatarDiv.style.color = 'white';
        avatarDiv.style.flexShrink = '0';
        
        if (sender === 'user') {
            avatarDiv.style.background = 'linear-gradient(135deg, #3a0ca3, #4361ee)';
            avatarDiv.innerHTML = '<i class="fas fa-user"></i>';
        } else {
            avatarDiv.style.background = 'linear-gradient(135deg, #4361ee, #3a0ca3)';
            avatarDiv.innerHTML = '<i class="fas fa-robot"></i>';
        }
        
        // 创建消息内容
        const contentDiv = document.createElement('div');
        contentDiv.style.background = 'white';
        contentDiv.style.padding = '12px 16px';
        contentDiv.style.borderRadius = '18px';
        contentDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
        contentDiv.style.maxWidth = '80%';
        
        if (sender === 'ai') {
            contentDiv.style.background = 'rgba(67, 97, 238, 0.1)';
        }
        
        const senderName = document.createElement('div');
        senderName.style.fontWeight = '600';
        senderName.style.marginBottom = '5px';
        senderName.style.color = 'var(--primary-color)';
        senderName.textContent = sender === 'user' ? '您' : 'AI助手';
        
        const messageText = document.createElement('div');
        messageText.textContent = message;
        messageText.style.color = 'var(--text-dark)'; // 确保消息文本颜色正确
        
        // 在深色模式下，确保消息文本颜色可见
        if (document.body.classList.contains('dark-mode')) {
            messageText.style.color = 'var(--text-light)';
            // 确保内容区域背景色正确
            if (sender === 'ai') {
                contentDiv.style.background = 'rgba(94, 114, 228, 0.2)';
            } else {
                contentDiv.style.background = '#2a2a4a';
            }
        }
        
        contentDiv.appendChild(senderName);
        contentDiv.appendChild(messageText);
        
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);
        
        chatHistory.appendChild(messageDiv);
        
        // 滚动到最新消息
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }
    
    // 模拟AI回复
    function simulateAIResponse(userMessage) {
        // 显示"正在输入"效果
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'message ai-message';
        typingIndicator.style.marginBottom = '15px';
        typingIndicator.style.display = 'flex';
        typingIndicator.style.alignItems = 'flex-start';
        typingIndicator.style.gap = '10px';
        typingIndicator.id = 'typingIndicator';
        
        const avatarDiv = document.createElement('div');
        avatarDiv.style.width = '36px';
        avatarDiv.style.height = '36px';
        avatarDiv.style.borderRadius = '50%';
        avatarDiv.style.background = 'linear-gradient(135deg, #4361ee, #3a0ca3)';
        avatarDiv.style.display = 'flex';
        avatarDiv.style.alignItems = 'center';
        avatarDiv.style.justifyContent = 'center';
        avatarDiv.style.color = 'white';
        avatarDiv.style.flexShrink = '0';
        avatarDiv.innerHTML = '<i class="fas fa-robot"></i>';
        
        const contentDiv = document.createElement('div');
        contentDiv.style.background = 'rgba(67, 97, 238, 0.1)';
        contentDiv.style.padding = '12px 16px';
        contentDiv.style.borderRadius = '18px';
        contentDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
        contentDiv.style.maxWidth = '80%';
        
        // 深色模式下调整背景色
        if (document.body.classList.contains('dark-mode')) {
            contentDiv.style.background = 'rgba(94, 114, 228, 0.2)';
        }
        
        const senderName = document.createElement('div');
        senderName.style.fontWeight = '600';
        senderName.style.marginBottom = '5px';
        senderName.style.color = 'var(--primary-color)';
        senderName.textContent = 'AI助手';
        
        const typingDots = document.createElement('div');
        typingDots.textContent = '正在输入';
        typingDots.style.opacity = '0.7';
        
        // 深色模式下调整文本颜色
        if (document.body.classList.contains('dark-mode')) {
            senderName.style.color = '#7c8cfa';
            typingDots.style.color = '#f0f2f5';
        }
        
        contentDiv.appendChild(senderName);
        contentDiv.appendChild(typingDots);
        
        typingIndicator.appendChild(avatarDiv);
        typingIndicator.appendChild(contentDiv);
        
        chatHistory.appendChild(typingIndicator);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        
        // 模拟AI思考时间
        setTimeout(() => {
            // 移除"正在输入"指示器
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            
            // 生成模拟回复
            let response = '';
            if (userMessage.includes('你好') || userMessage.includes('hello')) {
                response = '您好！很高兴为您服务。有什么我可以帮助您的吗？';
            } else if (userMessage.includes('天气')) {
                response = '我是一个AI助手，无法直接获取实时天气信息。建议您查看工具箱主页的天气预报功能。';
            } else if (userMessage.includes('编程') || userMessage.includes('代码')) {
                response = '我是阮铭泽工具箱的AI助手。如果您需要编程帮助，可以使用我们的在线编程环境，支持Scratch、Python等多种语言。';
            } else {
                response = '感谢您的消息！我是阮铭泽工具箱的AI助手。如果您有任何问题，我会尽力帮助您。';
            }
            
            // 添加AI回复到聊天历史
            addMessageToChat('ai', response);
        }, 1500);
    }
    
    // 发送按钮点击事件
    sendChatBtn.addEventListener('click', sendChatMessage);
    
    // 回车发送消息（Shift+Enter换行）
    chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
        }
    });
}


</script>
</body>
</html>